---
description: 流程自优化规则。每次任务执行完成后自动触发，评估并优化 .codebuddy 配置。
globs:
alwaysApply: true
---

# 流程自优化规则

## 核心原则

> **每次任务完成后，自动复盘执行过程，识别摩擦点并优化 .codebuddy 配置。**

## 触发时机

- 任务/命令执行完成后（无论成功/失败）
- 检测到配置冲突时
- 用户显式请求 `/optimize` 时

## 自优化检查清单

### 1. 路径一致性检查

- [ ] 所有 `doc/` 引用已改为 `docs/`
- [ ] 所有文件路径指向实际存在的文件
- [ ] API 文档命名符合 `{module}-api.md` 规范

### 2. 规则冲突检查

- [ ] 无相互矛盾的行为指令（如"禁止确认"与"需要确认"同时存在）
- [ ] 工具调用方式统一（write_to_file vs execute_command）
- [ ] 确认点策略一致（唯一确认点）

### 3. 入口文档同步检查

- [ ] README.md 的 Commands/Agents/Rules 清单与实际文件一致
- [ ] Skills 清单与实际目录一致

### 4. 流程完整性检查

- [ ] 每个 Command 都有对应的执行逻辑
- [ ] 每个 Agent 调用的 Skill 都存在
- [ ] 每个 Rule 的 alwaysApply 设置正确

## 自动修正范围

以下问题 **自动修正**，无需用户确认：

| 问题类型 | 修正动作 |
|---------|---------|
| 路径错误（如 `doc/` → `docs/`） | 全局替换 |
| 过时文件引用 | 更新为正确路径 |
| README 清单过期 | 自动同步 |
| 缺失 `docs/archive/` 目录 | 自动创建 |

## 需用户确认的变更

以下变更 **需用户确认**：

- 删除现有 Agent/Skill/Command
- 新增 Rule/Command
- 修改确认点策略
- 重构 Skill 核心逻辑

## 优化日志

每次优化后，记录到 `.codebuddy/logs/optimize-{timestamp}.md`：

```markdown
# 流程优化日志

**时间：** {timestamp}
**触发原因：** {任务完成/检测到冲突/用户请求}

## 检测到的问题

1. {问题1描述}
2. {问题2描述}

## 已自动修正

- [x] {修正1}
- [x] {修正2}

## 待用户确认

- [ ] {需确认的变更1}
- [ ] {需确认的变更2}

## 优化建议

- {建议1}
- {建议2}
```

## 执行流程

```
任务完成
    ↓
[1] 路径一致性检查 → 自动修正
    ↓
[2] 规则冲突检查 → 标记问题
    ↓
[3] 入口文档同步 → 自动修正 README
    ↓
[4] 流程完整性检查 → 标记问题
    ↓
[5] 生成优化日志 → .codebuddy/logs/optimize-{timestamp}.md
    ↓
[6] 如有需确认变更 → 提示用户
```

## 优化频率控制

- 同一会话内最多触发 1 次自动优化
- 连续优化间隔 ≥ 10 分钟
- 可通过 `--skip-optimize` 跳过

## 手动触发

```
/optimize                    # 立即触发流程优化
/optimize --check-only       # 仅检查，不修正
/optimize --force            # 强制优化（忽略频率控制）
```
