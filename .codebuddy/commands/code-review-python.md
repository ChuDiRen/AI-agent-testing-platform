---
allowed-tools: Read, Bash, Grep, Glob
argument-hint: [file-path] | [commit-hash] | --full
description: 全面的代码质量审查，包括安全性、性能和架构分析
---

# 代码质量审查

执行全面的代码质量审查: $ARGUMENTS

## 当前状态

- Git 状态: !git status --porcelain
- 最近变更: !git diff --stat HEAD~5
- 仓库信息: !git log --oneline -5
- 代码检查: !flake8 . --count --select=E9,F63,F7,F82 --show-source 2>&1 | head -5 || echo "代码检查失败"
- 类型检查: !mypy . --ignore-missing-imports 2>&1 | head -5 || echo "类型检查失败"

## 任务

按照以下步骤进行全面的代码审查：

1. **仓库分析**
   - 审查README和文档以了解上下文

2. **架构与设计**
   - 审查 API 设计和路由结构
   - 评估代码组织和关注点分离
   - 检查抽象和模块化是否恰当
   - 审查依赖管理和耦合度
   - 检查 FastAPI 服务分层架构（routes/services/repositories）
   - 检查中间件和依赖注入的使用是否合理
   - 评估可扩展性和可维护性

3. **代码质量评估**
   - 扫描代码异味、反模式和潜在 bug
   - 检查是否遵循 PEP 8 编码规范（black、flake8）
   - 识别未使用的导入、变量或死代码
   - 审查错误处理模式（是否正确使用异常处理）
   - 检查是否正确使用类型注解（mypy 验证）
   - 审查日志记录实践（是否使用结构化日志）

4. **安全审查**
   - 查找常见安全漏洞（SQL 注入、XSS 等）
   - 检查硬编码的密钥、API 密钥或密码
   - 审查认证和授权逻辑（JWT、OAuth2）
   - 检查输入验证和清理（Pydantic 模型验证）
   - 检查敏感数据是否正确处理（加密、脱敏）
   - 审查依赖包安全漏洞（safety、pip-audit）

5. **性能分析**
   - 识别潜在的性能瓶颈
   - 检查低效的算法或数据库查询（N+1 查询）
   - 审查内存使用模式和潜在泄漏
   - 检查异步代码的正确性（async/await）
   - 分析 API 调用的超时和重试策略
   - 审查数据库连接池和资源复用
   - 检查是否正确使用缓存（Redis）

6. **测试覆盖率**
   - 检查现有测试覆盖率和质量（pytest --cov）
   - 识别缺乏适当测试的区域
   - 审查测试结构和组织（单元测试、集成测试）
   - 建议额外的测试场景
   - 检查是否使用参数化测试
   - 审查 fixture 和 mock 的使用

7. **数据库操作审查**
   - 检查 ORM 使用规范（SQLAlchemy）
   - 审查查询优化和索引使用
   - 检查事务管理和回滚机制
   - 审查数据库迁移脚本（Alembic）
   - 检查 SQL 注入风险

8. **文档审查**
   - 评估代码注释和 docstring
   - 检查 API 文档完整性
   - 审查 README 和设置说明
   - 识别需要更好文档的区域
   - 检查 Pydantic 模型的文档
   - 审查 FastAPI 路由的文档

9. **FastAPI 特定审查**
   - 审查路由组织和版本控制
   - 检查依赖注入的使用
   - 审查中间件配置和执行顺序

10. **建议**
    - 按严重程度对问题进行优先级排序（严重、高、中、低）
    - 提供具体、可操作的建议
    - 推荐改进工具和实践（如 black、flake8、mypy、bandit）
    - 创建包含后续步骤的摘要报告

记住要建设性地提供反馈，并在适用时提供具体示例，包括文件路径和行号。
