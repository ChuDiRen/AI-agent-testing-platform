---
allowed-tools: Read, Bash, Grep, Glob
argument-hint: [file-path] | [commit-hash] | --full
description: 全面的代码质量审查，包括安全性、性能和架构分析
---

# 代码质量审查

执行全面的代码质量审查: $ARGUMENTS

## 当前状态

- Git 状态: !git status --porcelain
- 最近变更: !git diff --stat HEAD~5
- 仓库信息: !git log --oneline -5
- 构建状态: !go build -v ./... 2>&1 | head -5 || echo "构建检查失败"

## 任务

按照以下步骤进行全面的代码审查：

1. **仓库分析**
   - 审查README和文档以了解上下文

2. **架构与设计**
   - 审查接口设计和 protobuf 定义
   - 评估代码组织和关注点分离
   - 检查抽象和模块化是否恰当
   - 审查依赖管理和耦合度
   - 检查 tRPC-Go 服务分层架构（service, logic, repository）
   - 检查插件和中间件的使用是否合理
   - 评估可扩展性和可维护性

3. **代码质量评估**
   - 扫描代码异味、反模式和潜在 bug
   - 检查是否遵循 Golang 编码规范（gofmt, golint）
   - 识别未使用的导入、变量或死代码
   - 审查错误处理模式（是否正确使用 error 返回值）
   - 检查是否正确使用 context.Context
   - 审查日志记录实践（是否使用结构化日志）

4. **安全审查**
   - 查找常见安全漏洞（SQL 注入、XSS 等）
   - 检查硬编码的密钥、API 密钥或密码
   - 审查认证和授权逻辑
   - 检查输入验证和清理
   - 检查敏感数据是否正确处理（加密、脱敏）

5. **性能分析**
   - 识别潜在的性能瓶颈
   - 检查低效的算法或数据库查询
   - 审查内存使用模式和潜在泄漏
   - 检查 goroutine 泄漏风险
   - 分析 RPC 调用的超时和重试策略
   - 审查连接池和资源复用
   - 检查是否正确使用 sync.Pool、对象复用等优化

6. **测试覆盖率**
   - 检查现有测试覆盖率和质量
   - 识别缺乏适当测试的区域
   - 审查测试结构和组织（单元测试、集成测试）
   - 建议额外的测试场景
   - 检查是否使用 table-driven tests
   - 审查 mock 和 stub 的使用

7. **文档审查**
   - 评估代码注释和内联文档
   - 检查 API 文档完整性
   - 审查 README 和设置说明
   - 识别需要更好文档的区域
   - 检查 protobuf 文件的注释
   - 审查 tRPC 服务接口文档

8. **tRPC-Go 特定审查**
   - 审查服务注册和发现配置
   - 检查协议选择和序列化方式
   - 审查命名服务和负载均衡策略

9. **建议**
   - 按严重程度对问题进行优先级排序（严重、高、中、低）
   - 提供具体、可操作的建议
   - 推荐改进工具和实践（如 golangci-lint, staticcheck）
   - 创建包含后续步骤的摘要报告

记住要建设性地提供反馈，并在适用时提供具体示例，包括文件路径和行号。