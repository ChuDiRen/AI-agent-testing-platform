# 后端开发通用规范 Skill

## 概述
本 Skill 提供技术栈无关的后端开发规范和最佳实践，适用于任何后端框架（FastAPI、SpringBoot、Express、Go 等）。

## 分层架构规范

### 架构总览
```
┌─────────────────────────────────────────────────────────────┐
│                      API / Router 层                         │
│  职责：请求处理、参数校验、响应封装                            │
│  禁止：编写业务逻辑                                           │
├─────────────────────────────────────────────────────────────┤
│                      Service 层                              │
│  职责：业务逻辑、数据验证、权限控制、事务协调                   │
│  禁止：直接操作数据库                                         │
├─────────────────────────────────────────────────────────────┤
│                   Repository / DAO 层                        │
│  职责：数据访问、缓存操作、数据持久化                          │
│  禁止：编写业务逻辑                                           │
├─────────────────────────────────────────────────────────────┤
│                     Model / Entity 层                        │
│  职责：数据模型定义、字段映射                                  │
└─────────────────────────────────────────────────────────────┘
```

### API 层规范

**职责边界**: 仅负责请求处理和响应，**禁止编写业务逻辑**

**标准职责**:
- 接收请求参数
- 参数校验
- 调用 Service 层
- 封装响应结果
- 异常处理

**路径规范**:
- 管理接口: `/api/v1/admin/`
- 用户接口: `/api/v1/users/`
- 公共接口: `/api/v1/public/`

### Service 层规范

**职责**:
- 业务逻辑实现
- 数据验证
- 权限控制
- 事务协调
- 日志记录

**调用规范**: 
- Service 层通过 Repository 访问数据
- 禁止直接操作数据库或 ORM

### Repository 层规范

**职责**:
- 封装数据库访问
- 提供数据持久化抽象
- 缓存操作

**设计原则**:
- 一个领域聚合一个 Repository
- 跨表写操作必须使用事务
- 创建操作时必须明确赋值每个字段

---

## 统一响应格式

### 标准响应结构
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {}
}
```

### 分页响应结构
```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "items": [],
    "total": 100,
    "page": 1,
    "pageSize": 10
  }
}
```

### 错误响应结构
```json
{
  "code": 400,
  "message": "参数错误",
  "data": null
}
```

---

## 异常处理规范

### 异常分类
| 异常类型 | 说明 | HTTP 状态码 |
|---------|------|------------|
| BusinessException | 业务逻辑异常 | 400 |
| ValidationException | 参数验证异常 | 400 |
| AuthenticationException | 认证异常 | 401 |
| AuthorizationException | 授权异常 | 403 |
| NotFoundException | 资源不存在 | 404 |
| ServiceException | 服务内部异常 | 500 |

### 异常处理原则
1. 所有异常 catch 必须记录详细日志
2. 使用统一异常处理器处理异常
3. 事务函数中避免捕获异常（让事务回滚）
4. 返回给前端的错误信息要友好

---

## 日志规范

### 日志级别
| 级别 | 使用场景 |
|-----|---------|
| DEBUG | 开发调试信息 |
| INFO | 业务流程关键节点 |
| WARN | 警告信息，不影响业务 |
| ERROR | 错误信息，需要关注 |

### 日志内容要求
```
[时间] [级别] [模块] [操作] [参数] [结果]
```

示例:
```
2025-01-21 10:00:00 INFO UserService 创建用户 username=admin 成功
2025-01-21 10:00:01 ERROR UserService 创建用户失败 username=test 错误：用户名已存在
```

---

## 数据库规范

### 表设计规范
- 表名使用下划线命名（snake_case）
- 必须包含 `created_at` 和 `updated_at` 字段
- 推荐包含 `created_by` 和 `updated_by` 字段
- 使用软删除（`is_deleted` 或 `deleted_at`）
- 外键关系需要明确定义

### 索引规范
- 主键必须有索引
- 外键字段建议加索引
- 常用查询条件字段加索引
- 避免过多索引影响写入性能

### 金额处理
- 数据库存储：分为单位（Integer）
- 前端展示：元为单位
- **严禁**: 使用 float 和 double 进行金额计算

---

## 安全规范

### 认证与授权
- 使用 JWT 或 Session 进行认证
- Token 设置合理的过期时间
- 敏感操作需要二次验证
- 权限控制粒度到接口级别

### 数据安全
- 密码必须加密存储（BCrypt 推荐）
- 敏感数据脱敏展示
- SQL 注入防护
- XSS 攻击防护

### 接口安全
- 接口限流
- 防止暴力破解
- 参数校验
- 请求签名（敏感接口）

---

## 性能优化

### 数据库优化
```
❌ 错误示例 - 循环查询
for id in ids:
    item = repository.get_by_id(id)
    results.append(item)

✅ 正确写法 - 批量查询
items = repository.get_by_ids(ids)
```

### 缓存策略
- 避免在事务中进行缓存操作
- 合理设置缓存过期时间
- 及时清理无效缓存
- 使用缓存穿透、击穿、雪崩防护

### 接口优化
- 分页查询限制最大条数
- 大数据量导出使用异步
- 复杂查询考虑读写分离

---

## 代码规范

### 命名规范
| 类型 | 规范 | 示例 |
|-----|------|-----|
| 类名 | PascalCase | UserService |
| 方法名 | camelCase / snake_case | getUserById / get_user_by_id |
| 变量名 | camelCase / snake_case | userId / user_id |
| 常量 | UPPER_SNAKE_CASE | MAX_PAGE_SIZE |

### 注释规范
- 类注释：说明类的职责
- 方法注释：说明方法的功能、参数、返回值
- 关键逻辑注释：说明复杂业务逻辑

### 代码质量
- 方法行数不超过 100 行
- 类行数不超过 500 行
- 单一职责原则
- 避免重复代码

---

## 严格禁止事项

1. **禁止在 API 层编写业务逻辑**
2. **禁止在 Service 层直接操作数据库**
3. **禁止在循环中查询数据库**
4. **禁止硬编码配置信息**
5. **禁止使用 float/double 计算金额**
6. **禁止忽略异常不处理**
7. **禁止在事务中进行外部调用**

---

## 代码生成前检查

**强制要求**: 在生成任何业务代码之前，必须先检查是否已有相关的业务服务或功能。

检查清单:
- [ ] 已查看现有 Service 层
- [ ] 已查看现有 Repository 层
- [ ] 已查看现有 Model 层
- [ ] 已查看现有 Utils 层
- [ ] 已确认没有重复或类似的现有功能
