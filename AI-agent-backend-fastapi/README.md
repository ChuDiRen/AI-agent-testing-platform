# FastAPI RBAC æƒé™ç®¡ç†ç³»ç»Ÿ

åŸºäº RBACï¼ˆRole-Based Access Controlï¼‰æƒé™æ¨¡å‹çš„ FastAPI åç«¯ç³»ç»Ÿã€‚

**å‚è€ƒè®¾è®¡**: [RBACè¡¨ç»“æ„è®¾è®¡ - BNTang](https://www.cnblogs.com/BNTang/articles/17024549.html)

---

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### ğŸ” RBAC æƒé™æ¨¡å‹
- **ä¸‰å±‚æ¶æ„**: ç”¨æˆ· â†’ è§’è‰² â†’ èœå•ï¼ˆæƒé™ï¼‰
- **å¤šå¯¹å¤šå…³ç³»**: ç”¨æˆ·-è§’è‰²ã€è§’è‰²-èœå•å®Œæ•´å®ç°
- **æƒé™æ ‡è¯†**: è§„èŒƒçš„ `èµ„æº:æ“ä½œ` æ ¼å¼ï¼ˆå¦‚ `user:view`ï¼‰
- **èœå•æ ‘ç»“æ„**: æ”¯æŒå¤šçº§èœå•å’ŒæŒ‰é’®æƒé™

### ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½
- âœ… **ç”¨æˆ·ç®¡ç†**: æ³¨å†Œã€ç™»å½•ã€CRUDã€åˆ†é¡µæœç´¢ã€æ•°æ®å¯¼å‡º
- âœ… **è§’è‰²ç®¡ç†**: è§’è‰² CRUDã€è§’è‰²æƒé™åˆ†é…
- âœ… **èœå•ç®¡ç†**: èœå•/æŒ‰é’® CRUDã€æ ‘å½¢ç»“æ„ã€ç”¨æˆ·èœå•æŸ¥è¯¢
- âœ… **éƒ¨é—¨ç®¡ç†**: éƒ¨é—¨ CRUDã€æ ‘å½¢ç»“æ„
- âœ… **æƒé™å…³è”**: ç”¨æˆ·-è§’è‰²ã€è§’è‰²-èœå•çµæ´»é…ç½®
- âœ… **æ–‡ä»¶ä¸Šä¼ **: å¤´åƒã€æ–‡ä»¶ä¸Šä¼ ç®¡ç†
- âœ… **JWT è®¤è¯**: å®‰å…¨çš„ Token è®¤è¯æœºåˆ¶
- âœ… **è¯·æ±‚æ—¥å¿—**: å®Œæ•´çš„è¯·æ±‚æ—¥å¿—è®°å½•
- âœ… **API é™æµ**: é˜²æ­¢æ¥å£æ»¥ç”¨

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

å®Œå…¨æŒ‰ç…§åšå®¢ [RBACè¡¨ç»“æ„è®¾è®¡](https://www.cnblogs.com/BNTang/articles/17024549.html) å®ç°ï¼š

### æ ¸å¿ƒè¡¨ç»“æ„

| è¡¨å | è¯´æ˜ | å­—æ®µæ•° |
|-----|------|--------|
| t_user | ç”¨æˆ·è¡¨ | 13 |
| t_role | è§’è‰²è¡¨ | 5 |
| t_menu | èœå•è¡¨ï¼ˆæƒé™è¡¨ï¼‰ | 11 |
| t_user_role | ç”¨æˆ·è§’è‰²å…³è”è¡¨ | 2 |
| t_role_menu | è§’è‰²èœå•å…³è”è¡¨ | 2 |
| t_dept | éƒ¨é—¨è¡¨ | 6 |

### RBAC æƒé™æµç¨‹

```
ç”¨æˆ·ç™»å½• â†’ æŸ¥è¯¢ç”¨æˆ·è§’è‰²(t_user_role) â†’ æŸ¥è¯¢è§’è‰²èœå•(t_role_menu) â†’ è·å–èœå•æƒé™(t_menu.perms)
```

ä»¥ç”¨æˆ· **BNTang** ä¸ºä¾‹ï¼š
1. ä» `t_user` è·å– user_id=1
2. ä» `t_user_role` è·å– role_id=1ï¼ˆç®¡ç†å‘˜ï¼‰
3. ä» `t_role_menu` è·å– menu_id åˆ—è¡¨
4. ä» `t_menu` è·å–æƒé™æ ‡è¯†ï¼ˆå¦‚ `user:view`, `user:add`ï¼‰

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. åˆå§‹åŒ–æ•°æ®åº“

```bash
python init_data.py
```

åˆå§‹åŒ–æ•°æ®ï¼ˆå®Œå…¨å¯¹åº”åšå®¢ï¼‰ï¼š
- âœ… ç”¨æˆ·: BNTangï¼ˆå¯†ç : 1234qwerï¼‰
- âœ… è§’è‰²: ç®¡ç†å‘˜
- âœ… éƒ¨é—¨: å¼€å‘éƒ¨
- âœ… èœå•: 5ä¸ªï¼ˆç³»ç»Ÿç®¡ç†ã€ç”¨æˆ·ç®¡ç†åŠç›¸å…³æŒ‰é’®ï¼‰

### 3. å¯åŠ¨æœåŠ¡

```bash
python run.py
```

è®¿é—®åœ°å€ï¼š
- **API æ–‡æ¡£ (Swagger)**: http://localhost:8000/docs
- **API æ–‡æ¡£ (ReDoc)**: http://localhost:8000/redoc
- **å¥åº·æ£€æŸ¥**: http://localhost:8000/health

### 4. æµ‹è¯•ç™»å½•

**æµ‹è¯•è´¦å·**ï¼ˆæ¥è‡ªåšå®¢æ•°æ®ï¼‰:
- ç”¨æˆ·å: `BNTang`
- å¯†ç : `1234qwer`

---

## ğŸ“š API æ¥å£

### æ¥å£æ€»è§ˆï¼ˆ60+ ä¸ªæ¥å£ï¼‰

| æ¨¡å— | æ¥å£æ•° | è¯´æ˜ |
|-----|--------|------|
| è®¤è¯ | 2 | æ³¨å†Œã€ç™»å½• |
| ç”¨æˆ·ç®¡ç† | 7 | CRUDã€åˆ†é¡µã€å¯¼å‡º |
| è§’è‰²ç®¡ç† | 5 | å®Œæ•´ CRUD |
| èœå•ç®¡ç† | 7 | CRUDã€æ ‘ç»“æ„ã€ç”¨æˆ·èœå• |
| éƒ¨é—¨ç®¡ç† | 5 | å®Œæ•´ CRUD |
| ç”¨æˆ·è§’è‰²å…³è” | 3 | åˆ†é…ã€æŸ¥è¯¢ã€ç§»é™¤ |
| è§’è‰²èœå•å…³è” | 3 | åˆ†é…ã€æŸ¥è¯¢ã€ç§»é™¤ |
| æ–‡ä»¶ä¸Šä¼  | 3 | å¤´åƒã€æ–‡ä»¶ä¸Šä¼ åˆ é™¤ |
| æµ‹è¯•ç”¨ä¾‹ | 6 | CRUDã€æ‰§è¡Œã€ç»Ÿè®¡ |
| æµ‹è¯•æŠ¥å‘Š | 8 | CRUDã€ç”Ÿæˆã€å¯¼å‡ºã€ç»Ÿè®¡ |
| AIåŠ©æ‰‹ | 9 | èŠå¤©ã€ä¼šè¯ç®¡ç†ã€ç”¨ä¾‹ç”Ÿæˆ |
| æ¶ˆæ¯é€šçŸ¥ | 5 | CRUDã€æ ‡è®°å·²è¯» |
| æ•°æ®ç®¡ç† | 5 | å¤‡ä»½ã€æ¢å¤ã€æ¸…ç†ã€ä¼˜åŒ– |

### æ ¸å¿ƒæ¥å£ç¤ºä¾‹

**1. ç”¨æˆ·ç™»å½•**
```bash
POST /api/v1/auth/login
{
  "username": "BNTang",
  "password": "1234qwer"
}
```

**2. è·å–èœå•æ ‘**
```bash
GET /api/v1/menus/tree
Authorization: Bearer {token}
```

**3. åˆ›å»ºæµ‹è¯•ç”¨ä¾‹**
```bash
POST /api/v1/testcases/
{
  "name": "ç™»å½•åŠŸèƒ½æµ‹è¯•",
  "test_type": "API",
  "module": "ç”¨æˆ·æ¨¡å—",
  "priority": "P1"
}
```

**4. æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹**
```bash
POST /api/v1/testcases/{testcase_id}/execute
{
  "environment": "test",
  "config": {"timeout": 30}
}
```

**5. ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š**
```bash
POST /api/v1/reports/generate
{
  "name": "APIæµ‹è¯•æŠ¥å‘Š",
  "testcase_ids": [1, 2, 3],
  "environment": "test"
}
```

**6. AIèŠå¤©**
```bash
POST /api/v1/ai/chat
{
  "message": "å¸®æˆ‘ç”Ÿæˆç™»å½•åŠŸèƒ½çš„æµ‹è¯•ç”¨ä¾‹",
  "model": "gpt-3.5-turbo"
}
```

**7. AIç”Ÿæˆæµ‹è¯•ç”¨ä¾‹**
```bash
POST /api/v1/ai/generate-testcases
{
  "requirement": "ç”¨æˆ·ç™»å½•åŠŸèƒ½",
  "test_type": "API",
  "count": 5
}
```

å®Œæ•´çš„ API æ–‡æ¡£è¯·æŸ¥çœ‹ï¼š[APIæ¥å£æ–‡æ¡£.md](APIæ¥å£æ–‡æ¡£.md)

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
AI-agent-frontend-fastapi/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/                    # API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ auth.py            # è®¤è¯æ¥å£
â”‚   â”‚   â”œâ”€â”€ users.py           # ç”¨æˆ·ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ roles.py           # è§’è‰²ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ menus.py           # èœå•ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ departments.py     # éƒ¨é—¨ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ user_roles.py      # ç”¨æˆ·è§’è‰²å…³è”
â”‚   â”‚   â””â”€â”€ role_menus.py      # è§’è‰²èœå•å…³è”
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                 # æ•°æ®åº“æ¨¡å‹ï¼ˆå¯¹åº”åšå®¢è¡¨ç»“æ„ï¼‰
â”‚   â”‚   â”œâ”€â”€ user.py            # t_user ç”¨æˆ·è¡¨
â”‚   â”‚   â”œâ”€â”€ role.py            # t_role è§’è‰²è¡¨
â”‚   â”‚   â”œâ”€â”€ menu.py            # t_menu èœå•è¡¨
â”‚   â”‚   â”œâ”€â”€ department.py      # t_dept éƒ¨é—¨è¡¨
â”‚   â”‚   â”œâ”€â”€ user_role.py       # t_user_role å…³è”è¡¨
â”‚   â”‚   â””â”€â”€ role_menu.py       # t_role_menu å…³è”è¡¨
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/                # Pydantic æ•°æ®éªŒè¯
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ repositories/           # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ middleware/             # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒé…ç½®
â”‚   â””â”€â”€ main.py                 # åº”ç”¨å…¥å£
â”‚
â”œâ”€â”€ init_data.py               # æ•°æ®åˆå§‹åŒ–ï¼ˆåšå®¢æ•°æ®ï¼‰
â”œâ”€â”€ run.py                     # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ requirements.txt           # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ APIæ¥å£æ–‡æ¡£.md              # å®Œæ•´ API æ–‡æ¡£
â””â”€â”€ README.md                  # æœ¬æ–‡ä»¶
```

---

## ğŸ“¦ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | è¯´æ˜ |
|-----|------|------|
| FastAPI | 0.104.1 | é«˜æ€§èƒ½ Web æ¡†æ¶ |
| SQLAlchemy | 2.0.23 | å¼‚æ­¥ ORM |
| Pydantic | 2.5.0 | æ•°æ®éªŒè¯ |
| Uvicorn | 0.24.0 | ASGI æœåŠ¡å™¨ |
| Passlib | 1.7.4 | å¯†ç åŠ å¯†ï¼ˆBCryptï¼‰ |
| Python-Jose | 3.3.0 | JWT è®¤è¯ |
| Aiosqlite | 0.19.0 | å¼‚æ­¥ SQLite |

---

## ğŸ”‘ åˆå§‹åŒ–æ•°æ®

å®Œå…¨æŒ‰ç…§åšå®¢æ•°æ®åˆå§‹åŒ–ï¼š

### ç”¨æˆ· (t_user)
```
user_id: 1
username: BNTang
password: 1234qwer (BCryptåŠ å¯†)
email: 303158131@qq.com
mobile: 17788888888
status: 1 (æœ‰æ•ˆ)
ssex: 0 (ç”·)
description: æˆ‘æ˜¯å¸…æ¯”ä½œè€…ã€‚
```

### è§’è‰² (t_role)
```
role_id: 1
role_name: ç®¡ç†å‘˜
remark: ç®¡ç†å‘˜
```

### èœå• (t_menu)
```
1. ç³»ç»Ÿç®¡ç† (èœå•, type=0)
2. ç”¨æˆ·ç®¡ç† (èœå•, type=0, perms=user:view)
3. æ–°å¢ç”¨æˆ· (æŒ‰é’®, type=1, perms=user:add)
4. ä¿®æ”¹ç”¨æˆ· (æŒ‰é’®, type=1, perms=user:update)
5. åˆ é™¤ç”¨æˆ· (æŒ‰é’®, type=1, perms=user:delete)
```

### éƒ¨é—¨ (t_dept)
```
dept_id: 1
dept_name: å¼€å‘éƒ¨
parent_id: 0
```

### å…³è”å…³ç³»
```
t_user_role: user_id=1 â†” role_id=1 (BNTang æ˜¯ç®¡ç†å‘˜)
t_role_menu: role_id=1 æ‹¥æœ‰æ‰€æœ‰ 5 ä¸ªèœå•æƒé™
```

---

## ğŸ³ Docker éƒ¨ç½²

### ä½¿ç”¨ Docker Compose

```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

### ä½¿ç”¨ Docker

```bash
# æ„å»ºé•œåƒ
docker build -t fastapi-rbac .

# è¿è¡Œå®¹å™¨
docker run -d -p 8000:8000 fastapi-rbac
```

---

## ğŸ“– æ–‡æ¡£è¯´æ˜

| æ–‡æ¡£ | è¯´æ˜ |
|-----|------|
| [README.md](README.md) | é¡¹ç›®ä¸»æ–‡æ¡£ï¼ˆæœ¬æ–‡ä»¶ï¼‰ |
| [APIæ¥å£æ–‡æ¡£.md](APIæ¥å£æ–‡æ¡£.md) | å®Œæ•´çš„ API æ¥å£æ–‡æ¡£ï¼ˆ35+ æ¥å£ï¼‰ |

---

## ğŸ”— å‚è€ƒèµ„æ–™

- **åšå®¢æ–‡ç« **: [RBACè¡¨ç»“æ„è®¾è®¡ - BNTang](https://www.cnblogs.com/BNTang/articles/17024549.html)
- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [SQLAlchemy æ–‡æ¡£](https://docs.sqlalchemy.org/)
- [Pydantic æ–‡æ¡£](https://docs.pydantic.dev/)

---

## ğŸ“„ è®¸å¯è¯

MIT License

---

**é¡¹ç›®å®Œæˆ**: 2025-10-02  
**è¡¨ç»“æ„**: 100% å¯¹åº”åšå®¢è®¾è®¡  
**æµ‹è¯•æ•°æ®**: 100% å¯¹åº”åšå®¢æ•°æ®  
**åœ¨çº¿æ–‡æ¡£**: http://localhost:8000/docs
