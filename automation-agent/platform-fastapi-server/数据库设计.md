# API 自动化测试平台 - 数据库设计文档

## 1. 概述

本文档描述了 API 自动化测试平台的数据库设计，包括现有设计分析和优化建议方案。

## 2. 现有数据库设计分析

### 2.1 表结构概览

系统共有 **26 张数据表**，分为以下几个模块：

| 模块 | 表数量 | 说明 |
|------|--------|------|
| RBAC 权限管理 | 11 | 用户、角色、菜单、API权限、部门等 |
| API 测试核心 | 10 | 项目、接口、用例、集合、历史等 |
| 关键字驱动 | 2 | 关键字、操作类型 |
| 机器人通知 | 2 | 机器人配置、消息配置 |
| 图表报表 | 1 | 测试计划图表 |

### 2.2 现有表结构详情

#### 2.2.1 RBAC 权限管理模块

##### t_user（用户表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| username | String(50) | UNIQUE, NOT NULL | 用户名 |
| alias | String(50) | NULL | 用户昵称/别名 |
| password | String(255) | NOT NULL | 密码（bcrypt加密） |
| email | String(100) | NULL | 邮箱 |
| phone | String(20) | NULL | 手机号 |
| is_active | Boolean | NOT NULL, DEFAULT TRUE | 是否激活 |
| is_superuser | Boolean | NOT NULL, DEFAULT FALSE | 是否超级管理员 |
| dept_id | Integer | FK(t_dept.id) | 所属部门ID |
| last_login | DateTime | NULL | 最后登录时间 |
| created_at | DateTime | NOT NULL | 创建时间 |
| updated_at | DateTime | NOT NULL | 更新时间 |

##### t_role（角色表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| name | String(50) | UNIQUE, NOT NULL | 角色名称 |
| desc | String(200) | NULL | 角色描述 |
| created_at | DateTime | NOT NULL | 创建时间 |
| updated_at | DateTime | NOT NULL | 更新时间 |

##### t_menu（菜单表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| name | String(50) | NOT NULL | 菜单名称 |
| menu_type | String(10) | NOT NULL, DEFAULT 'menu' | 菜单类型 |
| icon | String(50) | NULL | 菜单图标 |
| path | String(200) | NOT NULL | 路由路径 |
| component | String(200) | NULL | 组件路径 |
| order | Integer | NOT NULL, DEFAULT 0 | 排序号 |
| parent_id | Integer | NOT NULL, DEFAULT 0 | 父菜单ID |
| is_hidden | Boolean | NOT NULL, DEFAULT FALSE | 是否隐藏 |
| keepalive | Boolean | NOT NULL, DEFAULT TRUE | 是否缓存 |
| redirect | String(200) | NULL | 重定向路径 |
| created_at | DateTime | NOT NULL | 创建时间 |
| updated_at | DateTime | NOT NULL | 更新时间 |

##### t_api（API权限表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| path | String(200) | NOT NULL | API路径 |
| method | String(10) | NOT NULL | HTTP方法 |
| summary | String(200) | NULL | API描述 |
| tags | String(100) | NULL | API标签 |
| created_at | DateTime | NOT NULL | 创建时间 |
| updated_at | DateTime | NOT NULL | 更新时间 |

##### t_dept（部门表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| name | String(50) | NOT NULL | 部门名称 |
| desc | String(200) | NULL | 部门描述 |
| parent_id | Integer | NOT NULL, DEFAULT 0 | 父部门ID |
| order | Integer | NOT NULL, DEFAULT 0 | 排序号 |
| is_deleted | Boolean | NOT NULL, DEFAULT FALSE | 是否删除 |
| created_at | DateTime | NOT NULL | 创建时间 |
| updated_at | DateTime | NOT NULL | 更新时间 |

##### t_dept_closure（部门闭包表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| ancestor_id | BigInteger | PK | 祖先部门ID |
| descendant_id | BigInteger | PK | 后代部门ID |
| level | BigInteger | NOT NULL | 层级距离 |

##### t_api_resource（API资源表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| path | String(500) | NOT NULL | API路径 |
| method | String(10) | NOT NULL | HTTP方法 |
| summary | String(200) | NULL | API说明 |
| tags | String(200) | NULL | API标签 |
| created_at | DateTime | NOT NULL | 创建时间 |
| updated_at | DateTime | NOT NULL | 更新时间 |

##### t_audit_log（审计日志表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| user_id | Integer | FK(t_user.id) | 用户ID |
| username | String(50) | NULL | 用户名（冗余） |
| module | String(50) | NULL | 模块名称 |
| summary | String(200) | NULL | 操作摘要 |
| method | String(10) | NULL | HTTP方法 |
| path | String(500) | NULL | 请求路径 |
| status | Integer | NOT NULL, DEFAULT 0 | 响应状态码 |
| response_time | Numeric(10,2) | NULL | 响应时间(ms) |
| request_args | JSON | NULL | 请求参数 |
| response_body | JSON | NULL | 响应体 |
| created_at | DateTime | NOT NULL | 创建时间 |
| updated_at | DateTime | NOT NULL | 更新时间 |

##### t_user_role（用户角色关联表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| user_id | Integer | FK(t_user.id), NOT NULL | 用户ID |
| role_id | Integer | FK(t_role.id), NOT NULL | 角色ID |
| created_at | DateTime | NOT NULL | 创建时间 |

##### t_role_menu（角色菜单关联表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| role_id | Integer | FK(t_role.id), NOT NULL | 角色ID |
| menu_id | Integer | FK(t_menu.id), NOT NULL | 菜单ID |
| created_at | DateTime | NOT NULL | 创建时间 |

##### t_role_api（角色API关联表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| role_id | Integer | FK(t_role.id), NOT NULL | 角色ID |
| api_id | Integer | FK(t_api.id), NOT NULL | API权限ID |
| created_at | DateTime | NOT NULL | 创建时间 |

#### 2.2.2 API 测试核心模块

##### t_api_project（项目表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID（继承自Base） |
| project_name | String(255) | NULL | 项目名称 |
| project_desc | String(500) | NULL | 项目描述 |
| create_time | DateTime | NULL | 创建时间（继承自Base） |
| update_time | DateTime | NULL | 更新时间（继承自Base） |

##### t_api_info（API信息表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID（继承自Base） |
| project_id | Integer | NULL | 项目ID |
| module_id | Integer | NULL | 模块ID |
| api_name | String(255) | NULL | 接口名称 |
| request_method | String(255) | NULL | 请求方法 |
| request_url | String(255) | NULL | 请求地址 |
| request_params | String(255) | NULL | URL参数 |
| request_headers | Text | NULL | 请求头 |
| debug_vars | Text | NULL | 调试参数 |
| request_form_datas | String(255) | NULL | form-data |
| request_www_form_datas | String(255) | NULL | www-form-data |
| requests_json_data | String(255) | NULL | json数据 |
| request_files | String(255) | NULL | 文件列表 |
| create_time | DateTime | NULL | 创建时间（继承自Base） |
| update_time | DateTime | NULL | 更新时间（继承自Base） |

##### t_api_meta（API元数据表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| project_id | Integer | NULL | 项目ID |
| module_id | Integer | NULL | 模块ID |
| api_name | String(255) | NULL | 接口名称 |
| request_method | String(255) | NULL | 请求方法 |
| request_url | String(255) | NULL | 请求地址 |
| request_params | String(255) | NULL | URL参数 |
| request_headers | Text | NULL | 请求头 |
| debug_vars | Text | NULL | 调试参数 |
| request_form_datas | String(255) | NULL | form-data |
| request_www_form_datas | String(255) | NULL | www-form-data |
| requests_json_data | String(255) | NULL | json数据 |
| request_files | String(255) | NULL | 文件列表 |
| create_time | DateTime | NULL | 创建时间 |

##### t_api_info_case（测试用例表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 用例编号 |
| project_id | Integer | NULL | 项目ID |
| module_id | Integer | NULL | 模块ID |
| case_name | String(255) | NULL | 用例名称 |
| case_desc | String(255) | NULL | 用例描述 |
| param_data | String(255) | NULL | 调试变量 |
| pre_request | String(255) | NULL | 执行前事件 |
| post_request | String(255) | NULL | 执行后事件 |
| debug_info | String(255) | NULL | 调试信息 |
| create_time | DateTime | NULL | 创建时间 |

##### t_api_info_step（测试用例步骤表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| api_case_info_id | Integer | NULL | 用例ID |
| key_word_id | Integer | NULL | 关键字方法ID |
| step_desc | String(255) | NULL | 步骤描述 |
| ref_variable | String(255) | NULL | 引用变量 |
| run_order | Integer | NULL | 步骤顺序 |
| create_time | DateTime | NULL | 创建时间 |

##### t_api_collection_info（测试集合表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| project_id | Integer | NULL | 项目ID |
| collection_name | String(255) | NULL | 集合名称 |
| collection_desc | String(255) | NULL | 集合描述 |
| collection_env | Text | NULL | 全局变量 |
| create_time | DateTime | NULL | 创建时间 |

##### t_api_collection_detail（测试集合详情表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| collection_info_id | Integer | NULL | 集合信息ID |
| api_info_id | Integer | NULL | API信息ID |
| run_order | Integer | NULL | 执行顺序 |
| create_time | DateTime | NULL | 创建时间 |

##### t_api_history（执行历史表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK | 记录编号 |
| collection_info_id | Integer | NULL | 集合信息ID |
| history_desc | String(255) | NULL | 运行记录简述 |
| history_detail | Text | NULL | 运行详细记录 |
| create_time | DateTime | NULL | 创建时间 |

##### t_api_database（数据库配置表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| project_id | Integer | NULL | 项目ID |
| name | String(255) | NULL | 连接名 |
| ref_name | String(255) | NULL | 引用变量 |
| db_type | String(255) | NULL | 数据库类型 |
| db_info | Text | NULL | 连接信息 |
| is_enabled | String(255) | NULL | 是否启用 |
| create_time | DateTime | NULL | 创建时间 |

#### 2.2.3 关键字驱动模块

##### t_api_keyword（关键字表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| name | String(255) | NULL | 关键字名称 |
| keyword_desc | String(255) | NULL | 关键字描述 |
| operation_type_id | Integer | NULL | 操作类型ID |
| keyword_fun_name | String(255) | NULL | 方法名 |
| keyword_value | Text | NULL | 方法体 |
| is_enabled | String(255) | NULL | 是否启用 |
| page_id | Integer | NULL | 页面ID |
| create_time | DateTime | NULL | 创建时间 |

##### t_api_operation_type（操作类型表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| operation_type_name | String(255) | NULL | 类型名称 |
| operation_type_desc | String(255) | NULL | 类型描述 |
| operation_type_fun_name | String(255) | NULL | 方法名 |
| operation_type_value | Text | NULL | 方法体 |
| is_enabled | String(255) | NULL | 是否启用 |
| create_time | DateTime | NULL | 创建时间 |

#### 2.2.4 机器人通知模块

##### t_robot_config（机器人配置表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| robot_name | String(255) | NULL | 机器人名称 |
| robot_type | String(255) | NULL | 机器人类型 |
| webhook_url | String(255) | NULL | Webhook URL |
| message_template | Text | NULL | 消息模板 |
| keywords | Text | NULL | 关键词（JSON） |
| create_time | DateTime | NULL | 创建时间 |

##### t_robot_msg_config（消息配置表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| robot_id | Integer | NULL | 机器人ID |
| msg_type | String(255) | NULL | 消息类型 |
| msg_content | Text | NULL | 消息内容 |
| msg_vars | Text | NULL | 消息变量 |
| is_enabled | String(255) | NULL | 是否启用 |
| create_time | DateTime | NULL | 创建时间 |

#### 2.2.5 图表报表模块

##### t_api_test_plan_chart（测试计划图表表）
| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT | 主键ID |
| project_id | Integer | NULL | 项目ID |
| chart_name | String(255) | NULL | 图表名称 |
| chart_type | String(255) | NULL | 图表类型 |
| chart_data | Text | NULL | 图表数据 |
| chart_config | Text | NULL | 图表配置 |
| create_time | DateTime | NULL | 创建时间 |

### 2.3 现有设计问题分析

#### 2.3.1 命名规范问题

| 问题 | 说明 | 影响的表/字段 |
|------|------|--------------|
| 时间字段命名不一致 | RBAC模块使用 `created_at/updated_at`，API测试模块使用 `create_time/update_time` | 几乎所有表 |
| 布尔字段类型不一致 | 部分使用 Boolean，部分使用 String(255) 存储 | `is_enabled` 字段 |
| 字段命名风格不一致 | 部分使用下划线，部分使用驼峰 | `requests_json_data` vs `requestJsonData` |

#### 2.3.2 数据完整性问题

| 问题 | 说明 | 影响的表 |
|------|------|---------|
| 缺少外键约束 | API测试模块的关联字段未设置外键 | t_api_info, t_api_info_case, t_api_collection_detail 等 |
| 字段允许NULL过多 | 大量字段允许为空，无业务必填约束 | 几乎所有API测试相关表 |
| 缺少唯一约束 | 业务上应唯一的字段未设置唯一约束 | project_name, api_name 等 |

#### 2.3.3 表结构冗余问题

| 问题 | 说明 | 影响的表 |
|------|------|---------|
| t_api 与 t_api_resource 功能重叠 | 两张表存储相似数据，职责不清 | t_api, t_api_resource |
| t_api_info 与 t_api_meta 结构几乎相同 | 可能是历史遗留问题 | t_api_info, t_api_meta |

#### 2.3.4 索引缺失问题

| 问题 | 说明 | 影响的查询 |
|------|------|----------|
| 关联字段缺少索引 | project_id, module_id 等查询频繁但无索引 | 列表查询、级联查询 |
| 组合查询缺少联合索引 | 常见的多字段组合查询无优化 | 条件筛选查询 |

#### 2.3.5 数据类型不合理

| 问题 | 说明 | 影响的字段 |
|------|------|----------|
| String(255) 过度使用 | 不合理的字段长度定义 | request_method, is_enabled 等 |
| Text 类型存储 JSON | 未使用 JSON 类型，无法利用数据库 JSON 功能 | 多个存储 JSON 的字段 |

---

## 3. 优化后的数据库设计

### 3.1 设计原则

1. **命名规范统一**：所有时间字段统一使用 `created_at/updated_at`
2. **数据类型合理**：布尔值使用 Boolean，JSON 数据使用 JSON 类型
3. **约束完整**：添加必要的外键约束、唯一约束、非空约束
4. **索引优化**：为高频查询字段添加索引
5. **保持功能不变**：所有优化不影响现有功能

### 3.2 优化后的表结构

#### 3.2.1 公共基类（Base）

```python
class Base:
    """SQLAlchemy 模型基类"""
    id = Column(Integer, primary_key=True, autoincrement=True, index=True, comment='主键ID')
    created_at = Column(DateTime, default=datetime.now, nullable=False, comment='创建时间')
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now, nullable=False, comment='更新时间')
```

#### 3.2.2 RBAC 权限管理模块（保持不变，设计已较为合理）

##### t_user（用户表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| username | String(50) | UNIQUE, NOT NULL, INDEX | 用户名 | 添加索引 |
| alias | String(50) | NULL | 用户昵称 | - |
| password | String(255) | NOT NULL | 密码（bcrypt） | - |
| email | String(100) | NULL, INDEX | 邮箱 | 添加索引 |
| phone | String(20) | NULL | 手机号 | - |
| is_active | Boolean | NOT NULL, DEFAULT TRUE | 是否激活 | - |
| is_superuser | Boolean | NOT NULL, DEFAULT FALSE | 是否超管 | - |
| dept_id | Integer | FK(t_dept.id), INDEX | 部门ID | 添加索引 |
| last_login | DateTime | NULL | 最后登录时间 | - |
| created_at | DateTime | NOT NULL | 创建时间 | - |
| updated_at | DateTime | NOT NULL | 更新时间 | - |

**索引设计**：
- `idx_user_username` (username) - 唯一索引
- `idx_user_email` (email) - 普通索引
- `idx_user_dept` (dept_id) - 外键索引
- `idx_user_active` (is_active) - 普通索引

##### t_role（角色表）- 无变更

##### t_menu（菜单表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| ... | ... | ... | ... | ... |
| parent_id | Integer | NOT NULL, DEFAULT 0, INDEX | 父菜单ID | 添加索引 |

**索引设计**：
- `idx_menu_parent` (parent_id) - 树形查询索引
- `idx_menu_order` (order) - 排序索引

##### t_dept（部门表）- 优化版
**索引设计**：
- `idx_dept_parent` (parent_id) - 树形查询索引
- `idx_dept_deleted` (is_deleted) - 软删除过滤索引

##### 中间关联表优化

###### t_user_role
添加联合唯一约束：
```python
__table_args__ = (
    UniqueConstraint('user_id', 'role_id', name='uq_user_role'),
    Index('idx_user_role_user', 'user_id'),
    Index('idx_user_role_role', 'role_id'),
)
```

###### t_role_menu
```python
__table_args__ = (
    UniqueConstraint('role_id', 'menu_id', name='uq_role_menu'),
    Index('idx_role_menu_role', 'role_id'),
    Index('idx_role_menu_menu', 'menu_id'),
)
```

###### t_role_api
```python
__table_args__ = (
    UniqueConstraint('role_id', 'api_id', name='uq_role_api'),
    Index('idx_role_api_role', 'role_id'),
    Index('idx_role_api_api', 'api_id'),
)
```

#### 3.2.3 API 测试核心模块（重点优化）

##### t_api_project（项目表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| project_name | String(100) | NOT NULL, UNIQUE | 项目名称 | 添加非空、唯一约束，调整长度 |
| project_desc | String(500) | NULL | 项目描述 | - |
| owner_id | Integer | FK(t_user.id), INDEX | 项目负责人 | **新增字段** |
| status | SmallInteger | NOT NULL, DEFAULT 1 | 状态(1启用/0禁用) | **新增字段** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | 统一命名 |

**索引设计**：
- `idx_project_name` (project_name) - 唯一索引
- `idx_project_owner` (owner_id) - 外键索引
- `idx_project_status` (status) - 状态过滤索引

##### t_api_info（API信息表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| project_id | Integer | FK(t_api_project.id), NOT NULL, INDEX | 项目ID | 添加外键、非空约束 |
| module_id | Integer | INDEX | 模块ID | 添加索引（暂无模块表） |
| api_name | String(100) | NOT NULL | 接口名称 | 添加非空约束，调整长度 |
| request_method | String(10) | NOT NULL | 请求方法 | 添加非空约束，调整长度 |
| request_url | String(500) | NOT NULL | 请求地址 | 添加非空约束，调整长度 |
| request_params | JSON | NULL | URL参数 | **改为JSON类型** |
| request_headers | JSON | NULL | 请求头 | **改为JSON类型** |
| debug_vars | JSON | NULL | 调试参数 | **改为JSON类型** |
| request_body_type | String(20) | NULL | 请求体类型 | **新增字段** (form-data/json/www-form/files) |
| request_body | JSON | NULL | 请求体数据 | **合并多个字段为一个JSON** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | 统一命名 |

**索引设计**：
- `idx_api_info_project` (project_id) - 项目过滤索引
- `idx_api_info_module` (module_id) - 模块过滤索引
- `idx_api_info_method` (request_method) - 方法过滤索引
- `idx_api_info_project_module` (project_id, module_id) - 联合索引

**字段合并说明**：
原有的 `request_form_datas`, `request_www_form_datas`, `requests_json_data`, `request_files` 合并为：
- `request_body_type`: 标识请求体类型
- `request_body`: JSON 格式存储请求体数据

##### t_api_info_case（测试用例表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 用例编号 | - |
| project_id | Integer | FK(t_api_project.id), NOT NULL, INDEX | 项目ID | 添加外键、非空约束 |
| module_id | Integer | INDEX | 模块ID | 添加索引 |
| api_info_id | Integer | FK(t_api_info.id), INDEX | 关联API | **新增字段** |
| case_name | String(100) | NOT NULL | 用例名称 | 添加非空约束，调整长度 |
| case_desc | String(500) | NULL | 用例描述 | 调整长度 |
| priority | SmallInteger | NOT NULL, DEFAULT 2 | 优先级(1高/2中/3低) | **新增字段** |
| status | SmallInteger | NOT NULL, DEFAULT 1 | 状态 | **新增字段** |
| param_data | JSON | NULL | 调试变量 | **改为JSON类型** |
| pre_request | JSON | NULL | 执行前事件 | **改为JSON类型** |
| post_request | JSON | NULL | 执行后事件 | **改为JSON类型** |
| assertions | JSON | NULL | 断言配置 | **新增字段** |
| debug_info | JSON | NULL | 调试信息 | **改为JSON类型** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

**索引设计**：
- `idx_case_project` (project_id) - 项目过滤索引
- `idx_case_module` (module_id) - 模块过滤索引
- `idx_case_api` (api_info_id) - API关联索引
- `idx_case_priority` (priority) - 优先级索引
- `idx_case_status` (status) - 状态索引

##### t_api_info_step（测试步骤表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| api_case_id | Integer | FK(t_api_info_case.id), NOT NULL, INDEX | 用例ID | 添加外键、非空约束，改名 |
| keyword_id | Integer | FK(t_api_keyword.id), INDEX | 关键字ID | 添加外键，改名 |
| step_order | Integer | NOT NULL, DEFAULT 0 | 步骤顺序 | 改名 run_order -> step_order |
| step_desc | String(255) | NULL | 步骤描述 | - |
| step_params | JSON | NULL | 步骤参数 | **新增字段** |
| ref_variable | String(255) | NULL | 引用变量 | - |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

**索引设计**：
- `idx_step_case` (api_case_id) - 用例关联索引
- `idx_step_keyword` (keyword_id) - 关键字关联索引
- `idx_step_order` (api_case_id, step_order) - 步骤排序联合索引

##### t_api_collection_info（测试集合表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| project_id | Integer | FK(t_api_project.id), NOT NULL, INDEX | 项目ID | 添加外键、非空约束 |
| collection_name | String(100) | NOT NULL | 集合名称 | 添加非空约束，调整长度 |
| collection_desc | String(500) | NULL | 集合描述 | 调整长度 |
| collection_env | JSON | NULL | 全局变量 | **改为JSON类型** |
| status | SmallInteger | NOT NULL, DEFAULT 1 | 状态 | **新增字段** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

##### t_api_collection_detail（测试集合详情表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| collection_id | Integer | FK(t_api_collection_info.id), NOT NULL, INDEX | 集合ID | 添加外键、非空约束，改名 |
| api_case_id | Integer | FK(t_api_info_case.id), NOT NULL, INDEX | 用例ID | **改为关联用例** |
| run_order | Integer | NOT NULL, DEFAULT 0 | 执行顺序 | 添加非空约束 |
| is_enabled | Boolean | NOT NULL, DEFAULT TRUE | 是否启用 | **新增字段，Boolean类型** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |

**索引设计**：
- `idx_detail_collection` (collection_id) - 集合关联索引
- `idx_detail_case` (api_case_id) - 用例关联索引
- `idx_detail_order` (collection_id, run_order) - 排序联合索引
- `uq_collection_case` (collection_id, api_case_id) - 联合唯一约束

##### t_api_history（执行历史表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 记录编号 | - |
| collection_id | Integer | FK(t_api_collection_info.id), INDEX | 集合ID | 添加外键，改名 |
| executor_id | Integer | FK(t_user.id), INDEX | 执行人ID | **新增字段** |
| start_time | DateTime | NOT NULL | 开始时间 | **新增字段** |
| end_time | DateTime | NULL | 结束时间 | **新增字段** |
| duration | Integer | NULL | 耗时(毫秒) | **新增字段** |
| total_count | Integer | NOT NULL, DEFAULT 0 | 总用例数 | **新增字段** |
| pass_count | Integer | NOT NULL, DEFAULT 0 | 通过数 | **新增字段** |
| fail_count | Integer | NOT NULL, DEFAULT 0 | 失败数 | **新增字段** |
| skip_count | Integer | NOT NULL, DEFAULT 0 | 跳过数 | **新增字段** |
| status | SmallInteger | NOT NULL, DEFAULT 0 | 状态(0执行中/1完成/2失败) | **新增字段** |
| history_desc | String(255) | NULL | 运行简述 | - |
| history_detail | JSON | NULL | 运行详情 | **改为JSON类型** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |

**索引设计**：
- `idx_history_collection` (collection_id) - 集合关联索引
- `idx_history_executor` (executor_id) - 执行人索引
- `idx_history_status` (status) - 状态索引
- `idx_history_time` (created_at) - 时间索引

##### t_api_database（数据库配置表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| project_id | Integer | FK(t_api_project.id), NOT NULL, INDEX | 项目ID | 添加外键、非空约束 |
| name | String(100) | NOT NULL | 连接名 | 添加非空约束，调整长度 |
| ref_name | String(50) | NOT NULL, UNIQUE | 引用变量 | 添加非空、唯一约束 |
| db_type | String(20) | NOT NULL | 数据库类型 | 添加非空约束，调整长度 |
| db_config | JSON | NOT NULL | 连接配置 | **改为JSON类型，改名** |
| is_enabled | Boolean | NOT NULL, DEFAULT TRUE | 是否启用 | **改为Boolean类型** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

**索引设计**：
- `idx_database_project` (project_id) - 项目关联索引
- `uq_database_ref` (project_id, ref_name) - 引用名唯一约束

#### 3.2.4 关键字驱动模块（优化版）

##### t_api_keyword（关键字表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| name | String(100) | NOT NULL | 关键字名称 | 添加非空约束，调整长度 |
| keyword_desc | String(255) | NULL | 关键字描述 | - |
| operation_type_id | Integer | FK(t_api_operation_type.id), INDEX | 操作类型ID | 添加外键 |
| keyword_fun_name | String(100) | NOT NULL | 方法名 | 添加非空约束，调整长度 |
| keyword_value | Text | NULL | 方法体 | - |
| is_enabled | Boolean | NOT NULL, DEFAULT TRUE | 是否启用 | **改为Boolean类型** |
| page_id | Integer | INDEX | 页面ID | 添加索引 |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

##### t_api_operation_type（操作类型表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| operation_type_name | String(50) | NOT NULL, UNIQUE | 类型名称 | 添加非空、唯一约束 |
| operation_type_desc | String(255) | NULL | 类型描述 | - |
| operation_type_fun_name | String(100) | NULL | 方法名 | 调整长度 |
| operation_type_value | Text | NULL | 方法体 | - |
| is_enabled | Boolean | NOT NULL, DEFAULT TRUE | 是否启用 | **改为Boolean类型** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

#### 3.2.5 机器人通知模块（优化版）

##### t_robot_config（机器人配置表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| robot_name | String(100) | NOT NULL | 机器人名称 | 添加非空约束，调整长度 |
| robot_type | String(20) | NOT NULL | 机器人类型 | 添加非空约束，调整长度 |
| webhook_url | String(500) | NOT NULL | Webhook URL | 添加非空约束，调整长度 |
| message_template | Text | NULL | 消息模板 | - |
| keywords | JSON | NULL | 关键词配置 | **改为JSON类型** |
| is_enabled | Boolean | NOT NULL, DEFAULT TRUE | 是否启用 | **新增字段** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

##### t_robot_msg_config（消息配置表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| robot_id | Integer | FK(t_robot_config.id), NOT NULL, INDEX | 机器人ID | 添加外键、非空约束 |
| msg_type | String(50) | NOT NULL | 消息类型 | 添加非空约束，调整长度 |
| msg_content | Text | NOT NULL | 消息内容 | 添加非空约束 |
| msg_vars | JSON | NULL | 消息变量 | **改为JSON类型** |
| is_enabled | Boolean | NOT NULL, DEFAULT TRUE | 是否启用 | **改为Boolean类型** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

#### 3.2.6 图表报表模块（优化版）

##### t_api_test_plan_chart（测试计划图表表）- 优化版
| 字段 | 类型 | 约束 | 说明 | 变更 |
|------|------|------|------|------|
| id | Integer | PK, AUTO_INCREMENT, INDEX | 主键ID | - |
| project_id | Integer | FK(t_api_project.id), NOT NULL, INDEX | 项目ID | 添加外键、非空约束 |
| chart_name | String(100) | NOT NULL | 图表名称 | 添加非空约束，调整长度 |
| chart_type | String(50) | NOT NULL | 图表类型 | 添加非空约束，调整长度 |
| chart_data | JSON | NULL | 图表数据 | **改为JSON类型** |
| chart_config | JSON | NULL | 图表配置 | **改为JSON类型** |
| created_at | DateTime | NOT NULL | 创建时间 | 统一命名 |
| updated_at | DateTime | NOT NULL | 更新时间 | **新增字段** |

#### 3.2.7 废弃表处理建议

##### t_api_meta（API元数据表）
**建议**：标记为废弃，数据迁移至 `t_api_info`
**原因**：与 `t_api_info` 结构完全相同，功能重复

##### t_api_resource（API资源表）
**建议**：评估是否与 `t_api` 合并或明确区分职责
**原因**：与 `t_api` 存储相似数据，可能造成维护困难

---

### 3.3 ER 图（实体关系图）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              RBAC 权限管理模块                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────┐       ┌─────────────┐       ┌──────────┐                    │
│   │  t_dept  │       │   t_user    │       │  t_role  │                    │
│   └────┬─────┘       └──────┬──────┘       └────┬─────┘                    │
│        │ 1:N               │                    │                          │
│        └──────────────>────┘                    │                          │
│                             \                  /                           │
│                              \    N:M        /                             │
│                               \            /                               │
│                            ┌───────────────┐                               │
│                            │ t_user_role   │                               │
│                            └───────────────┘                               │
│                                                                             │
│                    ┌───────────┐       ┌───────────┐                       │
│                    │  t_menu   │       │   t_api   │                       │
│                    └─────┬─────┘       └─────┬─────┘                       │
│                          │                   │                             │
│                          │ N:M              │ N:M                         │
│                          │                   │                             │
│                    ┌──────────────┐   ┌──────────────┐                     │
│                    │ t_role_menu  │   │  t_role_api  │                     │
│                    └──────────────┘   └──────────────┘                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              API 测试核心模块                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────┐                                                        │
│   │ t_api_project │◄────────────────────────────────────────┐              │
│   └───────┬───────┘                                         │              │
│           │ 1:N                                             │              │
│           ▼                                                 │              │
│   ┌───────────────┐       ┌────────────────────┐           │              │
│   │  t_api_info   │◄──────│ t_api_collection   │◄──────────┤              │
│   └───────┬───────┘       │      _info         │           │              │
│           │               └─────────┬──────────┘           │              │
│           │ 1:N                     │ 1:N                  │              │
│           ▼                         ▼                      │              │
│   ┌───────────────┐       ┌────────────────────┐           │              │
│   │t_api_info_case│◄──────│ t_api_collection   │           │              │
│   └───────┬───────┘       │     _detail        │           │              │
│           │               └────────────────────┘           │              │
│           │ 1:N                     │                      │              │
│           ▼                         │                      │              │
│   ┌───────────────┐                 │                      │              │
│   │t_api_info_step│                 │                      │              │
│   └───────────────┘                 │                      │              │
│           │                         │                      │              │
│           │                         ▼                      │              │
│           │               ┌────────────────────┐           │              │
│           │               │   t_api_history    │───────────┘              │
│           │               └────────────────────┘                          │
│           │                                                               │
│           │               ┌────────────────────┐                          │
│           └──────────────►│   t_api_keyword    │                          │
│                           └─────────┬──────────┘                          │
│                                     │ N:1                                 │
│                                     ▼                                     │
│                           ┌────────────────────┐                          │
│                           │t_api_operation_type│                          │
│                           └────────────────────┘                          │
│                                                                           │
│   ┌───────────────┐       ┌────────────────────┐                          │
│   │ t_api_database│       │t_api_test_plan_chart│                         │
│   └───────────────┘       └────────────────────┘                          │
│                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              机器人通知模块                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────┐       ┌────────────────────┐                           │
│   │ t_robot_config│──────►│ t_robot_msg_config │                           │
│   └───────────────┘  1:N  └────────────────────┘                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 3.4 数据库迁移策略

#### 3.4.1 迁移顺序

1. **第一阶段**：字段类型优化（低风险）
   - 将 `is_enabled` 从 String 改为 Boolean
   - 将 Text 类型的 JSON 数据改为 JSON 类型
   - 统一时间字段命名

2. **第二阶段**：添加约束（中风险）
   - 添加外键约束
   - 添加唯一约束
   - 添加非空约束（需先处理现有 NULL 数据）

3. **第三阶段**：添加索引（低风险）
   - 添加单字段索引
   - 添加联合索引

4. **第四阶段**：表结构调整（高风险）
   - 合并冗余字段
   - 新增必要字段
   - 废弃重复表

#### 3.4.2 迁移脚本示例

```python
# 示例：将 is_enabled 从 String 改为 Boolean
from alembic import op
import sqlalchemy as sa

def upgrade():
    # 1. 添加新列
    op.add_column('t_api_keyword', sa.Column('is_enabled_new', sa.Boolean(), nullable=True))
    
    # 2. 数据迁移
    op.execute("""
        UPDATE t_api_keyword 
        SET is_enabled_new = CASE 
            WHEN is_enabled = 'true' OR is_enabled = '1' THEN TRUE 
            ELSE FALSE 
        END
    """)
    
    # 3. 删除旧列
    op.drop_column('t_api_keyword', 'is_enabled')
    
    # 4. 重命名新列
    op.alter_column('t_api_keyword', 'is_enabled_new', new_column_name='is_enabled')

def downgrade():
    # 回滚操作
    pass
```

---

## 4. 优化效果预期

### 4.1 性能提升

| 优化项 | 预期效果 |
|--------|----------|
| 添加外键索引 | 关联查询性能提升 30-50% |
| 添加联合索引 | 多条件查询性能提升 50-70% |
| JSON 类型替代 Text | JSON 查询支持，存储效率提升 |

### 4.2 数据质量提升

| 优化项 | 预期效果 |
|--------|----------|
| 外键约束 | 防止孤儿数据 |
| 非空约束 | 确保核心数据完整 |
| 唯一约束 | 防止数据重复 |
| 类型规范 | 减少数据格式错误 |

### 4.3 可维护性提升

| 优化项 | 预期效果 |
|--------|----------|
| 命名规范统一 | 降低理解成本 |
| 字段类型合理化 | 减少类型转换 |
| 废弃冗余表 | 简化数据模型 |

---

## 5. 附录

### 5.1 数据类型规范

| 数据类型 | 使用场景 | 示例 |
|----------|----------|------|
| Integer | 主键、外键、计数 | id, project_id, count |
| SmallInteger | 状态、优先级 | status, priority |
| String(N) | 短文本，N根据实际需要 | name, method |
| Text | 长文本（非结构化） | description |
| JSON | 结构化数据 | config, params |
| Boolean | 是否类字段 | is_enabled, is_active |
| DateTime | 时间戳 | created_at, updated_at |

### 5.2 索引命名规范

| 索引类型 | 命名格式 | 示例 |
|----------|----------|------|
| 主键索引 | pk_{table} | pk_t_user |
| 唯一索引 | uq_{table}_{column} | uq_user_username |
| 普通索引 | idx_{table}_{column} | idx_user_dept |
| 联合索引 | idx_{table}_{col1}_{col2} | idx_api_info_project_module |
| 外键索引 | fk_{table}_{ref_table} | fk_user_dept |

### 5.3 字段命名规范

| 字段类型 | 命名格式 | 示例 |
|----------|----------|------|
| 主键 | id | id |
| 外键 | {ref_table}_id | project_id, user_id |
| 布尔值 | is_{name} | is_enabled, is_active |
| 时间戳 | {action}_at | created_at, updated_at |
| 状态 | status | status |
| 计数 | {name}_count | pass_count, fail_count |
