# 开发环境搭建

<cite>
**本文档中引用的文件**
- [main.py](file://AI-agent-backend/main.py)
- [config.py](file://AI-agent-backend/app/core/config.py)
- [.env.example](file://AI-agent-backend/.env.example)
- [docker-compose.yml](file://AI-agent-backend/docker-compose.yml)
- [docker-compose.dev.yml](file://AI-agent-backend/docker-compose.dev.yml)
- [pyproject.toml](file://pyproject.toml)
- [package.json](file://AI-agent-frontend/package.json)
- [vite.config.ts](file://AI-agent-frontend/vite.config.ts)
- [setup_test_env.sh](file://AI-agent-backend/setup_test_env.sh)
- [setup_test_env.bat](file://AI-agent-backend/setup_test_env.bat)
</cite>

## 目录
1. [开发环境搭建](#开发环境搭建)
2. [项目结构概述](#项目结构概述)
3. [Python与Node.js环境配置](#python与nodejs环境配置)
4. [后端服务部署](#后端服务部署)
5. [前端服务部署](#前端服务部署)
6. [环境变量配置](#环境变量配置)
7. [服务启动与验证](#服务启动与验证)
8. [常见问题排查](#常见问题排查)

## 项目结构概述

本项目为全栈AI测试平台，采用前后端分离架构，包含以下主要模块：

- **AI-agent-backend**：基于FastAPI的后端服务，采用五层架构（Controller、Service、Repository、Entity、DTO）
- **AI-agent-frontend**：基于Vue 3和Vite的前端应用，使用TypeScript和Element Plus
- **根目录配置**：包含pyproject.toml和全局README

```mermaid
graph TB
subgraph "前端"
A[Vue 3]
B[Vite]
C[TypeScript]
D[Element Plus]
end
subgraph "后端"
E[FastAPI]
F[SQLAlchemy]
G[Pydantic]
H[Uvicorn]
end
subgraph "基础设施"
I[PostgreSQL]
J[Redis]
K[Docker]
end
A --> E
E --> I
E --> J
K --> I
K --> J
```

**Diagram sources**
- [project_structure](file://#L1-L50)

## Python与Node.js环境配置

### Python环境要求

根据项目配置文件分析，Python环境需满足以下要求：

- **版本要求**：Python 3.10+
- **验证方法**：
```bash
python --version
# 或
python3 --version
```

- **安装与验证脚本**（来自setup_test_env.sh）：
```bash
# 检查Python版本
if [[ $(echo "$PYTHON_VERSION >= 3.10" | bc -l) != 1 ]]; then
    echo "Python 3.10+ is required. Current version: $PYTHON_VERSION"
    exit 1
fi
```

### Node.js环境要求

根据前端依赖分析，Node.js环境需满足以下要求：

- **版本要求**：Node.js 18+
- **验证方法**：
```bash
node --version
# 需要 v18.0.0 或更高版本
```

- **依赖管理工具**：pnpm
- **安装方法**：
```bash
npm install -g pnpm
```

**Section sources**
- [setup_test_env.sh](file://AI-agent-backend/setup_test_env.sh#L0-L63)
- [setup_test_env.bat](file://AI-agent-backend/setup_test_env.bat#L0-L66)
- [package-lock.json](file://AI-agent-frontend/package-lock.json#L2525-L2560)

## 后端服务部署

### 依赖安装

后端使用Poetry进行依赖管理，安装步骤如下：

1. **安装项目依赖**：
```bash
# 在项目根目录执行
pip install -e .
```

或根据pyproject.toml手动安装：
```bash
pip install fastapi>=0.116.1 uvicorn>=0.35.0 sqlalchemy>=2.0.43 pydantic-settings>=2.10.1
```

### 数据库与Redis容器化部署

项目提供Docker Compose配置文件，支持一键部署数据库服务。

#### 生产环境配置 (docker-compose.yml)

```yaml
version: '3.8'

services:
  # PostgreSQL数据库
  db:
    image: postgres:15-alpine
    container_name: ai-agent-db
    environment:
      - POSTGRES_DB=ai_agent_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: ai-agent-redis
    command: redis-server --appendonly yes --requirepass redispassword
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
```

#### 开发环境配置 (docker-compose.dev.yml)

```yaml
version: '3.8'

services:
  # Redis缓存（开发环境）
  redis:
    image: redis:7-alpine
    container_name: ai-agent-redis-dev
    ports:
      - "6379:6379"

  # 数据库管理工具（可选）
  adminer:
    image: adminer
    container_name: ai-agent-adminer
    ports:
      - "8080:8080"
```

#### 容器启动命令

```bash
# 启动开发环境服务
docker-compose -f AI-agent-backend/docker-compose.dev.yml up -d

# 启动完整环境服务
docker-compose -f AI-agent-backend/docker-compose.yml up -d

# 查看服务状态
docker-compose -f AI-agent-backend/docker-compose.dev.yml ps
```

**Section sources**
- [docker-compose.yml](file://AI-agent-backend/docker-compose.yml#L0-L56)
- [docker-compose.dev.yml](file://AI-agent-backend/docker-compose.dev.yml#L0-L57)

## 前端服务部署

### 依赖安装

前端使用pnpm作为包管理器，安装步骤如下：

```bash
# 在AI-agent-frontend目录执行
pnpm install
```

### 项目依赖分析

根据package.json文件，主要依赖包括：

- **核心框架**：Vue 3, Vue Router
- **UI组件库**：Element Plus
- **状态管理**：Pinia
- **HTTP客户端**：Axios
- **开发工具**：Vite, TypeScript

```json
{
  "dependencies": {
    "vue": "^3.5.18",
    "vue-router": "^4.5.1",
    "element-plus": "^2.10.7",
    "axios": "^1.11.0",
    "pinia": "^3.0.3"
  },
  "devDependencies": {
    "vite": "^7.1.2",
    "typescript": "~5.8.3",
    "@vitejs/plugin-vue": "^6.0.1"
  }
}
```

**Section sources**
- [package.json](file://AI-agent-frontend/package.json#L0-L49)

## 环境变量配置

### 环境变量文件

项目使用`.env`文件管理环境变量，配置示例如下：

```env
# 应用配置
APP_NAME=AI-Agent-Backend
APP_VERSION=1.0.0
DEBUG=True
ENVIRONMENT=development

# 服务器配置
HOST=0.0.0.0
PORT=8000
RELOAD=True

# 数据库配置
DATABASE_URL=postgresql://username:password@localhost:5432/ai_agent_db

# Redis配置
REDIS_URL=redis://localhost:6379/0

# JWT配置
SECRET_KEY=your-super-secret-key-change-this-in-production
ACCESS_TOKEN_EXPIRE_MINUTES=30

# CORS配置
ALLOWED_ORIGINS=["http://localhost:3000", "http://localhost:8080"]
```

### 配置文件加载机制

后端使用Pydantic Settings管理配置，加载流程如下：

1. 从`.env`文件读取环境变量
2. 使用Settings类进行类型验证
3. 通过lru_cache实现配置单例

```python
class Settings(BaseSettings):
    # 配置项...
    
    class Config:
        env_file = ".env"
        env_file_encoding = "utf-8"
        case_sensitive = True

@lru_cache()
def get_settings() -> Settings:
    return Settings()

settings = get_settings()
```

**Section sources**
- [.env.example](file://AI-agent-backend/.env.example#L0-L61)
- [config.py](file://AI-agent-backend/app/core/config.py#L0-L197)

## 服务启动与验证

### 后端FastAPI服务启动

#### 方法一：直接运行（推荐开发环境）

```bash
# 在AI-agent-backend目录执行
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

#### 方法二：通过脚本启动

```bash
# 使用Docker Compose启动开发环境
docker-compose -f docker-compose.dev.yml up app
```

#### 启动流程分析

```mermaid
sequenceDiagram
participant User as "开发者"
participant Main as "main.py"
participant Config as "config.py"
participant DB as "数据库"
User->>Main : 执行uvicorn命令
Main->>Config : 加载配置(settings)
Config->>Config : 从.env读取变量
Main->>Main : 创建FastAPI应用实例
Main->>DB : 创建数据库表(create_tables)
Main->>Main : 注册路由(include_router)
Main->>Main : 添加中间件(add_middleware)
Main-->>User : 服务启动成功
Note over Main,User : 监听 http : //0.0.0.0 : 8000
```

**Diagram sources**
- [main.py](file://AI-agent-backend/main.py#L0-L199)
- [config.py](file://AI-agent-backend/app/core/config.py#L0-L197)

### 前端Vue开发服务器启动

#### 启动命令

```bash
# 在AI-agent-frontend目录执行
pnpm dev
```

#### Vite配置分析

```typescript
export default ({ mode }: any) => {
    const env = loadEnv(mode, process.cwd());
    return defineConfig({
        server: {
            host: '0.0.0.0',
            port: 8000,
            open: true,
            proxy: {
                '/api': {
                    target: 'http://localhost:8000',
                    changeOrigin: true,
                    secure: false,
                    rewrite: (path) => path.replace(/^\/api/, '/api')
                }
            }
        }
    })
}
```

关键配置说明：
- **端口**：8000
- **自动打开浏览器**：open: true
- **API代理**：将/api请求代理到后端8000端口

**Section sources**
- [vite.config.ts](file://AI-agent-frontend/vite.config.ts#L0-L56)
- [main.py](file://AI-agent-backend/main.py#L0-L199)

### 服务验证

#### 后端服务验证

访问健康检查端点：
```bash
curl http://localhost:8000/health
```

预期响应：
```json
{
    "status": "healthy",
    "service": "AI-Agent-Backend",
    "version": "1.0.0",
    "environment": "development"
}
```

#### 前端服务验证

服务启动后，浏览器会自动打开http://localhost:8000，应能看到前端应用界面。

API代理验证：
```bash
# 前端发起的请求会被代理到后端
curl http://localhost:8000/api/v1/health
```

## 常见问题排查

### 端口冲突问题

#### 问题现象
```
ERROR: for ai-agent-db  Cannot start service db: driver failed programming external connectivity on endpoint ai-agent-db: Error starting userland proxy: listen tcp 0.0.0.0:5432: bind: address already in use
```

#### 解决方案

1. **检查端口占用**：
```bash
# Linux/Mac
lsof -i :5432
# Windows
netstat -ano | findstr :5432
```

2. **修改Docker Compose端口映射**：
```yaml
services:
  db:
    ports:
      - "5433:5432"  # 修改为5433
```

3. **修改后端服务端口**（config.py）：
```python
PORT: int = 8001  # 改为8001避免端口冲突
```

### 依赖版本不兼容

#### 问题现象
```
ImportError: cannot import name 'some_function' from 'package_name'
```

#### 解决方案

1. **检查pyproject.toml中的依赖版本**：
```toml
[project]
dependencies = [
    "fastapi>=0.116.1",
    "sqlalchemy>=2.0.43",
    "uvicorn>=0.35.0",
]
```

2. **创建虚拟环境并重新安装**：
```bash
# 创建虚拟环境
python -m venv venv
# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# venv\Scripts\activate   # Windows
# 重新安装依赖
pip install -e .
```

### 环境变量配置错误

#### 常见错误

1. **SECRET_KEY未修改**：
```python
# config.py中的验证逻辑
if values.get("ENVIRONMENT") == "production":
    if v == "dev-secret-key-change-this-in-production-environment":
        raise ValueError("Must change default SECRET_KEY in production")
```

2. **数据库URL格式错误**：
```python
@validator("DATABASE_URL")
def validate_database_url(cls, v):
    if not v:
        raise ValueError("DATABASE_URL cannot be empty")
    return v
```

#### 验证步骤

1. 确保.env文件存在且格式正确
2. 检查环境变量名称拼写
3. 验证敏感信息是否已修改

**Section sources**
- [config.py](file://AI-agent-backend/app/core/config.py#L87-L127)
- [setup_test_env.sh](file://AI-agent-backend/setup_test_env.sh#L112-L172)
- [setup_test_env.bat](file://AI-agent-backend/setup_test_env.bat#L64-L120)