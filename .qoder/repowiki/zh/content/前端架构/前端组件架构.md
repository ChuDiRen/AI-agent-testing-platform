# 前端组件架构

<cite>
**本文档引用文件**  
- [CommonTable.vue](file://AI-agent-frontend/src/components/Common/CommonTable.vue)
- [FormDialog.vue](file://AI-agent-frontend/src/components/Common/FormDialog.vue)
- [SearchForm.vue](file://AI-agent-frontend/src/components/Common/SearchForm.vue)
- [MainLayout.vue](file://AI-agent-frontend/src/components/Layout/MainLayout.vue)
- [AppHeader.vue](file://AI-agent-frontend/src/components/Layout/AppHeader.vue)
- [AppSidebar.vue](file://AI-agent-frontend/src/components/Layout/AppSidebar.vue)
- [AppBreadcrumb.vue](file://AI-agent-frontend/src/components/Layout/AppBreadcrumb.vue)
- [PermissionWrapper.vue](file://AI-agent-frontend/src/components/Permission/PermissionWrapper.vue)
- [permission.ts](file://AI-agent-frontend/src/directives/permission.ts)
- [types.ts](file://AI-agent-frontend/src/api/types.ts)
- [system/user/Index.vue](file://AI-agent-frontend/src/views/system/user/Index.vue)
</cite>

## 目录
1. [通用组件架构](#通用组件架构)  
2. [布局组件架构](#布局组件架构)  
3. [权限控制组件](#权限控制组件)  
4. [组件集成与使用规范](#组件集成与使用规范)  
5. [最佳实践建议](#最佳实践建议)

## 通用组件架构

通用组件封装了常用UI功能，提升开发效率与一致性。主要包括 `CommonTable`、`FormDialog` 和 `SearchForm`。

### CommonTable 组件分析

`CommonTable` 封装了 Element Plus 的 `el-table`，提供高度可配置的表格展示与操作功能。

#### Props 定义
```typescript
interface TableProps {
  data: any[]                    // 表格数据
  columns: TableColumn[]         // 列配置
  loading?: boolean              // 加载状态
  showSelection?: boolean        // 显示多选
  showIndex?: boolean            // 显示序号
  showActions?: boolean          // 显示操作列
  actionWidth?: number | string  // 操作列宽度
  hideEdit?: boolean             // 隐藏编辑按钮
  hideDelete?: boolean           // 隐藏删除按钮
  stripe?: boolean               // 斑马纹
  border?: boolean               // 边框
  height?: number | string       // 高度
  maxHeight?: number | string    // 最大高度
  emptyText?: string             // 空数据文本
  rowKey?: string                // 树形表格键
  treeProps?: object             // 树形配置
  expandRowKeys?: any[]          // 展开行键
  defaultExpandAll?: boolean     // 默认展开所有
  showPagination?: boolean       // 显示分页
  pagination?: {                 // 分页数据
    page: number
    size: number
    total: number
  }
  pageSizes?: number[]           // 分页选项
  paginationLayout?: string      // 分页布局
  selectable?: (row: any, index: number) => boolean // 多选函数
}
```

#### Emits 事件
```typescript
defineEmits<{
  selectionChange: [selection: any[]]  // 多选变化
  sortChange: [sort: { column: any; prop: string; order: string }] // 排序变化
  rowClick: [row: any, column: any, event: Event] // 行点击
  rowDblClick: [row: any, column: any, event: Event] // 双击
  edit: [row: any, index: number]     // 编辑事件
  delete: [row: any, index: number]   // 删除事件
}>()
```

#### Slots 插槽
- **默认插槽**：用于自定义列内容，通过 `column.slot` 指定。
- **actions 插槽**：覆盖默认操作按钮，接收 `row` 和 `index`。

#### 使用示例
```vue
<CommonTable
  :data="tableData"
  :columns="columns"
  :pagination="pagination"
  @selection-change="handleSelection"
  @edit="handleEdit"
  @delete="handleDelete"
>
  <!-- 自定义操作列 -->
  <template #actions="{ row, index }">
    <el-button @click="handleAssignRole(row)">分配角色</el-button>
  </template>
</CommonTable>
```

**组件源码**
- [CommonTable.vue](file://AI-agent-frontend/src/components/Common/CommonTable.vue#L0-L320)

### FormDialog 组件分析

`FormDialog` 封装表单对话框，支持多种表单控件与验证。

#### Props 定义
```typescript
interface FormDialogProps {
  modelValue: boolean            // 双向绑定显示状态
  title: string                  // 对话框标题
  width?: string                 // 宽度
  fullscreen?: boolean           // 全屏
  modal?: boolean                // 是否有遮罩
  closeOnClickModal?: boolean    // 点击遮罩关闭
  closeOnPressEscape?: boolean   // 按ESC关闭
  showClose?: boolean            // 显示关闭按钮
  destroyOnClose?: boolean       // 关闭时销毁
  appendToBody?: boolean         // 添加到body
  fields: FormField[]            // 表单字段配置
  formData: Record<string, any>  // 表单数据
  rules?: Record<string, any[]>  // 表单规则
  labelWidth?: string            // 标签宽度
  labelPosition?: 'left'|'right'|'top' // 标签位置
  size?: 'small'|'default'|'large' // 尺寸
  formDisabled?: boolean         // 表单禁用
  gutter?: number                // 栅格间距
  defaultSpan?: number           // 默认列宽
}
```

#### Emits 事件
```typescript
defineEmits<{
  'update:modelValue': [value: boolean]
  confirm: [formData: Record<string, any>] // 确认提交
  cancel: []                              // 取消
  open: []                                // 打开
  opened: []                              // 打开后
  close: []                               // 关闭
  closed: []                              // 关闭后
}>()
```

#### 支持的表单控件
- `input`：输入框
- `number`：数字输入
- `select`：选择器
- `radio`：单选框
- `checkbox`：复选框
- `switch`：开关
- `date`：日期选择
- `upload`：上传
- `slot`：自定义插槽

**组件源码**
- [FormDialog.vue](file://AI-agent-frontend/src/components/Common/FormDialog.vue#L0-L436)

### SearchForm 组件分析

`SearchForm` 提供可折叠的搜索表单，支持多种输入控件。

#### Props 定义
```typescript
interface SearchFormProps {
  fields: SearchField[]           // 字段配置
  modelValue?: Record<string, any> // 初始值
  inline?: boolean                // 内联模式
  labelWidth?: string             // 标签宽度
  loading?: boolean               // 加载状态
  showToggle?: boolean            // 显示展开/收起
  toggleCount?: number            // 展开临界数量
}
```

#### Emits 事件
```typescript
defineEmits<{
  'update:modelValue': [value: Record<string, any>]
  search: [value: Record<string, any>]
  reset: []
}>()
```

#### 功能特性
- 支持 `input`、`select`、`date`、`daterange`、`number`、`tree-select`、`cascader` 等控件。
- 超过 `toggleCount` 个字段时自动折叠。
- 按回车键触发搜索。

**组件源码**
- [SearchForm.vue](file://AI-agent-frontend/src/components/Common/SearchForm.vue#L0-L316)

## 布局组件架构

布局组件构建了应用的整体结构，包括主布局、头部、侧边栏和面包屑。

### MainLayout 主布局

`MainLayout` 是应用的根布局组件，组织其他布局组件。

#### 结构组织
```vue
<div class="main-layout">
  <AppHeader />
  <div class="layout-container">
    <AppSidebar />
    <div class="main-content">
      <AppBreadcrumb />
      <div class="page-content">
        <router-view />
      </div>
    </div>
  </div>
</div>
```

#### 功能逻辑
- 在 `onMounted` 时检查用户登录状态，自动加载用户信息、权限和菜单。
- 使用 `systemStore.collapsed` 控制侧边栏折叠状态。

**组件源码**
- [MainLayout.vue](file://AI-agent-frontend/src/components/Layout/MainLayout.vue#L0-L98)

### AppHeader 应用头部

`AppHeader` 包含导航控制、全屏、通知和用户菜单。

#### 主要功能
- **折叠按钮**：调用 `systemStore.toggleCollapsed()` 切换侧边栏。
- **全屏切换**：使用 `document.fullscreenElement` API。
- **用户菜单**：提供个人中心、设置、退出登录。

**组件源码**
- [AppHeader.vue](file://AI-agent-frontend/src/components/Layout/AppHeader.vue#L0-L268)

### AppSidebar 应用侧边栏

`AppSidebar` 使用 `el-menu` 实现导航菜单。

#### 菜单结构
- 仪表板
- 系统管理（用户、角色、菜单、部门）
- 测试管理（用例、报告）
- AI代理管理（列表、配置）
- 日志管理

#### 折叠逻辑
- 通过 `systemStore.collapsed` 控制宽度（250px ↔ 64px）。
- 折叠时隐藏菜单文字，仅显示图标。

**组件源码**
- [AppSidebar.vue](file://AI-agent-frontend/src/components/Layout/AppSidebar.vue#L0-L276)

### AppBreadcrumb 面包屑导航

`AppBreadcrumb` 根据当前路由动态生成面包屑。

#### 实现逻辑
- 定义 `routeTitleMap` 映射路径与标题、图标。
- 通过 `useRoute()` 获取当前路径。
- 拆分路径，逐级构建面包屑项。

**组件源码**
- [AppBreadcrumb.vue](file://AI-agent-frontend/src/components/Layout/AppBreadcrumb.vue#L0-L130)

## 权限控制组件

权限控制通过 `PermissionWrapper` 组件和指令实现动态内容渲染。

### PermissionWrapper 组件

`PermissionWrapper` 是一个基于权限的条件渲染组件。

#### Props 定义
```typescript
interface PermissionProps {
  permission?: string | string[]  // 权限标识
  role?: string | string[]        // 角色标识
  mode?: 'some' | 'every'         // 匹配模式
  fallback?: string               // 回退内容
}
```

#### 权限检查逻辑
```typescript
const hasPermission = computed(() => {
  if (!userStore.isLoggedIn) return false
  if (userStore.hasRole('admin') || userStore.hasRole('super_admin')) return true
  
  let permissionCheck = true
  let roleCheck = true

  if (props.permission) {
    const permissions = Array.isArray(props.permission) ? props.permission : [props.permission]
    permissionCheck = props.mode === 'every' 
      ? permissions.every(perm => userStore.hasPermission(perm))
      : permissions.some(perm => userStore.hasPermission(perm))
  }

  if (props.role) {
    const roles = Array.isArray(props.role) ? props.role : [props.role]
    roleCheck = props.mode === 'every'
      ? roles.every(role => userStore.hasRole(role))
      : roles.some(role => userStore.hasRole(role))
  }

  if (props.permission && props.role) {
    return permissionCheck && roleCheck
  }
  return props.permission ? permissionCheck : roleCheck
})
```

#### 使用示例
```vue
<PermissionWrapper permission="user:add">
  <el-button>新增用户</el-button>
</PermissionWrapper>

<PermissionWrapper role="admin" fallback="仅管理员可见">
  <div>管理员内容</div>
</PermissionWrapper>
```

**组件源码**
- [PermissionWrapper.vue](file://AI-agent-frontend/src/components/Permission/PermissionWrapper.vue#L0-L90)

### 权限指令

`v-permission` 和 `v-role` 指令提供更灵活的权限控制。

#### 指令用法
```vue
<!-- 单个权限 -->
<el-button v-permission="'user:add'">新增</el-button>

<!-- 多个权限（任一匹配） -->
<el-button v-permission="['user:add', 'user:edit']">操作</el-button>

<!-- 多个权限（全部匹配） -->
<el-button v-permission:every="['user:add', 'user:edit']">高级操作</el-button>

<!-- 角色控制 -->
<el-button v-role="'admin'">管理员操作</el-button>

<!-- 隐藏而非移除 -->
<el-button v-permission.hidden="'user:delete'">删除</el-button>
```

#### 指令实现
- `checkPermission` 函数调用 `userStore.hasPermission()`。
- `mounted` 和 `updated` 钩子中执行权限检查。
- 支持 `.hidden` 修饰符，使用 `visibility: hidden` 保留占位。

**指令源码**
- [permission.ts](file://AI-agent-frontend/src/directives/permission.ts#L0-L207)

## 组件集成与使用规范

### 在视图中的集成

以用户管理页面为例：

```vue
<template>
  <!-- 搜索表单 -->
  <SearchForm
    :fields="searchFields"
    v-model="searchForm"
    @search="handleSearch"
    @reset="handleReset"
  />

  <!-- 表格 -->
  <CommonTable
    :data="tableData"
    :columns="columns"
    :pagination="pagination"
    @edit="handleEdit"
    @delete="handleDelete"
  >
    <template #actions="{ row }">
      <PermissionWrapper permission="user:assignRole">
        <el-button @click="handleAssignRole(row)">分配角色</el-button>
      </PermissionWrapper>
    </template>
  </CommonTable>

  <!-- 表单对话框 -->
  <FormDialog
    v-model="dialogVisible"
    :title="isEdit ? '编辑用户' : '新增用户'"
    :fields="formFields"
    :form-data="formData"
    @confirm="handleSubmit"
  />
</template>
```

**视图示例**
- [system/user/Index.vue](file://AI-agent-frontend/src/views/system/user/Index.vue#L99-L151)

### 组件调用方式总结

| 组件 | Props | Emits | Slots |
|------|-------|-------|-------|
| CommonTable | data, columns, pagination | selectionChange, edit, delete | actions, 自定义列 |
| FormDialog | modelValue, fields, formData | update:modelValue, confirm | 自定义字段 |
| SearchForm | fields, modelValue | update:modelValue, search, reset | 自定义字段 |
| PermissionWrapper | permission, role, fallback | - | default, fallback |

## 最佳实践建议

1. **统一配置**：在 `types.ts` 中定义 `TableColumn`、`FormField`、`SearchField` 类型，确保类型安全。
2. **权限优先**：敏感操作必须使用 `PermissionWrapper` 或指令控制。
3. **响应式设计**：布局组件已支持移动端，确保内容区域适配小屏幕。
4. **性能优化**：
   - 大数据表格启用 `max-height` 和虚拟滚动。
   - 频繁更新的表单项使用 `v-model` 优化。
5. **错误处理**：在 `FormDialog` 提交时捕获异常并提示用户。
6. **可访问性**：为图标按钮添加 `aria-label`。
7. **国际化**：将按钮文本、提示语等提取为语言包。

通过合理使用这些组件，可快速构建功能完整、权限安全的企业级前端应用。