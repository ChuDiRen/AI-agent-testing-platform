# 前端架构

<cite>
**本文档引用的文件**  
- [main.ts](file://AI-agent-frontend/src/main.ts) - *已更新*
- [permission.ts](file://AI-agent-frontend/src/directives/permission.ts) - *权限控制逻辑*
- [permission.ts](file://AI-agent-frontend/src/utils/permission.ts) - *权限辅助工具*
- [PermissionWrapper.vue](file://AI-agent-frontend/src/components/Permission/PermissionWrapper.vue) - *权限包装组件*
- [user.ts](file://AI-agent-frontend/src/store/user.ts) - *用户状态管理*
- [index.ts](file://AI-agent-frontend/src/router/index.ts) - *路由配置与守卫*
- [http.ts](file://AI-agent-frontend/src/api/http.ts) - *HTTP请求封装与无感刷新实现*
- [user.ts](file://AI-agent-frontend/src/api/modules/user.ts) - *用户模块API定义*
- [Index.vue](file://AI-agent-frontend/src/views/system/user/Index.vue) - *用户管理界面实现*
</cite>

## 更新摘要
**变更内容**  
- 新增JWT无感刷新与请求去重机制说明
- 增加用户数据导出导入功能文档
- 更新API响应格式适配说明
- 修正侧边栏菜单与路由同步问题
- 补充文件下载与上传逻辑细节

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概览](#架构概览)
4. [详细组件分析](#详细组件分析)
5. [依赖分析](#依赖分析)

## 项目结构

AI代理测试平台前端采用基于Vue 3的现代化前端架构，遵循模块化、组件化的设计原则。项目结构清晰，职责分明，主要分为以下几个核心模块：

- **api**：统一管理所有HTTP请求，包含模块化API接口定义和基础请求封装
- **components**：可复用UI组件库，分为通用组件（Common）、布局组件（Layout）和权限组件（Permission）
- **directives**：自定义指令，实现权限控制等高级功能
- **router**：路由配置，管理页面导航和路由守卫
- **store**：状态管理，使用Pinia实现全局状态管理
- **utils**：工具函数库，包含权限处理、认证等通用工具
- **views**：页面视图，按功能模块组织

这种结构实现了关注点分离，提高了代码的可维护性和可扩展性。

```mermaid
graph TB
subgraph "前端架构"
A[views] --> |页面展示| B[components]
B --> |UI组件| C[directives]
C --> |权限控制| D[store]
D --> |状态管理| E[api]
E --> |HTTP请求| F[后端API]
G[router] --> |路由控制| A
G --> |路由守卫| D
end
```

**图示来源**  
- [main.ts](file://AI-agent-frontend/src/main.ts)
- [router/index.ts](file://AI-agent-frontend/src/router/index.ts)

**本节来源**  
- [main.ts](file://AI-agent-frontend/src/main.ts)

## 核心组件

前端架构的核心组件包括Vue 3组合式API、Pinia状态管理、Vue Router路由系统和自定义权限控制系统。这些组件协同工作，构建了一个现代化、可维护的前端应用。

应用入口文件`main.ts`负责初始化Vue应用，注册全局依赖，包括路由、状态管理、UI组件库和自定义指令。特别值得注意的是权限指令的注册，通过`setupPermissionDirectives(app)`将权限控制能力注入到Vue应用实例中。

```typescript
import { createApp } from 'vue'
import App from './App.vue'
import router from './router/index'
import pinia from "@/store/store"
import { setupPermissionDirectives } from '@/directives/permission'
import ElementPlus from 'element-plus'

const app = createApp(App)
app.use(router)
app.use(pinia)
app.use(ElementPlus, { locale: zhCn })
setupPermissionDirectives(app)
app.mount('#app')
```

**本节来源**  
- [main.ts](file://AI-agent-frontend/src/main.ts)

## 架构概览

整个前端架构采用分层设计模式，从上到下分为视图层、组件层、指令层、状态管理层和API层。各层之间通过清晰的接口进行通信，确保了系统的松耦合和高内聚。

```mermaid
graph TD
A[视图层 Views] --> B[组件层 Components]
B --> C[指令层 Directives]
C --> D[状态管理层 Store]
D --> E[API层]
F[路由层 Router] --> A
F --> D
D --> G[后端服务]
E --> G
```

**图示来源**  
- [main.ts](file://AI-agent-frontend/src/main.ts)
- [store/user.ts](file://AI-agent-frontend/src/store/user.ts)
- [router/index.ts](file://AI-agent-frontend/src/router/index.ts)

## 详细组件分析

### 权限指令分析

权限指令是前端权限控制系统的核心，通过Vue的自定义指令机制实现声明式的权限控制。`v-permission`和`v-role`指令允许开发者在模板中直接声明元素的访问权限。

```mermaid
classDiagram
class PermissionDirective {
+mounted(el, binding)
+updated(el, binding)
-checkPermission(permissions, mode)
-checkRole(roles, mode)
-hideElement(el)
-showElement(el)
}
class PermissionElement {
_originalDisplay : string
_originalVisibility : string
}
PermissionDirective --> PermissionElement : "操作"
PermissionDirective --> UserStore : "依赖"
```

**图示来源**  
- [directives/permission.ts](file://AI-agent-frontend/src/directives/permission.ts)
- [store/user.ts](file://AI-agent-frontend/src/store/user.ts)

**本节来源**  
- [directives/permission.ts](file://AI-agent-frontend/src/directives/permission.ts)

### 权限包装组件分析

`PermissionWrapper.vue`是一个基于组件的权限控制方案，提供了比指令更灵活的权限控制能力。它通过插槽机制，允许开发者自定义有权限和无权限时的显示内容。

```mermaid
sequenceDiagram
participant Component as PermissionWrapper
participant Store as UserStore
participant Template as 模板
Component->>Store : 获取用户状态
Store-->>Component : 返回用户信息、权限、角色
Component->>Component : 计算hasPermission
alt 有权限
Component->>Template : 显示默认插槽内容
else 无权限且有回退内容
Component->>Template : 显示回退插槽内容
else 无权限且无回退内容
Component->>Template : 不显示任何内容
end
```

**图示来源**  
- [components/Permission/PermissionWrapper.vue](file://AI-agent-frontend/src/components/Permission/PermissionWrapper.vue)
- [store/user.ts](file://AI-agent-frontend/src/store/user.ts)

**本节来源**  
- [components/Permission/PermissionWrapper.vue](file://AI-agent-frontend/src/components/Permission/PermissionWrapper.vue)

### 用户状态管理分析

用户状态管理使用Pinia实现，`useUserStore`是核心的状态管理模块，负责管理用户认证状态、权限、角色和菜单等关键信息。该模块通过getter提供计算属性，通过actions提供异步操作方法。

```mermaid
classDiagram
class UserStore {
+token : string | null
+userInfo : UserInfo | null
+permissions : string[]
+roles : string[]
+menus : MenuInfo[]
+loading : boolean
+isLoggedIn : boolean
+getToken : string | null
+username : string
+avatar : string
+hasRole(role) : boolean
+hasPermission(permission) : boolean
+login(username, password) : Promise<boolean>
+getUserInfo() : Promise<void>
+getUserPermissions() : Promise<void>
+getUserMenus() : Promise<void>
+logout() : Promise<void>
+refreshToken() : Promise<boolean>
}
class AuthApi {
+login(data) : Promise<Response>
+logout() : Promise<Response>
+refreshToken() : Promise<Response>
}
class UserApi {
+getUserById(id) : Promise<Response>
+getUserPermissions(id) : Promise<Response>
}
class MenuApi {
+getMenuTree() : Promise<Response>
}
UserStore --> AuthApi : "依赖"
UserStore --> UserApi : "依赖"
UserStore --> MenuApi : "依赖"
```

**图示来源**  
- [store/user.ts](file://AI-agent-frontend/src/store/user.ts)
- [api/modules/auth.ts](file://AI-agent-frontend/src/api/modules/auth.ts)
- [api/modules/user.ts](file://AI-agent-frontend/src/api/modules/user.ts)
- [api/modules/menu.ts](file://AI-agent-frontend/src/api/modules/menu.ts)

**本节来源**  
- [store/user.ts](file://AI-agent-frontend/src/store/user.ts)

### 路由守卫分析

路由守卫是前端权限控制的第一道防线，通过Vue Router的`beforeEach`全局前置守卫实现。它在每次路由跳转前进行权限检查，确保用户只能访问其有权限的页面。

```mermaid
flowchart TD
A[路由跳转开始] --> B{是否需要认证?}
B --> |否| C[设置页面标题]
B --> |是| D{已登录?}
D --> |否| E[显示登录提示]
E --> F[跳转到登录页]
D --> |是| G{有页面权限?}
G --> |否| H[显示权限不足提示]
H --> I[跳转到403页]
G --> |是| C
C --> J{是否访问登录页且已登录?}
J --> |是| K[跳转到首页]
J --> |否| L[允许路由跳转]
```

**图示来源**  
- [router/index.ts](file://AI-agent-frontend/src/router/index.ts)
- [store/user.ts](file://AI-agent-frontend/src/store/user.ts)

**本节来源**  
- [router/index.ts](file://AI-agent-frontend/src/router/index.ts)

### HTTP请求封装与无感刷新分析

`http.ts`文件实现了统一的HTTP请求封装，包含请求拦截、响应处理、错误处理、请求去重、短期缓存和JWT无感刷新机制。该模块通过axios拦截器实现自动的token刷新，当检测到401错误时，自动使用refresh_token获取新的access_token，并重试原请求。

```mermaid
sequenceDiagram
participant Client as 客户端
participant Interceptor as 请求拦截器
participant Server as 服务器
participant RefreshService as 刷新服务
Client->>Interceptor : 发起请求
Interceptor->>Interceptor : 添加Authorization头
Interceptor->>Server : 发送请求
Server-->>Interceptor : 返回401 Unauthorized
Interceptor->>RefreshService : 检查是否正在刷新
alt 正在刷新
Interceptor->>Client : 挂起请求，加入队列
else 未刷新
RefreshService->>Server : 使用refresh_token请求新token
Server-->>RefreshService : 返回新access_token
RefreshService->>Interceptor : 更新token
RefreshService->>Client : 重试原请求
end
```

**图示来源**  
- [api/http.ts](file://AI-agent-frontend/src/api/http.ts)
- [store/user.ts](file://AI-agent-frontend/src/store/user.ts)

**本节来源**  
- [api/http.ts](file://AI-agent-frontend/src/api/http.ts)

### 用户管理功能分析

用户管理模块实现了完整的用户数据导出导入功能，支持Excel格式。前端通过`exportUsers`和`importUsers`方法分别处理文件下载和上传逻辑。导出功能支持选择导出选中数据或全部数据，导入功能支持新用户导入和已有用户更新两种模式。

```mermaid
flowchart LR
A[用户管理界面] --> B[导出数据]
A --> C[导入数据]
B --> D[选择导出范围]
D --> E[调用exportUsers]
E --> F[触发文件下载]
C --> G[选择导入模式]
G --> H[调用importUsers]
H --> I[上传文件到服务器]
I --> J[处理导入结果]
```

**图示来源**  
- [views/system/user/Index.vue](file://AI-agent-frontend/src/views/system/user/Index.vue)
- [api/modules/user.ts](file://AI-agent-frontend/src/api/modules/user.ts)

**本节来源**  
- [views/system/user/Index.vue](file://AI-agent-frontend/src/views/system/user/Index.vue)

## 依赖分析

前端各组件之间存在清晰的依赖关系，形成了一个层次分明的依赖树。核心依赖关系如下：

```mermaid
graph TD
A[main.ts] --> B[App.vue]
A --> C[router]
A --> D[pinia]
A --> E[permission指令]
C --> F[views]
D --> G[userStore]
E --> G
F --> H[components]
H --> E
G --> I[api模块]
I --> J[http.ts]
J --> K[用户数据导出导入]
```

这种依赖结构确保了应用的可维护性和可测试性。每个模块都有明确的职责和依赖，降低了模块间的耦合度。

**图示来源**  
- [main.ts](file://AI-agent-frontend/src/main.ts)
- [router/index.ts](file://AI-agent-frontend/src/router/index.ts)
- [store/index.ts](file://AI-agent-frontend/src/store/index.ts)

**本节来源**  
- [main.ts](file://AI-agent-frontend/src/main.ts)
- [router/index.ts](file://AI-agent-frontend/src/router/index.ts)
- [store/index.ts](file://AI-agent-frontend/src/store/index.ts)