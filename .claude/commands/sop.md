# /sop - 全闭环开发流程

## 描述

智能开发 SOP（Standard Operating Procedure），实现从需求到部署的完整闭环流程。

用户只需描述想要的功能，系统自动完成：
```
需求分析 → 设计 → 开发 → 测试 → 文档 → 部署 → 验收
```

## 使用方式

```
/sop <功能描述> [--options]
```

### 快速开始
```bash
/sop 用户管理模块                      # 完整 SOP 流程
/sop 订单系统 --no-deploy              # 跳过部署阶段
/sop 支付功能 --phase design           # 仅执行设计阶段
/sop 报表功能 --resume sop-001         # 恢复之前的 SOP
```

### 参数说明
| 参数 | 说明 | 默认值 |
|------|------|--------|
| `功能描述` | 要实现的功能需求 | 必填 |
| `--resume <id>` | 恢复指定 SOP | - |
| `--phase <阶段>` | 仅执行指定阶段 | - |
| `--no-deploy` | 跳过部署阶段 | false |
| `--no-test` | 跳过测试阶段 | false |
| `--interactive` | 交互式确认每个阶段 | false |
| `--agent` | 使用 Agent 模式 | false |

---

## SOP 流程架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           🔄 全闭环 SOP 流程                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 1.需求  │───▶│ 2.设计  │───▶│ 3.开发  │───▶│ 4.测试  │───▶│ 5.部署  │  │
│  │ 分析    │    │ 方案    │    │ 实现    │    │ 验证    │    │ 上线    │  │
│  └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘    └────┬────┘  │
│       │              │              │              │              │        │
│       ▼              ▼              ▼              ▼              ▼        │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│  │ 需求    │    │ 架构    │    │ 后端    │    │ 单元    │    │ Docker  │  │
│  │ 文档    │    │ 设计    │    │ 前端    │    │ 集成    │    │ CI/CD   │  │
│  │         │    │ API     │    │ 代码    │    │ E2E     │    │ 文档    │  │
│  │         │    │ 数据库  │    │         │    │ 性能    │    │         │  │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 6.验收 - 功能验证 + 文档完善 + 知识沉淀                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 各阶段详解

### 阶段 1：需求分析

**目标**：理解用户需求，输出明确的需求文档

**执行步骤**：
1. 分析用户需求描述
2. 识别功能边界和约束条件
3. 确定技术可行性
4. 输出需求文档

**输出**：
```
📋 需求分析报告
├── 功能概述
├── 用户故事
├── 功能边界
├── 约束条件
├── 验收标准
└── 风险评估
```

**参考**：`.claude/templates/requirement-template.md`

---

### 阶段 2：设计方案

**目标**：输出完整的技术设计方案

**执行步骤**：
1. 架构设计（模块划分、层次设计）
2. API 设计（接口定义、数据模型）
3. 数据库设计（表结构、索引、关系）
4. 前端设计（页面结构、组件设计）
5. 安全设计（权限、加密、防护）

**输出**：
```
📐 设计方案文档
├── 架构图
├── API 接口列表
├── 数据库 ER 图
├── 前端页面结构
├── 时序图
└── 安全方案
```

**参考**：
- `.claude/templates/design-template.md`
- `.claude/skills/architecture-design/SKILL.md`

---

### 阶段 3：开发实现

**目标**：生成完整的前后端代码

**执行步骤**：
1. 后端开发（Model → Schema → Service → Controller）
2. 前端开发（页面组件、API 封装、路由配置）
3. 代码质量检查
4. 代码审查

**输出**：
```
💻 代码文件
├── 后端
│   ├── model/
│   ├── schemas/
│   ├── service/
│   └── api/
└── 前端
    ├── views/
    ├── components/
    ├── api/
    └── router/
```

**参考**：
- `.claude/plugins/fullstack/crud-development-skill.md`
- `.claude/plugins/fullstack/ui-pc-skill.md`

---

### 阶段 4：测试验证

**目标**：确保代码质量和功能正确性

**执行步骤**：
1. 单元测试
2. 集成测试（API 测试）
3. E2E 测试
4. 性能测试
5. 安全扫描

**输出**：
```
🧪 测试报告
├── 单元测试覆盖率
├── API 测试结果
├── E2E 测试结果
├── 性能测试报告
└── 安全扫描报告
```

**参考**：
- `.claude/skills/api-testing/SKILL.md`
- `.claude/skills/unit-testing/SKILL.md`

---

### 阶段 5：部署上线

**目标**：生成部署配置和 CI/CD 流水线

**执行步骤**：
1. Docker 容器化配置
2. CI/CD 流水线配置
3. 环境变量配置
4. Nginx 配置
5. 部署文档编写

**输出**：
```
🚀 部署配置
├── Dockerfile (前端/后端)
├── docker-compose.yml
├── CI/CD 配置
├── Nginx 配置
└── 部署文档
```

**参考**：
- `.claude/commands/deploy.md`
- `.claude/skills/docker-deploy/SKILL.md`
- `.claude/skills/ci-cd/SKILL.md`

---

### 阶段 6：验收交付

**目标**：验证功能完整性，交付完整文档

**执行步骤**：
1. 功能验证（冒烟测试）
2. API 文档生成
3. 用户文档编写
4. 知识库沉淀
5. 交付报告

**输出**：
```
✅ 交付清单
├── 功能验证报告
├── API 文档
├── 用户手册
├── 技术文档
├── 变更记录
└── SOP 总结
```

**参考**：
- `.claude/agents/api-documenter.md`

---

## 执行模式

### 1. 自动模式（默认）
```
/sop 用户管理
```
系统自动按顺序执行所有阶段，无需人工干预。

### 2. 交互模式
```
/sop 用户管理 --interactive
```
每个阶段完成后暂停，等待用户确认后继续。

### 3. 分阶段执行
```
/sop 用户管理 --phase design
```
仅执行指定阶段。

### 4. 恢复模式
```
/sop --resume sop-001
```
从之前保存的 SOP 状态继续执行。

---

## 状态跟踪

SOP 执行过程中会生成状态文件：

```
.claude/sops/
├── sop-001/
│   ├── meta.json           # SOP 元信息
│   ├── 01-requirement.md   # 需求文档
│   ├── 02-design.md        # 设计文档
│   ├── 03-development.md   # 开发记录
│   ├── 04-testing.md       # 测试报告
│   ├── 05-deployment.md    # 部署配置
│   └── 06-delivery.md      # 交付文档
└── active                  # 当前活动的 SOP
```

---

## 完整示例

### 输入
```bash
/sop 我需要一个用户管理模块，支持用户增删改查，需要有分页、搜索功能
```

### 输出
```
╔════════════════════════════════════════════════════════════════════════════╗
║                            📋 SOP 启动                                     ║
╠════════════════════════════════════════════════════════════════════════════╣
║  ID: sop-001                                                             ║
║  功能: 用户管理模块                                                       ║
║  阶段: 6 个                                                               ║
╚════════════════════════════════════════════════════════════════════════════╝

[1/6] 需求分析...
  ✓ 功能概述已生成
  ✓ 用户故事已定义
  ✓ 验收标准已确定
  → 输出: .claude/sops/sop-001/01-requirement.md

[2/6] 设计方案...
  ✓ 架构设计完成
  ✓ API 接口设计完成（5 个接口）
  ✓ 数据库设计完成（1 张表）
  → 输出: .claude/sops/sop-001/02-design.md

[3/6] 开发实现...
  ✓ 后端代码生成完成
    - model/userModel.py
    - schemas/UserSchema.py
    - service/userService.py
    - api/UserController.py
  ✓ 前端代码生成完成
    - views/user/UserList.vue
    - views/user/UserForm.vue
    - views/user/user.js
  ✓ 代码审查通过
  → 输出: .claude/sops/sop-001/03-development.md

[4/6] 测试验证...
  ✓ 单元测试完成（覆盖率 85%）
  ✓ API 测试通过（5/5）
  ✓ E2E 测试通过（3/3）
  ✓ 性能测试通过
  → 输出: .claude/sops/sop-001/04-testing.md

[5/6] 部署配置...
  ✓ Dockerfile 生成
  ✓ docker-compose.yml 生成
  ✓ CI/CD 配置生成
  → 输出: .claude/sops/sop-001/05-deployment.md

[6/6] 验收交付...
  ✓ 功能验证通过
  ✓ API 文档生成
  ✓ 用户手册生成
  → 输出: .claude/sops/sop-001/06-delivery.md

╔════════════════════════════════════════════════════════════════════════════╗
║                         ✅ SOP 完成                                        ║
╠════════════════════════════════════════════════════════════════════════════╣
║  耗时: 约 5 分钟                                                           ║
║  文件: 15 个                                                               ║
║  测试覆盖: 85%                                                             ║
╠════════════════════════════════════════════════════════════════════════════╣
║  📁 所有文档保存在: .claude/sops/sop-001/                                 ║
║  🚀 开始部署: cd .claude/sops/sop-001 && cat 05-deployment.md             ║
╚════════════════════════════════════════════════════════════════════════════╝
```

---

## 与其他命令的协作

| 场景 | 推荐命令 | 说明 |
|------|----------|------|
| 快速 CRUD | `/crud` | 仅生成代码，无设计文档 |
| 纯后端开发 | `/dev --scope backend` | 仅后端 |
| 纯前端开发 | `/dev --scope frontend` | 仅前端 |
| 仅测试 | `/test` | 生成测试用例 |
| 仅部署 | `/deploy` | 生成部署配置 |
| **完整功能** | **`/sop`** | **全闭环流程** |

---

## 注意事项

1. **代码质量**：每步都会进行代码检查和审查
2. **可追溯性**：所有决策和输出都有文档记录
3. **可恢复性**：支持中断恢复，不会丢失进度
4. **可定制性**：支持跳过某些阶段或仅执行特定阶段
5. **可扩展性**：新阶段和功能可灵活添加
