# 代码审查模板库

本文件包含代码审查清单和输出格式，供审查相关插件引用。

## 审查清单

### 代码规范
| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 命名规范 | 变量/函数/类命名是否清晰 | 🟡 建议 |
| 代码重复 | 是否存在重复代码 | 🟠 警告 |
| 函数长度 | 单函数是否超过 50 行 | 🟠 警告 |
| 注释完整 | 复杂逻辑是否有注释 | 🟡 建议 |
| 类型注解 | Python/TS 是否有类型 | 🟡 建议 |

### 代码质量
| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| 异常处理 | try-catch 是否完善 | 🟠 警告 |
| 空值检查 | 是否处理 null/undefined | 🟠 警告 |
| 边界条件 | 数组越界、除零等 | 🔴 严重 |
| 资源释放 | 连接/文件是否关闭 | 🔴 严重 |
| 死代码 | 未使用的变量/函数 | 🟡 建议 |

### 性能问题
| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| N+1 查询 | 循环中数据库查询 | 🔴 严重 |
| 缺少索引 | 大表无索引查询 | 🟠 警告 |
| 内存泄漏 | 未释放的引用 | 🔴 严重 |
| 阻塞操作 | 同步 IO 阻塞主线程 | 🟠 警告 |
| 无效渲染 | 前端重复渲染 | 🟠 警告 |

### 安全问题
| 检查项 | 说明 | 严重级别 |
|--------|------|----------|
| SQL 注入 | 字符串拼接 SQL | 🔴 严重 |
| XSS | 未转义用户输入 | 🔴 严重 |
| 硬编码密钥 | 代码中的密码/密钥 | 🔴 严重 |
| 敏感日志 | 日志中的敏感信息 | 🟠 警告 |
| CSRF | 缺少 CSRF 防护 | 🟠 警告 |

---

## 常见问题模式

### N+1 查询问题

❌ **问题代码**
```python
# 循环中查询
users = session.exec(select(User)).all()
for user in users:
    orders = session.exec(select(Order).where(Order.user_id == user.id)).all()
```

✅ **优化代码**
```python
# 使用 JOIN 或预加载
from sqlmodel import selectinload
statement = select(User).options(selectinload(User.orders))
users = session.exec(statement).all()
```

---

### 前端重复渲染

❌ **问题代码**
```vue
<script setup>
// 每次渲染都创建新对象
const options = { a: 1, b: 2 }
</script>
```

✅ **优化代码**
```vue
<script setup>
import { computed, ref } from 'vue'
// 使用 ref 或 computed 缓存
const options = ref({ a: 1, b: 2 })
</script>
```

---

### 异常处理不完善

❌ **问题代码**
```python
try:
    result = risky_operation()
except:
    pass  # 吞掉异常
```

✅ **优化代码**
```python
try:
    result = risky_operation()
except SpecificError as e:
    logger.error(f"Operation failed: {e}")
    raise HTTPException(status_code=500, detail="操作失败")
```

---

## 输出报告格式

```
╔══════════════════════════════════════════════════════════════════╗
║                    📋 代码审查报告                                ║
╠══════════════════════════════════════════════════════════════════╣
║  📊 审查统计                                                      ║
║  ─────────────────────────────────────────────────────────────   ║
║  文件: 12    问题: 8    严重: 2    警告: 4    建议: 2             ║
╠══════════════════════════════════════════════════════════════════╣
║  🔴 严重问题 (2)                                                  ║
║  ─────────────────────────────────────────────────────────────   ║
║  [性能] userService.py:45 - N+1 查询问题                          ║
║         建议：使用 selectinload 预加载关联数据                     ║
║                                                                  ║
║  [安全] authController.py:23 - SQL 注入风险                       ║
║         建议：使用参数化查询                                       ║
╠══════════════════════════════════════════════════════════════════╣
║  🟡 警告 (4)                                                      ║
║  ─────────────────────────────────────────────────────────────   ║
║  [规范] UserList.vue:10 - 缺少 key 属性                           ║
║  [规范] utils.py:30 - 函数超过 50 行                              ║
║  [质量] config.py:15 - 异常被吞掉                                 ║
║  [质量] api.js:8 - 未处理 Promise rejection                       ║
╠══════════════════════════════════════════════════════════════════╣
║  🔵 建议 (2)                                                      ║
║  ─────────────────────────────────────────────────────────────   ║
║  [优化] userService.py:30 - 可提取为公共方法                      ║
║  [规范] model.py:5 - 建议添加类型注解                             ║
╚══════════════════════════════════════════════════════════════════╝
```

---

## 审查模式说明

| 模式 | 检查范围 | 耗时 |
|------|----------|------|
| `quick` | 代码规范 + 明显问题 | 1-2 分钟 |
| `full` | 规范 + 质量 + 性能 + 安全 | 3-5 分钟 |
| `security` | 仅安全检查 | 2-3 分钟 |
| `performance` | 仅性能检查 | 2-3 分钟 |
