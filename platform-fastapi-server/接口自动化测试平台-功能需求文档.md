# 接口自动化测试平台 - 功能需求文档

## 一、系统概述

这是一个接口自动化测试平台，支持API接口的管理、测试用例编排、测试计划执行、测试报告生成等功能。

### 技术栈

| 层级 | 技术选型 |
|------|---------|
| 后端框架 | FastAPI + SQLModel |
| 前端框架 | Vue3 + Element Plus |
| 数据库 | MySQL |
| 消息队列 | RabbitMQ |
| 缓存 | Redis |
| 测试报告 | Allure |
| 执行引擎 | api-engine (关键字驱动) |

### 系统特性

- **关键字驱动**：支持自定义关键字，灵活扩展测试能力
- **数据驱动**：支持DDT数据驱动测试，一个用例多组数据
- **异步执行**：基于消息队列的异步任务执行
- **多引擎支持**：支持API、Web、性能等多种测试引擎
- **CI/CD集成**：提供Jenkins Pipeline配置，支持持续集成
- **消息通知**：支持企业微信、钉钉、飞书机器人通知

---

## 二、功能模块需求

### 1. 项目管理模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| PRJ-001 | 项目列表 | 分页查询所有项目，支持筛选 |
| PRJ-002 | 新增项目 | 创建新的测试项目 |
| PRJ-003 | 编辑项目 | 修改项目信息 |
| PRJ-004 | 删除项目 | 删除指定项目 |
| PRJ-005 | 查询所有项目 | 获取所有项目列表（用于下拉选择） |

**数据模型**：
- `id` - 项目编号
- `project_name` - 项目名称
- `project_desc` - 项目描述
- `create_time` - 创建时间

---

### 2. 数据库配置管理模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| DB-001 | 数据库配置列表 | 分页查询数据库配置，支持按项目和名称筛选 |
| DB-002 | 新增数据库配置 | 添加数据库连接配置，引用名称唯一校验 |
| DB-003 | 编辑数据库配置 | 修改数据库连接信息 |
| DB-004 | 删除数据库配置 | 删除指定数据库配置 |
| DB-005 | 启用/禁用配置 | 控制数据库配置是否在测试中生效 |

**数据模型**：
- `id` - 配置编号
- `project_id` - 所属项目ID
- `connect_name` - 连接名称
- `ref_name` - 引用名称（唯一）
- `db_info` - 数据库连接信息（JSON格式）
- `is_enabled` - 是否启用

---

### 3. 接口信息管理模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| API-001 | 接口列表 | 分页查询接口，支持按项目、模块、名称筛选 |
| API-002 | 新增接口 | 创建新的API接口定义 |
| API-003 | 编辑接口 | 修改接口信息 |
| API-004 | 删除接口 | 删除指定接口 |
| API-005 | 接口调试 | 发送请求并查看响应结果 |
| API-006 | 发送并下载 | 发送请求并下载响应文件 |
| API-007 | Swagger导入 | 从Swagger JSON URL批量导入接口定义 |

**数据模型**：
- `id` - 接口编号
- `project_id` - 所属项目ID
- `api_name` - 接口名称
- `request_method` - 请求方法（GET/POST/PUT/DELETE/PATCH等）
- `request_url` - 请求URL
- `request_params` - URL参数（JSON数组）
- `request_headers` - 请求头（JSON数组）
- `request_form_datas` - form-data参数
- `request_www_form_datas` - x-www-form-urlencoded参数
- `requests_json_data` - JSON请求体
- `request_files` - 文件上传参数
- `debug_vars` - 调试变量定义

**接口调试功能详情**：
- 支持多种请求方式：POST、GET、DELETE、PUT、PATCH、COPY、HEAD、OPTIONS
- 支持多种请求体格式：form-data、x-www-form-urlencoded、JSON、文件上传
- 支持变量定义和引用
- 调试结果展示：请求URL、请求方式、请求头、请求数据、响应数据

---

### 4. 关键字管理模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| KW-001 | 关键字列表 | 分页查询关键字，支持按名称和操作类型筛选 |
| KW-002 | 新增关键字 | 创建新关键字，方法名唯一校验 |
| KW-003 | 编辑关键字 | 修改关键字信息 |
| KW-004 | 删除关键字 | 删除指定关键字 |
| KW-005 | 生成关键字文件 | 将关键字代码生成为Python文件 |
| KW-006 | 级联查询关键字 | 按操作类型分组返回关键字树形数据 |

**数据模型**：
- `id` - 关键字编号
- `name` - 关键字名称
- `keyword_desc` - 关键字参数描述（JSON格式）
- `operation_type_id` - 操作类型ID
- `keyword_fun_name` - 方法名（唯一）
- `keyword_value` - 方法体代码
- `is_enabled` - 是否启用

**内置关键字**：
- `send_request` - 发送HTTP请求
- `send_request_and_download` - 发送请求并下载响应

---

### 5. 操作类型管理模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| OT-001 | 操作类型列表 | 查询所有操作类型 |
| OT-002 | 新增操作类型 | 创建新的操作类型分类 |
| OT-003 | 编辑操作类型 | 修改操作类型信息 |
| OT-004 | 删除操作类型 | 删除指定操作类型 |

**数据模型**：
- `id` - 操作类型编号
- `operation_type_name` - 操作类型名称
- `ex_fun_name` - 扩展方法名

---

### 6. 测试用例管理模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| CASE-001 | 用例列表 | 分页查询测试用例，支持按项目和名称筛选 |
| CASE-002 | 新增用例 | 创建新的测试用例 |
| CASE-003 | 编辑用例 | 修改用例基本信息 |
| CASE-004 | 删除用例 | 删除指定用例 |
| CASE-005 | 调试执行 | 执行单个测试用例并生成Allure报告 |
| CASE-006 | XMind导入 | 从XMind文件批量导入测试用例和步骤（已实现） |
| CASE-007 | 变量定义 | 定义用例级别的变量 |
| CASE-008 | 前置脚本 | 配置用例执行前的Python脚本 |
| CASE-009 | 后置脚本 | 配置用例执行后的Python脚本 |

**数据模型**：
- `id` - 用例编号
- `project_id` - 所属项目ID
- `module_id` - 所属模块ID
- `case_name` - 用例名称
- `case_desc` - 用例描述
- `param_data` - 调试变量（JSON数组）
- `pre_request` - 执行前事件脚本
- `post_request` - 执行后事件脚本

---

### 7. 测试步骤管理模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| STEP-001 | 步骤列表 | 查询用例关联的测试步骤，按执行顺序排序 |
| STEP-002 | 新增步骤 | 添加测试步骤，关联关键字 |
| STEP-003 | 编辑步骤 | 修改步骤信息和参数 |
| STEP-004 | 删除步骤 | 删除指定步骤 |
| STEP-005 | 调整顺序 | 修改步骤执行顺序 |
| STEP-006 | 参数配置 | 配置关键字所需的参数值 |

**数据模型**：
- `id` - 步骤编号
- `api_case_info_id` - 所属用例ID
- `key_word_id` - 关联关键字ID
- `step_desc` - 步骤描述
- `ref_variable` - 关键字参数值（JSON格式）
- `run_order` - 执行顺序

**特殊参数类型**：
- `_接口信息` - 关联接口信息下拉选择
- `_数据库` - 关联数据库配置下拉选择

---

### 8. 测试计划管理模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| PLAN-001 | 计划列表 | 分页查询测试计划，支持按项目和名称筛选 |
| PLAN-002 | 新增计划 | 创建新的测试计划 |
| PLAN-003 | 编辑计划 | 修改计划基本信息 |
| PLAN-004 | 删除计划 | 删除指定计划 |
| PLAN-005 | 复制计划 | 复制测试计划及关联用例（已实现） |
| PLAN-006 | 执行计划 | 执行测试计划，生成测试报告 |
| PLAN-007 | 用例维护 | 添加/删除/排序计划中的测试用例 |
| PLAN-008 | 环境变量配置 | 配置计划级别的全局变量 |
| PLAN-009 | Jenkins配置 | 提供CI/CD集成接口信息（已实现） |
| PLAN-010 | 机器人通知配置 | 配置执行完成后的消息通知 |

**数据模型**：
- `id` - 计划编号
- `project_id` - 所属项目ID
- `collection_name` - 计划名称
- `collection_desc` - 计划描述
- `collection_env` - 全局环境变量（JSON数组）

---

### 9. 测试计划详情模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| DET-001 | 详情列表 | 查询计划关联的用例列表，按执行顺序排序 |
| DET-002 | 添加用例 | 将测试用例添加到计划中 |
| DET-003 | 删除用例 | 从计划中移除用例 |
| DET-004 | 调整顺序 | 修改用例执行顺序 |
| DET-005 | DDT数据驱动 | 为用例配置多组测试数据 |

**DDT数据驱动功能**：
- 支持为单个用例配置多组测试数据
- 每组数据包含desc描述和多个变量键值对
- 执行时自动遍历所有数据组

---

### 10. 测试报告与历史记录模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| RPT-001 | 历史记录列表 | 分页查询执行历史，按时间倒序 |
| RPT-002 | 查看报告 | 访问Allure HTML测试报告 |
| RPT-003 | 删除记录 | 删除指定历史记录 |

**数据模型**：
- `id` - 记录编号
- `collection_info_id` - 所属计划ID
- `history_desc` - 执行结果描述
- `history_detail` - 执行UUID（用于定位报告）
- `create_time` - 执行时间

---

### 11. 测试统计图表模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| CHT-001 | 执行次数统计 | 查询测试计划的执行次数 |
| CHT-002 | 用例数量统计 | 查询最近一次执行的用例数量 |
| CHT-003 | 通过率统计 | 计算测试计划的通过率百分比 |
| CHT-004 | 执行趋势图 | 查询最近5次执行结果趋势（passed/failed/broken/skipped） |
| CHT-005 | 耗时趋势图 | 查询最近10次执行耗时 |
| CHT-006 | 失败TOP5 | 查询失败次数最多的5个用例 |

---

### 12. 消息通知模块

| 需求编号 | 功能名称 | 功能描述 |
|---------|---------|---------|
| MSG-001 | 机器人管理 | 管理消息通知机器人 |
| MSG-002 | 关联机器人 | 为测试计划关联通知机器人 |
| MSG-003 | 启用/禁用 | 控制机器人是否发送通知 |
| MSG-004 | 消息发送 | 执行完成后自动发送通知 |

**支持的机器人类型**：
- 企业微信机器人
- 钉钉机器人
- 飞书机器人

---

## 三、核心执行引擎

### 1. 测试执行流程

```
1. 生成测试用例YAML文件
   ├── context.yaml（环境变量、数据库配置）
   └── {order}_{uuid}.yaml（测试用例）

2. 调用执行器执行测试

3. 生成Allure报告

4. 保存执行记录到历史记录表

5. 发送机器人通知
```

### 2. 异步执行支持

- 使用消息队列实现异步执行
- 支持多队列、多线程消费
- 任务状态实时更新

### 3. 任务状态

- `等待中` - 任务已提交到队列
- `执行中` - 任务正在执行
- `执行完成` - 任务执行结束

---

## 四、接口规范

### 通用响应格式
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {},
  "total": 0
}
```

### 通用分页参数
```json
{
  "page": 1,
  "pageSize": 10
}
```

---

## 五、功能统计

| 模块 | 功能数量 | 核心能力 |
|------|---------|---------|
| 项目管理 | 5个 | 项目CRUD、项目列表查询 |
| 数据库配置 | 5个 | 数据库连接配置、启用/禁用 |
| 接口信息管理 | 7个 | 接口CRUD、调试执行、Swagger导入 |
| 关键字管理 | 6个 | 关键字CRUD、代码生成、级联查询 |
| 操作类型管理 | 4个 | 操作类型分类管理 |
| 测试用例管理 | 9个 | 用例CRUD、调试执行、XMind导入、前后置脚本 |
| 测试步骤管理 | 6个 | 步骤CRUD、参数配置、顺序调整 |
| 测试计划管理 | 10个 | 计划CRUD、执行、复制、环境变量、机器人通知 |
| 计划详情管理 | 5个 | 用例关联、DDT数据驱动 |
| 测试报告 | 3个 | 历史记录、Allure报告查看 |
| 统计图表 | 6个 | 执行次数、通过率、趋势图、失败TOP5 |
| 消息通知 | 4个 | 企业微信/钉钉/飞书机器人通知 |

**总计：70个功能需求**

---

## 六、API接口清单

### 1. 项目管理 (ApiProject)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 分页查询 | POST | /ApiProject/queryByPage | 分页查询项目列表 |
| 根据ID查询 | GET | /ApiProject/queryById | 查询单个项目 |
| 新增 | POST | /ApiProject/insert | 新增项目 |
| 更新 | PUT | /ApiProject/update | 更新项目 |
| 删除 | DELETE | /ApiProject/delete | 删除项目 |
| 查询所有 | GET | /ApiProject/queryAll | 获取所有项目 |

### 2. 数据库配置 (ApiDbBase)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 分页查询 | POST | /ApiDbBase/queryByPage | 分页查询配置 |
| 根据ID查询 | GET | /ApiDbBase/queryById | 查询单个配置 |
| 新增 | POST | /ApiDbBase/insert | 新增配置 |
| 更新 | PUT | /ApiDbBase/update | 更新配置 |
| 删除 | DELETE | /ApiDbBase/delete | 删除配置 |
| 启用/禁用 | PUT | /ApiDbBase/toggleEnabled | 切换启用状态 |
| 按项目查询 | GET | /ApiDbBase/queryByProject | 查询项目下的配置 |

### 3. 接口信息 (ApiInfo)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 分页查询 | POST | /ApiInfo/queryByPage | 分页查询接口 |
| 根据ID查询 | GET | /ApiInfo/queryById | 查询单个接口 |
| 新增 | POST | /ApiInfo/insert | 新增接口 |
| 更新 | PUT | /ApiInfo/update | 更新接口 |
| 删除 | DELETE | /ApiInfo/delete | 删除接口 |
| 接口调试 | POST | /ApiInfo/debug | 发送请求调试 |
| 调试并下载 | POST | /ApiInfo/debugAndDownload | 发送请求并下载 |
| Swagger导入 | POST | /ApiInfo/importSwagger | 导入Swagger文档 |

### 4. 测试用例 (ApiInfoCase)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 分页查询 | POST | /ApiInfoCase/queryByPage | 分页查询用例 |
| 根据ID查询 | GET | /ApiInfoCase/queryById | 查询用例详情(含步骤) |
| 新增 | POST | /ApiInfoCase/insert | 新增用例 |
| 更新 | PUT | /ApiInfoCase/update | 更新用例 |
| 删除 | DELETE | /ApiInfoCase/delete | 删除用例 |
| 执行用例 | POST | /ApiInfoCase/executeCase | 执行测试用例 |
| 执行状态 | GET | /ApiInfoCase/executionStatus | 查询执行状态 |
| XMind导入 | POST | /ApiInfoCase/importXMind | 从XMind导入用例 |

### 5. 测试计划 (ApiCollectionInfo)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 分页查询 | POST | /ApiCollectionInfo/queryByPage | 分页查询计划 |
| 根据ID查询 | GET | /ApiCollectionInfo/queryById | 查询计划详情 |
| 新增 | POST | /ApiCollectionInfo/insert | 新增计划 |
| 更新 | PUT | /ApiCollectionInfo/update | 更新计划 |
| 删除 | DELETE | /ApiCollectionInfo/delete | 删除计划 |
| 复制计划 | POST | /ApiCollectionInfo/copy | 复制测试计划 |
| Jenkins配置 | GET | /ApiCollectionInfo/getJenkinsConfig | 获取CI/CD配置 |
| 添加用例 | POST | /ApiCollectionInfo/addCase | 添加用例到计划 |
| 批量添加 | POST | /ApiCollectionInfo/batchAddCases | 批量添加用例 |
| 移除用例 | DELETE | /ApiCollectionInfo/removeCase | 从计划移除用例 |

### 6. 测试统计 (ApiStatistics)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 系统总览 | GET | /ApiStatistics/overview | 获取系统统计概览 |
| 执行次数 | GET | /ApiStatistics/executionCount | 查询执行次数 |
| 用例数量 | GET | /ApiStatistics/caseCount | 查询用例数量 |
| 通过率 | GET | /ApiStatistics/passRate | 查询通过率 |
| 执行趋势 | GET | /ApiStatistics/executionTrend | 查询执行趋势 |
| 耗时趋势 | GET | /ApiStatistics/timeTrend | 查询耗时趋势 |
| 失败TOP5 | GET | /ApiStatistics/failedTop5 | 查询失败TOP5 |
| 每日统计 | GET | /ApiStatistics/dailyStats | 查询每日统计 |

### 7. 机器人配置 (RobotConfig)

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 分页查询 | POST | /RobotConfig/queryByPage | 分页查询机器人 |
| 根据ID查询 | GET | /RobotConfig/queryById | 查询单个机器人 |
| 新增 | POST | /RobotConfig/insert | 新增机器人 |
| 更新 | PUT | /RobotConfig/update | 更新机器人 |
| 删除 | DELETE | /RobotConfig/delete | 删除机器人 |
| 启用/禁用 | PUT | /RobotConfig/toggleEnabled | 切换启用状态 |
| 测试连接 | POST | /RobotConfig/testConnection | 测试机器人连接 |

---

## 七、数据库表设计

### 1. 项目表 (t_api_project)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 项目编号 | 主键，自增 |
| project_name | VARCHAR(255) | 项目名称 | |
| project_desc | VARCHAR(255) | 项目描述 | |
| create_time | DATETIME | 创建时间 | |

---

### 2. 数据库配置表 (t_api_database)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 配置编号 | 主键，自增 |
| project_id | INT | 所属项目ID | 外键关联t_api_project |
| name | VARCHAR(255) | 连接名称 | |
| ref_name | VARCHAR(255) | 引用变量名（唯一） | |
| db_type | VARCHAR(255) | 数据库类型 | |
| db_info | VARCHAR(255) | 数据库连接信息（JSON） | |
| is_enabled | VARCHAR(255) | 是否启用（1/0） | |
| create_time | DATETIME | 创建时间 | |

---

### 3. 接口信息表 (t_api_info)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 接口编号 | 主键，自增 |
| project_id | INT | 所属项目ID | 外键关联t_api_project |
| api_name | VARCHAR(255) | 接口名称 | |
| request_method | VARCHAR(255) | 请求方法 | |
| request_url | VARCHAR(255) | 请求地址 | |
| request_params | VARCHAR(255) | URL参数（JSON数组） | |
| request_headers | TEXT | 请求头（JSON数组） | |
| debug_vars | TEXT | 调试变量（JSON数组） | |
| request_form_datas | VARCHAR(255) | form-data参数（JSON数组） | |
| request_www_form_datas | VARCHAR(255) | www-form-data参数（JSON数组） | |
| requests_json_data | VARCHAR(255) | JSON请求体 | |
| request_files | VARCHAR(255) | 文件列表（JSON数组） | |
| create_time | DATETIME | 创建时间 | |

---

### 4. 操作类型表 (t_api_operationtype)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 操作类型ID | 主键，自增 |
| operation_type_name | VARCHAR(255) | 操作类型名称 | |
| ex_fun_name | VARCHAR(255) | 操作类型方法名 | |
| create_time | DATETIME | 创建时间 | |

---

### 5. 关键字表 (t_api_keyword)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 关键字编号 | 主键，自增 |
| name | VARCHAR(255) | 关键字名称 | |
| keyword_desc | VARCHAR(255) | 关键字参数描述（JSON） | |
| operation_type_id | INT | 操作类型ID | 外键关联t_api_operationtype |
| keyword_fun_name | VARCHAR(255) | 方法名（唯一） | |
| keyword_value | VARCHAR(255) | 方法体代码 | |
| is_enabled | VARCHAR(255) | 是否启用 | |
| create_time | DATETIME | 创建时间 | |

---

### 6. 测试用例表 (t_api_info_case)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 用例编号 | 主键，自增 |
| project_id | INT | 所属项目ID | 外键关联t_api_project |
| module_id | INT | 所属模块ID | |
| case_name | VARCHAR(255) | 用例名称 | |
| case_desc | VARCHAR(255) | 用例描述 | |
| param_data | VARCHAR(255) | 调试变量（JSON数组） | |
| pre_request | VARCHAR(255) | 执行前事件脚本 | |
| post_request | VARCHAR(255) | 执行后事件脚本 | |
| debug_info | VARCHAR(255) | 调试信息 | |
| create_time | DATETIME | 创建时间 | |

---

### 7. 测试步骤表 (t_api_info_step)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 步骤编号 | 主键，自增 |
| api_case_info_id | INT | 所属用例ID | 外键关联t_api_info_case |
| key_word_id | INT | 关键字方法ID | 外键关联t_api_keyword |
| step_desc | VARCHAR(255) | 步骤描述 | |
| ref_variable | VARCHAR(255) | 引用变量（JSON） | |
| run_order | INT | 执行顺序 | |
| create_time | DATETIME | 创建时间 | |

---

### 8. 测试计划表 (t_api_collection_info)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 计划编号 | 主键，自增 |
| project_id | INT | 所属项目ID | 外键关联t_api_project |
| collection_name | VARCHAR(255) | 测试计划名称 | |
| collection_desc | VARCHAR(255) | 测试计划描述 | |
| collection_env | VARCHAR(255) | 全局环境变量（JSON数组） | |
| create_time | DATETIME | 创建时间 | |

---

### 9. 测试计划详情表 (t_api_collection_detail)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 详情编号 | 主键，自增 |
| collection_info_id | INT | 测试计划ID | 外键关联t_api_collection_info |
| api_case_info_id | INT | 测试用例ID | 外键关联t_api_info_case |
| ddt_param_data | TEXT | DDT数据驱动参数（JSON） | |
| run_order | INT | 执行顺序 | |
| create_time | DATETIME | 创建时间 | |

---

### 10. 执行历史表 (t_api_history)

| 字段名 | 类型 | 说明 | 约束 |
|--------|------|------|------|
| id | INT | 记录编号 | 主键 |
| collection_info_id | INT | 测试计划ID | 外键关联t_api_collection_info |
| history_desc | VARCHAR(255) | 运行记录简述 | |
| history_detail | VARCHAR(255) | 运行详细记录（执行UUID） | |
| create_time | DATETIME | 创建时间 | |

---

---

## 七、整体实现逻辑

### 1. 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Vue3)                              │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │项目管理 │ │接口管理 │ │用例管理 │ │计划管理 │ │报告统计 │   │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘   │
└───────┼──────────┼──────────┼──────────┼──────────┼───────────┘
        │          │          │          │          │
        ▼          ▼          ▼          ▼          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      后端 API (FastAPI)                          │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    RESTful API 层                        │    │
│  │  /ApiProject  /ApiInfo  /ApiInfoCase  /ApiCollectionInfo │    │
│  └─────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    业务逻辑层                            │    │
│  │  数据校验 → 业务处理 → 用例生成 → 测试执行 → 报告生成    │    │
│  └─────────────────────────────────────────────────────────┘    │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    数据访问层 (SQLModel)                 │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────┐  ┌─────────────────┐  ┌─────────────────────┐
│   MySQL       │  │   RabbitMQ      │  │   Redis             │
│   数据存储    │  │   消息队列      │  │   任务状态缓存      │
└───────────────┘  └─────────────────┘  └─────────────────────┘
                           │
                           ▼
                   ┌───────────────┐
                   │ 测试执行引擎  │
                   │ huace-apirun  │
                   └───────┬───────┘
                           │
                           ▼
                   ┌───────────────┐
                   │ Allure 报告   │
                   └───────────────┘
```

---

### 2. 核心业务流程

#### 2.1 接口调试流程

```
用户操作                        后端处理                          执行引擎
   │                              │                                │
   │  1.填写接口信息              │                                │
   │  (URL/Method/Params/Body)    │                                │
   │                              │                                │
   │  2.点击"发送请求"            │                                │
   ├─────────────────────────────>│                                │
   │                              │  3.解析请求参数                │
   │                              │  4.生成context.yaml            │
   │                              │  5.生成测试用例yaml            │
   │                              ├───────────────────────────────>│
   │                              │                                │  6.执行测试
   │                              │                                │  7.发送HTTP请求
   │                              │<───────────────────────────────│
   │                              │  8.解析执行结果                │
   │<─────────────────────────────│                                │
   │  9.显示响应结果              │                                │
   │  (状态/请求头/响应体)        │                                │
```

**实现逻辑**：
1. 前端收集接口信息（URL、请求方法、参数、请求头、请求体）
2. 调用 `/ApiInfo/debug` 接口
3. 后端生成临时执行目录，创建 `context.yaml`（变量配置）和测试用例 YAML 文件
4. 调用 `huace-apirun` 执行器执行测试
5. 解析执行输出，提取响应数据
6. 返回调试结果给前端展示

---

#### 2.2 测试用例执行流程

```
用户操作                        后端处理                          执行引擎
   │                              │                                │
   │  1.选择测试用例              │                                │
   │  2.点击"调试执行"            │                                │
   ├─────────────────────────────>│                                │
   │                              │  3.查询用例信息                │
   │                              │  4.查询用例步骤                │
   │                              │  5.查询关键字信息              │
   │                              │  6.查询数据库配置              │
   │                              │                                │
   │                              │  7.生成context.yaml            │
   │                              │     - 调试变量                 │
   │                              │     - 数据库配置               │
   │                              │                                │
   │                              │  8.生成测试用例yaml            │
   │                              │     - desc: 用例名称           │
   │                              │     - pre_script: 前置脚本     │
   │                              │     - steps: 测试步骤          │
   │                              │     - post_script: 后置脚本    │
   │                              │                                │
   │                              ├───────────────────────────────>│
   │                              │                                │  9.执行测试
   │                              │                                │  10.生成Allure数据
   │                              │<───────────────────────────────│
   │                              │  11.生成HTML报告               │
   │<─────────────────────────────│                                │
   │  12.打开测试报告页面         │                                │
```

**实现逻辑**：
1. 前端发送用例ID到 `/ApiInfoCase/debugTest` 接口
2. 后端查询用例信息、测试步骤、关键字配置、数据库配置
3. 生成 `context.yaml` 文件（包含变量和数据库连接信息）
4. 遍历测试步骤，根据关键字类型生成对应的 YAML 配置
5. 如果是 `send_request` 关键字，自动关联接口信息
6. 调用执行器执行测试，生成 Allure 数据
7. 调用 `allure generate` 生成 HTML 报告
8. 返回报告路径，前端打开报告页面

---

#### 2.3 测试计划执行流程（异步）

```
用户操作          后端API            消息队列           消费者            执行引擎
   │                │                  │                 │                 │
   │ 1.执行计划     │                  │                 │                 │
   ├───────────────>│                  │                 │                 │
   │                │ 2.查询计划信息   │                 │                 │
   │                │ 3.查询关联用例   │                 │                 │
   │                │ 4.生成YAML文件   │                 │                 │
   │                │                  │                 │                 │
   │                │ 5.发送MQ消息     │                 │                 │
   │                ├─────────────────>│                 │                 │
   │                │                  │                 │                 │
   │                │ 6.更新Redis状态  │                 │                 │
   │                │   status=等待中  │                 │                 │
   │                │                  │                 │                 │
   │<───────────────│ 7.返回"已加入队列"                 │                 │
   │                │                  │                 │                 │
   │                │                  │ 8.消费消息      │                 │
   │                │                  ├────────────────>│                 │
   │                │                  │                 │ 9.更新状态      │
   │                │                  │                 │   status=执行中 │
   │                │                  │                 │                 │
   │                │                  │                 │ 10.执行测试     │
   │                │                  │                 ├────────────────>│
   │                │                  │                 │                 │ 11.执行用例
   │                │                  │                 │<────────────────│
   │                │                  │                 │                 │
   │                │                  │                 │ 12.生成报告     │
   │                │                  │                 │ 13.保存历史记录 │
   │                │                  │                 │ 14.发送通知     │
   │                │                  │                 │ 15.更新状态     │
   │                │                  │                 │   status=完成   │
```

**实现逻辑**：
1. 前端调用 `/ApiCollectionInfo/excuteTest` 接口
2. 后端查询测试计划、关联用例、测试步骤、数据库配置
3. 为每个用例生成独立的 YAML 文件（支持 DDT 数据驱动）
4. 将执行任务发送到 RabbitMQ 消息队列
5. 在 Redis 中记录任务状态为"等待中"
6. 立即返回响应，告知用户任务已加入队列
7. 消费者线程从队列获取任务
8. 更新 Redis 状态为"执行中"
9. 调用执行器执行所有测试用例
10. 生成 Allure HTML 报告
11. 保存执行记录到历史表
12. 调用机器人 API 发送通知
13. 更新 Redis 状态为"执行完成"

---

### 3. 关键字驱动机制

#### 3.1 关键字结构

```yaml
# 测试用例 YAML 格式
desc: 用例名称
pre_script:
  - "前置Python脚本"
steps:
  - 步骤描述1:
      关键字: send_request
      method: POST
      url: http://example.com/api
      headers:
        Content-Type: application/json
      json:
        username: "{{username}}"
        password: "{{password}}"
  - 步骤描述2:
      关键字: db_query
      _数据库: mysql_conn
      sql: "SELECT * FROM users WHERE id = {{user_id}}"
post_script:
  - "后置Python脚本"
```

#### 3.2 关键字执行流程

```
1. 解析YAML文件
   │
   ▼
2. 加载context.yaml（变量、数据库配置）
   │
   ▼
3. 执行pre_script（前置脚本）
   │
   ▼
4. 遍历steps
   │
   ├──> 获取"关键字"字段值
   │
   ├──> 从关键字目录加载对应Python文件
   │
   ├──> 替换变量占位符 {{variable}}
   │
   ├──> 执行关键字函数
   │
   └──> 保存执行结果到上下文
   │
   ▼
5. 执行post_script（后置脚本）
   │
   ▼
6. 生成Allure测试数据
```

---

### 4. DDT 数据驱动实现

```
测试计划
   │
   └── 用例A (ddt_param_data)
         │
         ├── 第1组数据: {desc: "正常登录", username: "admin", password: "123456"}
         │
         ├── 第2组数据: {desc: "错误密码", username: "admin", password: "wrong"}
         │
         └── 第3组数据: {desc: "空用户名", username: "", password: "123456"}

执行时：
   │
   ├── 用例A[正常登录] → 执行 → 结果
   │
   ├── 用例A[错误密码] → 执行 → 结果
   │
   └── 用例A[空用户名] → 执行 → 结果
```

**实现逻辑**：
1. 在测试计划详情中为用例配置多组 DDT 数据
2. 生成 YAML 时将 DDT 数据写入 `ddts` 字段
3. 执行器遍历 `ddts` 数组，每组数据执行一次用例
4. 每次执行使用对应组的变量值替换占位符

---

### 5. 消息通知实现

```
执行完成
   │
   ▼
查询关联的机器人配置
   │
   ├── 企业微信机器人
   │     └── POST https://qyapi.weixin.qq.com/cgi-bin/webhook/send
   │
   ├── 钉钉机器人
   │     └── POST https://oapi.dingtalk.com/robot/send
   │
   └── 飞书机器人
         └── POST https://open.feishu.cn/open-apis/bot/v2/hook
```

**消息内容**：
- 测试计划名称
- 执行时间
- 用例总数
- 通过/失败/跳过数量
- 通过率
- 报告链接

---

### 6. 前后端交互规范

#### 6.1 请求流程

```
前端 Vue 组件
   │
   ├── 1. 调用 API 模块 (*.js)
   │      例: queryByPage(searchData)
   │
   ▼
axios 请求
   │
   ├── 2. 发送 HTTP 请求
   │      POST /ApiInfo/queryByPage
   │      Body: {page: 1, pageSize: 10, ...}
   │
   ▼
后端 FastAPI Controller
   │
   ├── 3. 接收请求，解析参数
   │
   ├── 4. 调用 Model 查询数据库
   │
   ├── 5. 组装响应数据
   │
   ▼
返回响应
   │
   ├── 6. 返回 JSON 响应
   │      {code: 200, msg: "成功", data: [...], total: 100}
   │
   ▼
前端处理
   │
   └── 7. 更新页面数据
```

#### 6.2 API 模块结构

```javascript
// 前端 API 模块示例 (ApiInfo.js)
import axios from '@/axios'

// 分页查询
export function queryByPage(data) {
  return axios.post('/ApiInfo/queryByPage', data)
}

// 新增
export function insertData(data) {
  return axios.post('/ApiInfo/insert', data)
}

// 修改
export function updateData(data) {
  return axios.put('/ApiInfo/update', data)
}

// 删除
export function deleteData(id) {
  return axios.delete('/ApiInfo/delete?id=' + id)
}

// 调试执行
export function doDebugRequest(data) {
  return axios.post('/ApiInfo/debug', data)
}
```

---

### 表关系说明

```
t_api_project (项目表)
    │
    ├── t_api_database (数据库配置表) [project_id]
    │
    ├── t_api_info (接口信息表) [project_id]
    │
    ├── t_api_info_case (测试用例表) [project_id]
    │       │
    │       └── t_api_info_step (测试步骤表) [api_case_info_id]
    │               │
    │               └── t_api_keyword (关键字表) [key_word_id]
    │                       │
    │                       └── t_api_operationtype (操作类型表) [operation_type_id]
    │
    └── t_api_collection_info (测试计划表) [project_id]
            │
            ├── t_api_collection_detail (计划详情表) [collection_info_id, api_case_info_id]
            │
            └── t_api_history (执行历史表) [collection_info_id]
```

---

## 八、XMind导入功能说明

### XMind文件结构约定

```
中心主题（项目/模块名称 - 忽略）
    │
    ├── 一级子主题（测试用例名称）
    │       │
    │       ├── 二级子主题（测试步骤描述）
    │       │       │
    │       │       ├── 三级子主题（步骤参数 key:value）
    │       │       └── 三级子主题（步骤参数 key:value）
    │       │
    │       └── 二级子主题（测试步骤描述）
    │
    └── 一级子主题（测试用例名称）
            │
            └── ...
```

### 导入示例

**XMind结构**：
```
登录模块测试
    ├── 正常登录测试
    │       ├── 发送登录请求
    │       │       ├── url: /api/login
    │       │       ├── method: POST
    │       │       └── username: admin
    │       └── 验证登录结果
    │               └── expected: success
    │
    └── 异常登录测试
            └── 发送错误密码请求
                    ├── url: /api/login
                    └── password: wrong
```

**导入结果**：
- 创建2个测试用例：`正常登录测试`、`异常登录测试`
- 每个用例包含对应的测试步骤和参数

### 支持的文件格式

- `.xmind` 文件（XMind 8及以上版本）
- 内部使用 `content.json` 格式解析

---

## 九、Jenkins CI/CD集成说明

### 获取Jenkins配置

调用 `GET /ApiCollectionInfo/getJenkinsConfig?id={plan_id}` 获取配置信息。

### 返回内容

```json
{
  "plan_id": 1,
  "plan_name": "登录模块测试计划",
  "case_count": 10,
  "api_endpoint": "/api/ApiInfoCase/executeCase",
  "request_method": "POST",
  "request_body": {
    "plan_id": 1,
    "executor_code": "api-engine"
  },
  "curl_command": "curl -X POST ...",
  "pipeline_script": "pipeline { ... }"
}
```

### Jenkins Pipeline示例

```groovy
pipeline {
    agent any
    environment {
        BASE_URL = 'http://your-server:5000'
        TOKEN = credentials('api-test-token')
    }
    stages {
        stage('Execute Test Plan') {
            steps {
                script {
                    def response = httpRequest(
                        url: "${BASE_URL}/api/ApiInfoCase/executeCase",
                        httpMode: 'POST',
                        contentType: 'APPLICATION_JSON',
                        customHeaders: [[name: 'Authorization', value: "Bearer ${TOKEN}"]],
                        requestBody: '{"plan_id": 1}'
                    )
                    echo "Response: ${response.content}"
                }
            }
        }
    }
}
```

---

## 十、版本更新记录

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | 2024-01-01 | 初始版本，包含70个功能需求 |
| v1.1 | 2024-12-16 | 新增XMind导入、测试计划复制、Jenkins配置功能 |
| v1.1 | 2024-12-16 | 完善API接口清单、技术栈说明 |
| v1.1 | 2024-12-16 | 更新后端框架为FastAPI + SQLModel |
