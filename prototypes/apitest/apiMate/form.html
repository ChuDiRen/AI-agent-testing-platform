<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../common.css">
    <title>素材上传 - 静态原型</title>
</head>

<body class="proto-container">
    <div class="proto-header">
        <h1 class="proto-title" id="formTitle">上传素材</h1>
        <div style="display: flex; gap: 12px;">
            <button class="proto-btn proto-btn-secondary" onclick="window.location.href='index.html'">取消</button>
            <button class="proto-btn proto-btn-primary" id="saveBtn">上传</button>
        </div>
    </div>

    <div class="proto-card">
        <form id="mateForm">
            <input type="hidden" id="mate_id">

            <div class="proto-form-group">
                <label class="proto-label">所属项目</label>
                <select id="project_id" class="proto-select" required>
                    <option value="">请选择项目</option>
                </select>
            </div>

            <div class="proto-form-group">
                <label class="proto-label">文件名 (别名)</label>
                <input type="text" id="mate_name" class="proto-input" placeholder="请输入文件名">
            </div>

            <div class="proto-form-group"
                style="padding: 20px; border: 2px dashed #e2e8f0; border-radius: 8px; text-align: center;">
                <p style="color: #64748b; margin-bottom: 12px;">点击选择或拖拽文件到此处</p>
                <input type="file" id="file_input" style="display: block; margin: 0 auto;">
            </div>

        </form>
    </div>

    <script src="../proto-logic.js"></script>
    <script>
        const id = getUrlParam('id');
        const projects = ProtoService.list('Project');
        document.getElementById('project_id').innerHTML += projects.map(p => `<option value="${p.id}">${p.project_name}</option>`).join('');

        if (id) {
            document.getElementById('formTitle').innerText = '编辑素材';
            const data = ProtoService.get('ApiMate', id);
            if (data) {
                document.getElementById('mate_id').value = data.id;
                document.getElementById('mate_name').value = data.mate_name;
                document.getElementById('project_id').value = data.project_id || '';
                // File input cannot be pre-set for security reasons
            }
        }

        document.getElementById('file_input').onchange = (e) => {
            if (e.target.files[0]) {
                if (!document.getElementById('mate_name').value) {
                    document.getElementById('mate_name').value = e.target.files[0].name;
                }
            }
        }

        document.getElementById('saveBtn').onclick = () => {
            const form = document.getElementById('mateForm');
            if (!form.checkValidity()) return form.reportValidity();

            const fileInput = document.getElementById('file_input');
            const file = fileInput.files[0];
            const fileSize = file ? (file.size / 1024).toFixed(1) + ' KB' : '0 KB';
            const fileType = file ? file.name.split('.').pop() : 'ukonwn';

            const payload = {
                id: document.getElementById('mate_id').value || undefined,
                mate_name: document.getElementById('mate_name').value,
                project_id: document.getElementById('project_id').value,
                size: fileSize,
                file_type: fileType,
                object_url: file ? `/uploads/${file.name}` : '',
                create_time: new Date().toISOString().split('T')[0]
            };

            ProtoService.save('ApiMate', payload);
            ProtoUI.toast('保存成功');
            setTimeout(() => window.location.href = 'index.html', 1000);
        };
    </script>
</body>

</html>