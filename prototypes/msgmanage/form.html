<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../apitest/common.css">
    <title>机器人配置 - 静态原型</title>
</head>

<body class="proto-container">
    <div class="proto-header">
        <h1 class="proto-title" id="formTitle">添加机器人</h1>
        <div style="display: flex; gap: 12px;">
            <button class="proto-btn proto-btn-secondary" onclick="window.location.href='index.html'">取消</button>
            <button class="proto-btn proto-btn-primary" id="saveBtn">保存机器人</button>
        </div>
    </div>

    <div class="proto-card" style="max-width: 800px; margin: 0 auto;">
        <form id="robotForm">
            <input type="hidden" id="robot_id">

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px;">
                <div class="proto-form-group">
                    <label class="proto-label">机器人别名</label>
                    <input type="text" id="robot_name" class="proto-input" placeholder="请起一个好记的名字" required>
                </div>
                <div class="proto-form-group">
                    <label class="proto-label">机器人类型</label>
                    <select id="robot_type" class="proto-select">
                        <option value="1">企业微信</option>
                        <option value="2">钉钉</option>
                        <option value="3">飞书</option>
                    </select>
                </div>
            </div>

            <div class="proto-form-group">
                <label class="proto-label">Webhook URL</label>
                <input type="text" id="webhook_url" class="proto-input" placeholder="请输入机器人的 Webhook 地址" required>
            </div>

            <div class="proto-form-group">
                <label class="proto-label">安全参数 (关键词)</label>
                <input type="text" id="keywords" class="proto-input" placeholder="请输入通知时匹配的关键字">
            </div>

            <div class="proto-form-group">
                <label class="proto-label">消息模板</label>
                <textarea id="message_template" class="proto-textarea" rows="8"
                    placeholder="支持变量渲染，如：${status}、${report_url}"></textarea>
                <div style="display: flex; gap: 12px; margin-top: 12px;">
                    <button type="button" class="proto-btn"
                        style="height: 32px; font-size: 12px; border: 1px solid #e2e8f0;" onclick="useTemplate(1)">模板
                        1</button>
                    <button type="button" class="proto-btn"
                        style="height: 32px; font-size: 12px; border: 1px solid #e2e8f0;" onclick="useTemplate(2)">模板
                        2</button>
                </div>
            </div>
        </form>
    </div>

    <script src="../apitest/proto-logic.js"></script>
    <script>
        const id = getUrlParam('id');
        const form = document.getElementById('robotForm');

        if (id) {
            document.getElementById('formTitle').innerText = '编辑机器人';
            const data = ProtoService.get('Robot', id);
            if (data) {
                document.getElementById('robot_id').value = data.id;
                document.getElementById('robot_name').value = data.robot_name;
                document.getElementById('robot_type').value = data.robot_type;
                document.getElementById('webhook_url').value = data.webhook_url;
                document.getElementById('keywords').value = data.keywords || '';
                document.getElementById('message_template').value = data.message_template || '';
            }
        }

        document.getElementById('saveBtn').onclick = () => {
            if (!form.checkValidity()) return form.reportValidity();

            const payload = {
                id: document.getElementById('robot_id').value || undefined,
                robot_name: document.getElementById('robot_name').value,
                robot_type: parseInt(document.getElementById('robot_type').value),
                webhook_url: document.getElementById('webhook_url').value,
                keywords: document.getElementById('keywords').value,
                message_template: document.getElementById('message_template').value,
                is_enabled: 1
            };

            ProtoService.save('Robot', payload);
            ProtoUI.toast('保存成功');
            setTimeout(() => window.location.href = 'index.html', 1000);
        };

        function useTemplate(idx) {
            const tmpl1 = "本次测试结果为：${status}\n\n[查看报告](${report_url})\n\n[查看项目](${coll_name})";
            const tmpl2 = "测试结果通知：测试名称 ${coll_name} \n\n 测试结果 : ${status}\n\n[报告地址](${report_url})\n\n备注：点击报告地址可查看详细数据";
            document.getElementById('message_template').value = idx === 1 ? tmpl1 : tmpl2;
        }
    </script>
</body>

</html>